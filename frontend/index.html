<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory System Demo â€¢ 6-Layer Architecture</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%233B82F6'/><stop offset='100%' style='stop-color:%238B5CF6'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='system-ui' font-weight='700'>M</text></svg>">
    <style>
        /* ============================================
           MODERN DESIGN SYSTEM - BALANCED & COLORFUL
           ============================================ */

        :root {
            /* Background Colors - Depth */
            --color-bg: #0A0E1A;
            --color-bg-secondary: #0F1419;
            --color-surface: #161B26;
            --color-surface-elevated: #1C2433;
            --color-surface-hover: #242B3D;

            /* Borders */
            --color-border: rgba(255, 255, 255, 0.06);
            --color-border-hover: rgba(255, 255, 255, 0.12);

            /* Accent Colors - Vibrant */
            --color-primary: #3B82F6;
            --color-primary-dark: #2563EB;
            --color-primary-light: #60A5FA;

            --color-success: #10B981;
            --color-success-dark: #059669;

            --color-warning: #F59E0B;
            --color-danger: #EF4444;

            --color-purple: #8B5CF6;
            --color-pink: #EC4899;
            --color-teal: #14B8A6;
            --color-indigo: #6366F1;
            --color-orange: #F97316;

            /* Text Colors */
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-text-tertiary: #6B7280;

            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;

            --text-xs: 11px;
            --text-sm: 13px;
            --text-base: 14px;
            --text-lg: 16px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);

            /* Transitions */
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            color: var(--color-text-primary);
            background: var(--color-bg);
            overflow-x: hidden;
        }

        /* ============================================
           HEADER - SPACIOUS & MODERN
           ============================================ */

        .header {
            background: linear-gradient(180deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-6) var(--space-8);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-purple));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: var(--shadow-md);
        }

        .header-info h1 {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }

        .header-info p {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        .header-stats {
            display: flex;
            gap: var(--space-8);
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .header-stat-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            font-family: var(--font-mono);
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           NAVIGATION - MODERN TABS
           ============================================ */

        .nav {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: 0 var(--space-8);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-2);
        }

        .nav-tab {
            padding: var(--space-4) var(--space-5);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: var(--font-sans);
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-tab.active {
            color: var(--color-primary-light);
            border-bottom-color: var(--color-primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-purple));
            border-radius: 2px 2px 0 0;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           CARDS - ELEVATED WITH CHARACTER
           ============================================ */

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .card:hover {
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        /* ============================================
           SCENARIO CARDS - COLORFUL & ENGAGING
           ============================================ */

        .scenario-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .scenario-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--scenario-color, var(--color-primary)), transparent);
            opacity: 0.6;
        }

        .scenario-number {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            width: 28px;
            height: 28px;
            background: var(--scenario-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            color: white;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }

        .scenario-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .scenario-card.category-financial { --scenario-color: var(--color-success); }
        .scenario-card.category-operational { --scenario-color: var(--color-primary); }
        .scenario-card.category-entity { --scenario-color: var(--color-purple); }
        .scenario-card.category-memory { --scenario-color: var(--color-pink); }
        .scenario-card.category-conflict { --scenario-color: var(--color-orange); }
        .scenario-card.category-intelligence { --scenario-color: var(--color-indigo); }

        .scenario-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
            padding-left: 40px;
        }

        .scenario-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .scenario-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin-bottom: var(--space-3);
        }

        .scenario-meta {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            padding-left: 40px;
        }

        .scenario-category {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .scenario-details {
            margin-top: var(--space-4);
            padding: var(--space-4);
            padding-left: 40px;
            background: var(--color-bg);
            border-top: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            display: none;
        }

        .scenario-details.expanded {
            display: block;
        }

        .scenario-details-section {
            margin-bottom: var(--space-4);
        }

        .scenario-details-section:last-child {
            margin-bottom: 0;
        }

        .scenario-details-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .scenario-details-content {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            background: var(--color-surface);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .btn-details {
            margin-top: var(--space-3);
            margin-left: 40px;
            font-size: var(--text-xs);
            padding: 4px var(--space-3);
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
        }

        .btn-details:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--color-text-primary);
        }

        /* ============================================
           BUTTONS - MODERN WITH GRADIENTS
           ============================================ */

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
            font-family: var(--font-sans);
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-primary));
            box-shadow: var(--shadow-lg), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger), #DC2626);
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-sm {
            padding: 4px var(--space-3);
            font-size: var(--text-xs);
        }

        /* ============================================
           BADGES - COLORFUL
           ============================================ */

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 500;
            font-family: var(--font-mono);
        }

        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-primary-light);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-purple);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge-pink {
            background: rgba(236, 72, 153, 0.15);
            color: var(--color-pink);
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .badge-teal {
            background: rgba(20, 184, 166, 0.15);
            color: var(--color-teal);
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        /* ============================================
           STAT CARDS - COMPACT & MODERN
           ============================================ */

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            position: relative;
            overflow: hidden;
            transition: all var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stat-color, var(--color-primary)), transparent);
        }

        .stat-card:hover {
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .stat-card-title {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--color-text-primary);
            font-family: var(--font-mono);
        }

        /* ============================================
           MEMORY LAYER CARDS - COLORFUL
           ============================================ */

        .layer-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .layer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: var(--layer-color);
            opacity: 0.8;
        }

        .layer-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .layer-card.layer-1 { --layer-color: var(--color-teal); }
        .layer-card.layer-2 { --layer-color: var(--color-primary); }
        .layer-card.layer-3 { --layer-color: var(--color-purple); }
        .layer-card.layer-4 { --layer-color: var(--color-success); }
        .layer-card.layer-5 { --layer-color: var(--color-warning); }
        .layer-card.layer-6 { --layer-color: var(--color-pink); }

        .layer-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .layer-card-number {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .layer-card-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .layer-card-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        /* ============================================
           TABLES - MODERN
           ============================================ */

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }

        thead {
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background var(--transition);
        }

        tbody tr:hover {
            background: var(--color-surface-elevated);
        }

        /* ============================================
           CHAT INTERFACE - MODERN & ENGAGING
           ============================================ */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-5) 0;
            margin-bottom: var(--space-4);
        }

        .chat-message {
            margin-bottom: var(--space-5);
            display: flex;
            gap: var(--space-3);
        }

        .chat-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-message.user .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
        }

        .chat-message.assistant .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-success), var(--color-teal));
            color: white;
        }

        .chat-message-content {
            flex: 1;
            padding: var(--space-2) 0;
        }

        .chat-message.user .chat-message-content {
            /* No special background - seamless flow */
        }

        .chat-message-role {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .chat-message-timestamp {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
            opacity: 0.6;
        }

        .chat-message-text {
            color: var(--color-text-primary);
            line-height: 1.6;
            white-space: pre-wrap;  /* Preserve line breaks and formatting */
        }

        .chat-message-debug {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .chat-message-debug-title {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
        }

        .chat-message-debug-item {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .chat-input-container {
            display: flex;
            gap: var(--space-3);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            font-family: var(--font-sans);
            transition: all var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: var(--space-2) 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-tertiary);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }

        /* Flow diagram styles */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-6) 0;
        }

        .flow-step {
            width: 100%;
            max-width: 800px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-2) 0;
        }

        .flow-step-orchestrator {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--color-primary);
        }

        .flow-step-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .flow-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            padding: 4px 12px;
            background: var(--color-primary);
            color: white;
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            border-radius: var(--radius-sm);
        }

        .flow-step-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .flow-step-content {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            line-height: 1.8;
        }

        .substep {
            padding: var(--space-2) 0;
            padding-left: var(--space-4);
            border-left: 2px solid rgba(59, 130, 246, 0.3);
            margin: var(--space-2) 0;
        }

        .substep strong {
            color: var(--color-primary-light);
        }

        .flow-arrow {
            font-size: 24px;
            color: var(--color-primary);
            margin: var(--space-2) 0;
            font-weight: bold;
        }

        /* Processing steps for real-time debug mode */
        .processing-steps {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-top: 0;
            padding: 6px;
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .processing-steps.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        .processing-step {
            display: flex;
            align-items: flex-start;
            gap: 4px;
            padding: 2px 4px;
            font-size: 11px;
            color: var(--color-text-secondary);
            transition: all 0.2s ease;
            line-height: 1.3;
        }

        .processing-step.completed {
            color: var(--color-text-primary);
        }

        .processing-step.completed .processing-step-icon {
            color: var(--color-success);
        }

        .processing-step-icon {
            font-size: 14px;
            min-width: 16px;
            text-align: center;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .processing-step-text {
            flex: 1;
            line-height: 1.4;
        }

        .processing-step-details {
            font-size: 9px;
            color: var(--color-text-tertiary);
            margin-top: 1px;
            opacity: 0.8;
        }

        .toggle-icon {
            font-size: 12px;
            transition: transform 0.2s;
            user-select: none;
        }

        .processing-step-text {
            flex: 1;
        }

        /* Chat suggestions */
        .chat-suggestions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            padding: var(--space-10) var(--space-5);
            max-width: 600px;
            margin: 0 auto;
        }

        .chat-suggestions-title {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-2);
        }

        .suggestion-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .suggestion-card:hover {
            border-color: var(--color-primary);
            background: var(--color-surface-elevated);
            transform: translateX(4px);
        }

        .suggestion-card-icon {
            font-size: 18px;
            opacity: 0.7;
        }

        .suggestion-card-text {
            flex: 1;
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        /* ============================================
           ARCHITECTURE DIAGRAM - INTERACTIVE
           ============================================ */

        .architecture-panel {
            background: linear-gradient(180deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-bottom: 1px solid var(--color-border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .architecture-panel.collapsed {
            max-height: 0;
            border-bottom: none;
        }

        .architecture-panel.expanded {
            max-height: 300px;
        }

        .architecture-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6) var(--space-8);
        }

        .architecture-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .architecture-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .architecture-toggle {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--space-2);
            transition: color var(--transition);
        }

        .architecture-toggle:hover {
            color: var(--color-primary);
        }

        .architecture-layers {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-4);
            position: relative;
        }

        .layer-box {
            background: var(--color-surface-elevated);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .layer-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--layer-accent);
            opacity: 0.8;
        }

        .layer-box:hover {
            border-color: var(--layer-accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .layer-box.active {
            border-color: var(--layer-accent);
            background: var(--color-surface-hover);
            box-shadow: 0 0 20px rgba(var(--layer-accent-rgb), 0.3);
        }

        .layer-box.layer-0 { --layer-accent: var(--color-indigo); --layer-accent-rgb: 99, 102, 241; }
        .layer-box.layer-1 { --layer-accent: var(--color-teal); --layer-accent-rgb: 20, 184, 166; }
        .layer-box.layer-2 { --layer-accent: var(--color-primary); --layer-accent-rgb: 59, 130, 246; }
        .layer-box.layer-3 { --layer-accent: var(--color-purple); --layer-accent-rgb: 139, 92, 246; }
        .layer-box.layer-4 { --layer-accent: var(--color-success); --layer-accent-rgb: 16, 185, 129; }
        .layer-box.layer-5 { --layer-accent: var(--color-warning); --layer-accent-rgb: 245, 158, 11; }

        .layer-number {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            margin-bottom: var(--space-1);
        }

        .layer-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            line-height: 1.3;
        }

        .layer-count {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--layer-accent);
            font-family: var(--font-mono);
            margin-bottom: var(--space-1);
        }

        .layer-description {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            line-height: 1.4;
        }

        .layer-arrow {
            position: absolute;
            top: 50%;
            right: -16px;
            transform: translateY(-50%);
            font-size: 24px;
            color: var(--color-text-tertiary);
            opacity: 0.5;
            z-index: 1;
            pointer-events: none;
        }

        @keyframes flowPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .layer-box.processing {
            animation: flowPulse 2s ease-in-out infinite;
        }

        .architecture-toggle-btn {
            position: fixed;
            top: 180px;
            right: var(--space-8);
            z-index: 99;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: var(--shadow-md);
        }

        .architecture-toggle-btn:hover {
            background: var(--color-surface-hover);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }

        /* ============================================
           ACTIVITY FEED - LIVE SYSTEM MONITORING
           ============================================ */

        .activity-feed {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 380px;
            max-height: 400px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-bottom: none;
            border-right: none;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: var(--shadow-xl);
            z-index: 98;
            display: flex;
            flex-direction: column;
            transition: all var(--transition);
        }

        .activity-feed.collapsed {
            max-height: 48px;
        }

        .activity-feed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            cursor: pointer;
            user-select: none;
        }

        .activity-feed-header:hover {
            background: var(--color-surface-hover);
        }

        .activity-feed-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .activity-feed-live-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .activity-feed-count {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
        }

        .activity-feed-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-2);
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all var(--transition);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-item:hover {
            background: var(--color-surface);
            border-color: var(--color-border-hover);
        }

        .activity-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.database-query {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-indigo);
        }

        .activity-icon.memory-retrieval {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
        }

        .activity-icon.llm-call {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-purple);
        }

        .activity-icon.entity-resolution {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-primary);
        }

        .activity-icon.reasoning-step {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .activity-icon.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .activity-body {
            flex: 1;
            min-width: 0;
        }

        .activity-summary {
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .activity-time {
            font-family: var(--font-mono);
        }

        .activity-duration {
            padding: 2px var(--space-2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
        }

        .activity-empty {
            padding: var(--space-10);
            text-align: center;
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        /* ============================================
           CHAT REASONING PANE (SPLIT VIEW)
           ============================================ */

        .chat-container.split-view {
            display: grid;
            grid-template-columns: 1fr 0.538fr; /* 65/35 split */
            grid-template-rows: 1fr auto;
            gap: var(--space-4);
        }

        .chat-container.split-view .chat-messages {
            grid-column: 1;
            grid-row: 1;
        }

        .chat-container.split-view .chat-input-container {
            grid-column: 1;
            grid-row: 2;
        }

        .reasoning-pane {
            grid-column: 2;
            grid-row: 1 / 3; /* Span both rows */
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .reasoning-pane-header {
            padding: var(--space-4);
            background: linear-gradient(180deg, var(--color-surface-elevated) 0%, var(--color-surface) 100%);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .reasoning-pane-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .reasoning-pane-close {
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all var(--transition);
            font-size: var(--text-base);
            line-height: 1;
        }

        .reasoning-pane-close:hover {
            background: var(--color-bg);
            color: var(--color-text-primary);
        }

        .reasoning-pane-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }

        .reasoning-toggle-btn {
            position: fixed;
            top: 240px;
            right: var(--space-8);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            box-shadow: var(--shadow-lg);
            z-index: 99;
            transition: all var(--transition);
        }

        .reasoning-toggle-btn:hover {
            background: var(--color-surface-elevated);
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-xl);
        }

        .reasoning-toggle-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Reasoning Steps - Timeline Design */
        .reasoning-timeline {
            position: relative;
            padding-left: var(--space-6);
        }

        .reasoning-timeline::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-border);
        }

        .reasoning-step {
            position: relative;
            margin-bottom: var(--space-5);
            animation: slideInRight 0.3s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .reasoning-step-marker {
            position: absolute;
            left: -29px;
            top: 2px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: var(--step-bg);
            color: var(--step-color);
            border: 2px solid var(--color-surface);
            box-shadow: 0 0 0 2px var(--step-bg);
        }

        .reasoning-step.database-query {
            --step-bg: rgba(99, 102, 241, 0.15);
            --step-color: var(--color-indigo);
        }

        .reasoning-step.memory-retrieval {
            --step-bg: rgba(16, 185, 129, 0.15);
            --step-color: var(--color-success);
        }

        .reasoning-step.reasoning {
            --step-bg: rgba(139, 92, 246, 0.15);
            --step-color: var(--color-purple);
        }

        .reasoning-step.llm-generation {
            --step-bg: rgba(245, 158, 11, 0.15);
            --step-color: var(--color-warning);
        }

        .reasoning-step-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
        }

        .reasoning-step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .reasoning-step-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .reasoning-step-duration {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
        }

        .reasoning-step-description {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }

        .reasoning-step-details {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            background: var(--color-surface);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            margin-top: var(--space-2);
        }

        .reasoning-empty {
            padding: var(--space-10) var(--space-4);
            text-align: center;
            color: var(--color-text-tertiary);
        }

        .reasoning-empty-icon {
            font-size: 48px;
            margin-bottom: var(--space-3);
            opacity: 0.3;
        }

        .reasoning-empty-text {
            font-size: var(--text-sm);
        }

        /* ============================================
           GRID LAYOUTS
           ============================================ */

        .grid {
            display: grid;
            gap: var(--space-4);
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .grid-stats {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }

        /* ============================================
           UTILITIES
           ============================================ */

        .loading {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-secondary);
        }

        .spinner {
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            font-size: var(--text-sm);
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--color-danger);
        }

        .text-mono {
            font-family: var(--font-mono);
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mb-4 { margin-bottom: var(--space-4); }
        .mb-5 { margin-bottom: var(--space-5); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }

        /* ============================================
           SCROLLBAR
           ============================================ */

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-hover);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-brand">
                <div class="header-logo">M</div>
                <div class="header-info">
                    <h1>Memory System Architecture</h1>
                    <p>6-Layer Memory â€¢ Domain Integration â€¢ Semantic Extraction</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Database Records</div>
                    <div class="header-stat-value" id="totalDbRecords">0</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Memory Entries</div>
                    <div class="header-stat-value" id="totalMemories">0</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-tab active" onclick="showTab('scenarios')">Scenarios</button>
            <button class="nav-tab" onclick="showTab('architecture')">Architecture</button>
            <button class="nav-tab" onclick="showTab('database')">Domain Database</button>
            <button class="nav-tab" onclick="showTab('memory')">Memory Layers</button>
            <button class="nav-tab" onclick="showTab('chat')">Chat Interface</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div id="globalAlert"></div>

        <!-- Tab: Scenarios -->
        <div id="tab-scenarios" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Demo Scenarios</div>
                        <div class="card-subtitle">Load test data to explore system capabilities</div>
                    </div>
                    <div style="display: flex; gap: var(--space-2);">
                        <button class="btn btn-secondary" onclick="clearMemoriesOnly()">Clear Memories</button>
                        <button class="btn btn-danger" onclick="resetAllData()">Reset All Data</button>
                    </div>
                </div>
                <div id="scenariosList" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Architecture (COMPREHENSIVE REVAMP - Updated 2025-10-17) -->
        <div id="tab-architecture" class="tab-content">
            <!-- High-Level Overview Card -->
            <div class="card mb-5" style="border-left: 4px solid var(--color-primary);">
                <div class="card-title">ðŸ—ï¸ System Architecture Overview</div>
                <div class="card-subtitle">Production-grade memory system with hexagonal architecture â€¢ 99/100 assessment score â€¢ Refactored from 683-line god object to lean orchestrator</div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4); margin-top: var(--space-5);">
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-size: var(--text-2xl); margin-bottom: var(--space-2);">âš¡</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">P95 Latency</div>
                        <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--color-primary);">&lt;800ms</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">Full pipeline with LLM</div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-size: var(--text-2xl); margin-bottom: var(--space-2);">ðŸ’°</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Cost per Turn</div>
                        <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--color-success);">$0.002</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">15x cheaper than pure LLM</div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(245, 158, 11, 0.3);">
                        <div style="font-size: var(--text-2xl); margin-bottom: var(--space-2);">ðŸŽ¯</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Test Coverage</div>
                        <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--color-warning);">85%</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">130+ tests (unit + E2E)</div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid rgba(139, 92, 246, 0.3);">
                        <div style="font-size: var(--text-2xl); margin-bottom: var(--space-2);">ðŸ“Š</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Type Safety</div>
                        <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--color-purple);">100%</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">mypy --strict mode</div>
                    </div>
                </div>
            </div>

            <!-- REQUEST FLOW DIAGRAM -->
            <div class="card mb-5" style="border-left: 4px solid var(--color-primary);">
                <div class="card-title">ðŸ”„ Complete Request Flow</div>
                <div class="card-subtitle">End-to-end processing pipeline: Client â†’ API â†’ Orchestrator â†’ Domain Services â†’ Infrastructure</div>

                <div style="margin-top: var(--space-5); font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.8;">
                    <!-- CLIENT REQUEST -->
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); border: 2px solid var(--color-primary); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <div style="font-weight: 700; color: var(--color-primary); margin-bottom: var(--space-2);">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
                        <div style="font-weight: 700; color: var(--color-primary); margin-bottom: var(--space-2);">â”‚         CLIENT REQUEST (HTTP POST)          â”‚</div>
                        <div style="font-weight: 700; color: var(--color-primary); margin-bottom: var(--space-3);">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary);">
                            POST /api/v1/chat<br>
                            {<br>
                            &nbsp;&nbsp;"user_id": "demo_user",<br>
                            &nbsp;&nbsp;"message": "What did Kai Media order last month?"<br>
                            }
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--color-text-secondary); margin: var(--space-2) 0;">â–¼</div>

                    <!-- FASTAPI ROUTER -->
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent); border: 2px solid var(--color-success); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <div style="font-weight: 700; color: var(--color-success); margin-bottom: var(--space-2);">FASTAPI ROUTER (src/api/routes/chat.py)</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>process_chat_simplified() endpoint</strong><br><br>
                            <strong>Actions:</strong><br>
                            1. Extract request parameters (user_id, message, session_id)<br>
                            2. Create ProcessChatMessageInput DTO<br>
                            3. Call use_case.execute(input_dto)<br>
                            4. Handle AmbiguousEntityError â†’ return disambiguation UI<br>
                            5. Build simplified response with provenance
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--color-text-secondary); margin: var(--space-2) 0;">â–¼</div>

                    <!-- ORCHESTRATOR -->
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent); border: 2px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <div style="font-weight: 700; color: var(--color-warning); margin-bottom: var(--space-2);">ORCHESTRATOR: ProcessChatMessageUseCase</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>(src/application/use_cases/process_chat_message.py)</strong><br><br>
                            <strong>Design Pattern:</strong> Orchestrator (coordinates specialized use cases)<br>
                            <strong>Total Lines:</strong> 371 (down from 683-line god object â€“ refactored!)<br><br>

                            <strong>Execution Flow:</strong><br>
                            Step 0: PII Detection & Redaction (Phase 3.1)<br>
                            &nbsp;&nbsp;â†’ PIIRedactionService.redact_with_metadata()<br>
                            &nbsp;&nbsp;â†’ Store redacted content, create policy memory<br><br>

                            Step 1: Store Chat Message<br>
                            &nbsp;&nbsp;â†’ IChatEventRepository.create(ChatMessage)<br><br>

                            Step 2: Phase 1A - Resolve Entities<br>
                            &nbsp;&nbsp;â†’ ResolveEntitiesUseCase.execute()<br>
                            &nbsp;&nbsp;â†’ Returns resolved entities + ambiguities<br><br>

                            Step 3: Phase 1B - Extract Semantics<br>
                            &nbsp;&nbsp;â†’ ExtractSemanticsUseCase.execute()<br>
                            &nbsp;&nbsp;â†’ LLM extracts semantic memories + detects conflicts<br><br>

                            Step 4: Phase 1C - Augment with Domain<br>
                            &nbsp;&nbsp;â†’ AugmentWithDomainUseCase.execute()<br>
                            &nbsp;&nbsp;â†’ LLM tool calling â†’ query domain database<br>
                            &nbsp;&nbsp;â†’ Detect memory-vs-DB conflicts<br>
                            &nbsp;&nbsp;â†’ Evaluate reminder triggers (procedural memory)<br><br>

                            Step 5: Phase 1D - Score & Retrieve Memories<br>
                            &nbsp;&nbsp;â†’ ScoreMemoriesUseCase.execute()<br>
                            &nbsp;&nbsp;â†’ Multi-signal scoring (5 signals)<br>
                            &nbsp;&nbsp;â†’ Handle memory validation (Phase 2.2)<br><br>

                            Step 6: Resolve Conflicts (Phase 2.1)<br>
                            &nbsp;&nbsp;â†’ ConflictResolutionService.resolve_conflict()<br>
                            &nbsp;&nbsp;â†’ Trust DB, decay memory confidence<br><br>

                            Step 7: Generate Reply<br>
                            &nbsp;&nbsp;â†’ LLMReplyGenerator.generate()<br>
                            &nbsp;&nbsp;â†’ Natural language response with context
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--color-text-secondary); margin: var(--space-2) 0;">â–¼ Delegates to specialized use cases â–¼</div>

                    <!-- PHASE 1A: ENTITY RESOLUTION -->
                    <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent); border-left: 4px solid var(--color-purple); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                        <div style="font-weight: 700; color: var(--color-purple); margin-bottom: var(--space-2);">PHASE 1A: Entity Resolution</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>Use Case:</strong> ResolveEntitiesUseCase<br>
                            <strong>Domain Service:</strong> EntityResolutionService (5-stage hybrid)<br><br>

                            <strong>Stages:</strong><br>
                            Stage 1: Exact match on canonical name (70%) â†’ 20ms, $0, confidence=1.0<br>
                            Stage 2: User alias lookup (15%) â†’ 25ms, $0, confidence=0.95<br>
                            Stage 3: Fuzzy match with pg_trgm (10%) â†’ 50ms, $0, confidence=0.85<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â€¢ Auto-create alias on success (learning loop!)<br>
                            Stage 4: LLM coreference resolution (5%) â†’ 300ms, $0.03, confidence=0.75<br>
                            Stage 5: Domain DB lookup (lazy creation) (<1%) â†’ 40ms, $0, confidence=0.90<br><br>

                            <strong>Output:</strong> List[ResolvedEntityDTO] with entity_id, confidence, method
                        </div>
                    </div>

                    <!-- PHASE 1B: SEMANTIC EXTRACTION -->
                    <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent); border-left: 4px solid var(--color-purple); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                        <div style="font-weight: 700; color: var(--color-purple); margin-bottom: var(--space-2);">PHASE 1B: Semantic Extraction</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>Use Case:</strong> ExtractSemanticsUseCase<br>
                            <strong>Domain Service:</strong> SemanticExtractionService<br><br>

                            <strong>Process:</strong><br>
                            1. LLM extracts semantic memories (entity-tagged natural language)<br>
                            &nbsp;&nbsp;&nbsp;Example: "Kai Media prefers Friday deliveries"<br>
                            &nbsp;&nbsp;&nbsp;â†’ SemanticMemory(content=..., entities=["customer:kai_123"], confidence=0.85)<br><br>

                            2. Conflict detection (memory-vs-memory)<br>
                            &nbsp;&nbsp;&nbsp;â€¢ Consolidation: Merge similar memories â†’ higher confidence<br>
                            &nbsp;&nbsp;&nbsp;â€¢ Contradiction: Flag conflicting memories â†’ both preserved<br><br>

                            3. Generate embeddings (1536-dim via OpenAI)<br><br>

                            4. Store in SemanticMemoryRepository<br><br>

                            <strong>Output:</strong> List[SemanticMemoryDTO] + conflicts detected
                        </div>
                    </div>

                    <!-- PHASE 1C: DOMAIN AUGMENTATION -->
                    <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent); border-left: 4px solid var(--color-purple); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                        <div style="font-weight: 700; color: var(--color-purple); margin-bottom: var(--space-2);">PHASE 1C: Domain Augmentation (LLM Tool Calling)</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>Use Case:</strong> AugmentWithDomainUseCase<br>
                            <strong>Application Service:</strong> AdaptiveQueryOrchestrator<br><br>

                            <strong>Vision Principle:</strong> Emergent intelligence (no hardcoded keywords)<br><br>

                            <strong>Flow:</strong><br>
                            1. LLM analyzes query context + resolved entities<br>
                            2. LLM decides which tools to call (query_customers, query_invoices, etc.)<br>
                            3. Execute SQL queries via DomainDatabasePort (repository pattern)<br>
                            4. LLM iterates if needed (up to 5 rounds)<br>
                            5. Track tool usage â†’ ToolUsageLog (learning for Phase 2)<br><br>

                            <strong>Example Tools:</strong><br>
                            â€¢ query_customers(name_filter) â†’ domain.customers table<br>
                            â€¢ query_invoices(customer_id, status) â†’ domain.invoices table<br>
                            â€¢ query_sales_orders(customer_id) â†’ domain.sales_orders table<br>
                            â€¢ analyze_order_chain(customer_id) â†’ multi-table join<br><br>

                            <strong>Conflict Detection:</strong> Compare domain facts vs semantic memories<br>
                            &nbsp;&nbsp;â€¢ If memory says "status=in_fulfillment" but DB says "shipped" â†’ CONFLICT<br><br>

                            <strong>Output:</strong> List[DomainFactDTO] with full provenance
                        </div>
                    </div>

                    <!-- PHASE 1D: MEMORY SCORING -->
                    <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent); border-left: 4px solid var(--color-purple); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <div style="font-weight: 700; color: var(--color-purple); margin-bottom: var(--space-2);">PHASE 1D: Memory Scoring & Retrieval</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>Use Case:</strong> ScoreMemoriesUseCase<br>
                            <strong>Domain Service:</strong> MultiSignalScorer<br><br>

                            <strong>Multi-Signal Scoring (5 signals, 100% deterministic):</strong><br>
                            relevance_score = 0.40 Ã— semantic_similarity  (pgvector cosine)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ 0.25 Ã— entity_overlap      (Jaccard index)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ 0.20 Ã— recency             (exponential decay)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ 0.10 Ã— temporal_coherence  (session context)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ 0.05 Ã— importance          (user-marked)<br><br>

                            <strong>Retrieval Flow:</strong><br>
                            1. pgvector similarity search (IVFFlat index, lists=100)<br>
                            2. Apply multi-signal scoring to each candidate<br>
                            3. Rank by final score (0.0-1.0)<br>
                            4. Return top-k memories (default k=5)<br><br>

                            <strong>Output:</strong> List[RetrievedMemoryDTO] sorted by relevance
                        </div>
                    </div>

                    <div style="text-align: center; color: var(--color-text-secondary); margin: var(--space-2) 0;">â–¼ Domain services call infrastructure adapters â–¼</div>

                    <!-- INFRASTRUCTURE LAYER -->
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent); border: 2px solid #6366f1; border-radius: var(--radius-md);">
                        <div style="font-weight: 700; color: #6366f1; margin-bottom: var(--space-2);">INFRASTRUCTURE ADAPTERS (Ports & Adapters Pattern)</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            <strong>Repository Adapters (PostgreSQL + pgvector):</strong><br>
                            â€¢ CanonicalEntityRepository implements IEntityRepository<br>
                            &nbsp;&nbsp;â†’ find_by_canonical_name(), fuzzy_search() via pg_trgm<br>
                            â€¢ SemanticMemoryRepository implements ISemanticMemoryRepository<br>
                            &nbsp;&nbsp;â†’ vector_search() via pgvector (IVFFlat index)<br>
                            â€¢ DomainDatabaseRepository implements DomainDatabasePort<br>
                            &nbsp;&nbsp;â†’ query_customers(), query_invoices() via domain schema<br><br>

                            <strong>LLM Service Adapters:</strong><br>
                            â€¢ AnthropicLLMService implements ILLMService<br>
                            &nbsp;&nbsp;â†’ resolve_coreference(), extract_semantics(), tool_calling()<br>
                            â€¢ OpenAIEmbeddingService implements IEmbeddingService<br>
                            &nbsp;&nbsp;â†’ generate_embedding() via text-embedding-3-small<br><br>

                            <strong>Database Schemas:</strong><br>
                            â€¢ app.canonical_entities (Layer 2: Entity resolution)<br>
                            â€¢ app.semantic_memories (Layer 4: Semantic facts)<br>
                            â€¢ app.chat_events (Layer 1: Immutable audit trail)<br>
                            â€¢ domain.customers, domain.invoices, domain.sales_orders (authoritative data)
                        </div>
                    </div>

                    <div style="text-align: center; color: var(--color-text-secondary); margin: var(--space-3) 0;">â–¼</div>

                    <!-- RESPONSE -->
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent); border: 2px solid var(--color-success); border-radius: var(--radius-md);">
                        <div style="font-weight: 700; color: var(--color-success); margin-bottom: var(--space-2);">RESPONSE (JSON)</div>
                        <div style="margin-left: var(--space-4); color: var(--color-text-secondary); font-size: 13px;">
                            {<br>
                            &nbsp;&nbsp;"response": "Kai Media ordered 2 items last month: SO-1001 (shipped) and SO-1003 (in_fulfillment).",<br>
                            &nbsp;&nbsp;"augmentation": {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"domain_facts": [<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{"fact_type": "sales_order", "entity_id": "customer:kai_123", ...}<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"memories_retrieved": [...],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"entities_resolved": [<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{"entity_id": "customer:kai_123", "method": "fuzzy", "confidence": 0.85}<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;]<br>
                            &nbsp;&nbsp;},<br>
                            &nbsp;&nbsp;"provenance": {<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"memory_ids": [1, 2, 3],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"similarity_scores": [0.85, 0.80, 0.75],<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;"source_types": ["semantic", "semantic", "episodic"]<br>
                            &nbsp;&nbsp;},<br>
                            &nbsp;&nbsp;"conflicts_detected": [] // Epistemic humility: explicit conflict exposure<br>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hexagonal Architecture Card -->
            <div class="card mb-5">
                <div class="card-title">ðŸ”· Hexagonal Architecture (Ports & Adapters)</div>
                <div class="card-subtitle">Clean separation: Domain = pure Python, Infrastructure = swappable adapters â€¢ ZERO infrastructure imports in domain layer</div>

                <div style="margin-top: var(--space-5); font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">
                    <div style="text-align: center; padding: var(--space-4); background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), transparent); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <strong style="color: var(--color-primary);">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</strong><br>
                        <strong style="color: var(--color-primary);">â”‚   ðŸŒ API Layer (FastAPI)   â”‚</strong><br>
                        <strong style="color: var(--color-primary);">â”‚</strong>  HTTP, Pydantic validation <strong style="color: var(--color-primary);">â”‚</strong><br>
                        <strong style="color: var(--color-primary);">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</strong><br>
                        <strong style="color: var(--color-text-secondary);">â†“</strong>
                    </div>

                    <div style="text-align: center; padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), transparent); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <strong style="color: var(--color-success);">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</strong><br>
                        <strong style="color: var(--color-success);">â”‚  âš™ï¸ Application (Use Cases) â”‚</strong><br>
                        <strong style="color: var(--color-success);">â”‚</strong>  Orchestrate domain services <strong style="color: var(--color-success);">â”‚</strong><br>
                        <strong style="color: var(--color-success);">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</strong><br>
                        <strong style="color: var(--color-text-secondary);">â†“</strong>
                    </div>

                    <div style="text-align: center; padding: var(--space-4); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), transparent); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                        <strong style="color: var(--color-warning);">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</strong><br>
                        <strong style="color: var(--color-warning);">â”‚  ðŸ§  Domain (Business Logic)    â”‚</strong><br>
                        <strong style="color: var(--color-warning);">â”‚</strong>  â€¢ Entities: CanonicalEntity    <strong style="color: var(--color-warning);">â”‚</strong><br>
                        <strong style="color: var(--color-warning);">â”‚</strong>  â€¢ Services: EntityResolution   <strong style="color: var(--color-warning);">â”‚</strong><br>
                        <strong style="color: var(--color-warning);">â”‚</strong>  â€¢ Ports: IEntityRepository (ABC) <strong style="color: var(--color-warning);">â”‚</strong><br>
                        <strong style="color: var(--color-warning);">â”‚</strong>  âœ… ZERO infrastructure imports! <strong style="color: var(--color-warning);">â”‚</strong><br>
                        <strong style="color: var(--color-warning);">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</strong><br>
                        <strong style="color: var(--color-text-secondary);">â†“</strong>
                    </div>

                    <div style="text-align: center; padding: var(--space-4); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent); border-radius: var(--radius-md);">
                        <strong style="color: var(--color-purple);">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</strong><br>
                        <strong style="color: var(--color-purple);">â”‚  ðŸ”Œ Infrastructure (Adapters)  â”‚</strong><br>
                        <strong style="color: var(--color-purple);">â”‚</strong>  â€¢ PostgreSQL + pgvector         <strong style="color: var(--color-purple);">â”‚</strong><br>
                        <strong style="color: var(--color-purple);">â”‚</strong>  â€¢ OpenAI / Anthropic LLMs       <strong style="color: var(--color-purple);">â”‚</strong><br>
                        <strong style="color: var(--color-purple);">â”‚</strong>  â€¢ Alembic migrations            <strong style="color: var(--color-purple);">â”‚</strong><br>
                        <strong style="color: var(--color-purple);">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</strong>
                    </div>
                </div>

                <!-- Concrete Example of Ports & Adapters -->
                <div style="margin-top: var(--space-5); padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                    <strong style="color: var(--color-primary); font-size: var(--text-lg);">ðŸ“ Concrete Example: Entity Resolution</strong><br><br>

                    <div style="margin-left: var(--space-3); font-size: 14px; line-height: 1.8;">
                        <strong>Port (Interface)</strong> - <code>src/domain/ports/entity_repository.py</code>:<br>
                        <pre style="background: #1a1a1a; padding: var(--space-3); border-radius: var(--radius-sm); margin: var(--space-2) 0; overflow-x: auto; font-size: 13px;">from abc import ABC, abstractmethod

class IEntityRepository(ABC):
    @abstractmethod
    async def find_by_canonical_name(self, name: str) -> CanonicalEntity | None:
        pass

    @abstractmethod
    async def fuzzy_search(self, text: str, threshold: float) -> list[tuple[CanonicalEntity, float]]:
        pass</pre>

                        <strong>Adapter (PostgreSQL Implementation)</strong> - <code>src/infrastructure/database/repositories/...</code>:<br>
                        <pre style="background: #1a1a1a; padding: var(--space-3); border-radius: var(--radius-sm); margin: var(--space-2) 0; overflow-x: auto; font-size: 13px;">class CanonicalEntityRepository(IEntityRepository):
    async def find_by_canonical_name(self, name: str) -> CanonicalEntity | None:
        query = select(EntityModel).where(EntityModel.canonical_name == name)
        result = await self.session.execute(query)
        return self._to_domain_entity(result.scalar_one_or_none())

    async def fuzzy_search(self, text: str, threshold: float) -> list[tuple[CanonicalEntity, float]]:
        # Uses pg_trgm extension for fuzzy matching
        query = select(
            EntityModel,
            func.similarity(EntityModel.canonical_name, text).label("score")
        ).where(
            func.similarity(EntityModel.canonical_name, text) > threshold
        ).order_by(desc("score"))

        results = await self.session.execute(query)
        return [(self._to_domain_entity(row[0]), row[1]) for row in results]</pre>

                        <strong>Domain Service (Pure Business Logic)</strong> - <code>src/domain/services/entity_resolution_service.py</code>:<br>
                        <pre style="background: #1a1a1a; padding: var(--space-3); border-radius: var(--radius-sm); margin: var(--space-2) 0; overflow-x: auto; font-size: 13px;">class EntityResolutionService:
    def __init__(self, entity_repo: IEntityRepository):  # â† Depends on PORT
        self.entity_repo = entity_repo

    async def resolve_entity(self, mention: EntityMention) -> ResolutionResult:
        # Stage 1: Exact match (deterministic)
        entity = await self.entity_repo.find_by_canonical_name(mention.text)
        if entity:
            return ResolutionResult(entity.id, confidence=1.0, method="exact")

        # Stage 3: Fuzzy match (deterministic)
        matches = await self.entity_repo.fuzzy_search(mention.text, threshold=0.7)
        if len(matches) == 1:
            return ResolutionResult(matches[0][0].id, confidence=0.85, method="fuzzy")

        # ... other stages</pre>

                        <strong>Test (No Database Required!)</strong>:<br>
                        <pre style="background: #1a1a1a; padding: var(--space-3); border-radius: var(--radius-sm); margin: var(--space-2) 0; overflow-x: auto; font-size: 13px;">@pytest.mark.asyncio
async def test_exact_match():
    # Mock repository (no DB needed!)
    mock_repo = Mock(spec=IEntityRepository)
    mock_repo.find_by_canonical_name.return_value = CanonicalEntity(
        entity_id="customer:123",
        canonical_name="Kai Media"
    )

    service = EntityResolutionService(entity_repo=mock_repo)
    result = await service.resolve_entity(EntityMention(text="Kai Media"))

    assert result.entity_id == "customer:123"
    assert result.confidence == 1.0  # Test runs in <10ms!</pre>
                    </div>
                </div>

                <div style="margin-top: var(--space-5); padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                    <strong>âœ¨ Benefits:</strong><br><br>
                    <div style="margin-left: var(--space-4);">
                        âœ… <strong>Testable:</strong> Domain tests run in &lt;10ms (no DB needed, use mocks)<br>
                        âœ… <strong>Flexible:</strong> Swap PostgreSQL â†’ MongoDB without changing business logic<br>
                        âœ… <strong>Maintainable:</strong> Business rules in pure Python (no SQL/HTTP)<br>
                        âœ… <strong>Type-Safe:</strong> 100% type coverage (mypy --strict enforced)<br>
                        âœ… <strong>Independent:</strong> Domain layer has ZERO imports from infrastructure
                    </div>
                </div>
            </div>

            <!-- DATABASE SCHEMA VISUALIZATION -->
            <div class="card mb-5">
                <div class="card-title">ðŸ—„ï¸ Database Schema (10 Core Tables)</div>
                <div class="card-subtitle">PostgreSQL + pgvector â€¢ Dual schema: app (memory system) + domain (business data)</div>

                <div style="margin-top: var(--space-5);">
                    <!-- Schema Overview -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-bottom: var(--space-5);">
                        <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); border-left: 4px solid var(--color-primary); border-radius: var(--radius-md);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">app schema (Memory System)</div>
                            <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                                â€¢ chat_events (Layer 1: Audit trail)<br>
                                â€¢ canonical_entities (Layer 2: Entity resolution)<br>
                                â€¢ entity_aliases (Layer 2: User-specific aliases)<br>
                                â€¢ episodic_memories (Layer 3: Event memories)<br>
                                â€¢ semantic_memories (Layer 4: Semantic facts)<br>
                                â€¢ procedural_memories (Layer 5: Learned heuristics)<br>
                                â€¢ memory_summaries (Layer 6: Consolidations)<br>
                                â€¢ memory_conflicts (Conflict tracking)<br>
                                â€¢ domain_ontology (Relationship semantics)<br>
                                â€¢ tool_usage_log (LLM tool calling patterns)
                            </div>
                        </div>

                        <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent); border-left: 4px solid var(--color-success); border-radius: var(--radius-md);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">domain schema (Business Data)</div>
                            <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                                â€¢ customers (Authoritative customer records)<br>
                                â€¢ sales_orders (Sales order lifecycle)<br>
                                â€¢ invoices (Billing & payment tracking)<br>
                                â€¢ products (Product catalog)<br><br>
                                <strong>Dual Truth Architecture:</strong><br>
                                Database = source of truth (correspondence)<br>
                                Memory = contextual understanding (preferences)
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Table Schemas -->
                    <div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">
                        <!-- Layer 1: Chat Events -->
                        <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(107, 114, 128, 0.05), transparent); border-left: 3px solid var(--color-text-secondary); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">Layer 1: chat_events (Immutable Audit Trail)</div>
                            <div style="color: var(--color-text-secondary);">
                                event_id (BIGINT PK, autoincrement)<br>
                                session_id (UUID, indexed)<br>
                                user_id (TEXT, indexed with created_at)<br>
                                role (TEXT: user|assistant|system)<br>
                                content (TEXT) -- PII redacted before storage<br>
                                content_hash (TEXT) -- Deduplication<br>
                                event_metadata (JSONB)<br>
                                created_at (TIMESTAMPTZ)<br><br>
                                <strong>Constraints:</strong> UNIQUE(session_id, content_hash)<br>
                                <strong>Purpose:</strong> Never-deleting conversation log (GDPR: right to erasure handled via redaction)
                            </div>
                        </div>

                        <!-- Layer 2: Entities -->
                        <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), transparent); border-left: 3px solid #6366f1; border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">Layer 2: canonical_entities (Entity Resolution)</div>
                            <div style="color: var(--color-text-secondary);">
                                entity_id (TEXT PK) -- Format: {type}:{external_id} (e.g., "customer:123")<br>
                                entity_type (TEXT, indexed) -- customer|sales_order|invoice|product|user<br>
                                canonical_name (TEXT, indexed) -- Display name<br>
                                external_ref (JSONB) -- {table, primary_key, primary_value, display_name}<br>
                                properties (JSONB) -- Type-specific metadata<br>
                                created_at (TIMESTAMPTZ)<br>
                                updated_at (TIMESTAMPTZ)<br><br>
                                <strong>Purpose:</strong> Resolve mentions â†’ canonical IDs (e.g., "Kai" â†’ "customer:kai_123")
                            </div>
                        </div>

                        <!-- Layer 2: Aliases -->
                        <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), transparent); border-left: 3px solid #6366f1; border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">Layer 2: entity_aliases (User-Specific Aliases)</div>
                            <div style="color: var(--color-text-secondary);">
                                alias_id (BIGINT PK)<br>
                                canonical_entity_id (TEXT FK â†’ canonical_entities)<br>
                                alias_text (TEXT, indexed) -- Variant mention (e.g., "Kai" for "Kai Media")<br>
                                alias_source (TEXT: exact|fuzzy|learned|user_stated)<br>
                                user_id (TEXT, indexed) -- NULL = global, not-null = user-specific<br>
                                confidence (FLOAT, 0.0-1.0)<br>
                                use_count (INT) -- Reinforcement learning<br>
                                created_at (TIMESTAMPTZ)<br><br>
                                <strong>Constraints:</strong> UNIQUE(alias_text, user_id, canonical_entity_id)<br>
                                <strong>Purpose:</strong> Auto-learning from fuzzy match (Stage 3 â†’ creates alias for Stage 2)
                            </div>
                        </div>

                        <!-- Layer 4: Semantic Memories -->
                        <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), transparent); border-left: 3px solid var(--color-success); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">Layer 4: semantic_memories (Entity-Tagged Facts)</div>
                            <div style="color: var(--color-text-secondary);">
                                memory_id (BIGINT PK)<br>
                                user_id (TEXT, indexed with status + importance)<br>
                                content (TEXT) -- Entity-tagged natural language (e.g., "Kai Media prefers Friday deliveries")<br>
                                entities (TEXT[], GIN indexed) -- All entity IDs mentioned (e.g., ["customer:kai_123"])<br>
                                confidence (FLOAT, 0.0-1.0) -- Decays over time via e^(-0.01 Ã— days)<br>
                                importance (FLOAT, 0.0-1.0) -- User-marked or system-inferred<br>
                                status (TEXT: active|aging|superseded|invalidated)<br>
                                source_type (TEXT: episodic|consolidation|inference|correction)<br>
                                source_memory_id (BIGINT) -- Traceability<br>
                                extracted_from_event_id (BIGINT FK â†’ chat_events)<br>
                                source_text (TEXT) -- Original message for explainability<br>
                                superseded_by_memory_id (BIGINT FK self-reference)<br>
                                embedding (VECTOR(1536), IVFFlat indexed) -- pgvector cosine similarity<br>
                                last_accessed_at (TIMESTAMPTZ) -- Recency signal<br>
                                created_at (TIMESTAMPTZ)<br>
                                updated_at (TIMESTAMPTZ)<br><br>
                                <strong>Index Strategy:</strong><br>
                                â€¢ IVFFlat on embedding (lists=100) for vector search<br>
                                â€¢ GIN on entities for fast entity-based retrieval<br>
                                â€¢ Composite (user_id, status, importance DESC) for scoring<br><br>
                                <strong>Purpose:</strong> Structured facts with entity tags + vector search
                            </div>
                        </div>

                        <!-- Memory Conflicts -->
                        <div style="padding: var(--space-3); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), transparent); border-left: 3px solid var(--color-warning); border-radius: var(--radius-md);">
                            <div style="font-weight: 700; margin-bottom: var(--space-2);">memory_conflicts (Epistemic Humility)</div>
                            <div style="color: var(--color-text-secondary);">
                                conflict_id (BIGINT PK)<br>
                                detected_at_event_id (BIGINT FK â†’ chat_events)<br>
                                conflict_type (TEXT: memory_vs_memory|memory_vs_db|temporal)<br>
                                conflict_data (JSONB) -- {memory_ids, values, confidences, db_source}<br>
                                resolution_strategy (TEXT: trust_db|trust_recent|ask_user|both)<br>
                                resolution_outcome (JSONB) -- {action, rationale, updated_memory_ids}<br>
                                resolved_at (TIMESTAMPTZ)<br>
                                created_at (TIMESTAMPTZ)<br><br>
                                <strong>Vision Principle:</strong> Explicit conflict exposure (never silently prefer one source)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6-Layer Memory Model Card -->
            <div class="card mb-5">
                <div class="card-title">ðŸ§  6-Layer Memory Architecture</div>
                <div class="card-subtitle">Specialized layers for different query patterns â€¢ Semantic facts as (subject, predicate, object) triples</div>

                <div style="margin-top: var(--space-5); display: flex; flex-direction: column; gap: var(--space-3);">
                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent); border-left: 4px solid var(--color-purple); border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">6ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Summaries</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Cross-session consolidations â€¢ Example: "Last 7 days with Gai: NET30, Friday delivery, 3 orders"</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent); border-left: 4px solid var(--color-warning); border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">5ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Procedural</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Learned heuristics â€¢ Example: "When invoice mentioned â†’ query domain.invoices"</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent); border-left: 4px solid var(--color-success); border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">4ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Semantic âœ… IMPLEMENTED</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Structured facts (SPO triples) â€¢ Example: (customer:gai_123, delivery_preference, "Friday")</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent); border-left: 4px solid var(--color-primary); border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">3ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Episodic âœ… IMPLEMENTED</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Event-based memories â€¢ Example: "User asked about invoice INV-1009 on Oct 15"</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent); border-left: 4px solid #6366f1; border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">2ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Entities âœ… IMPLEMENTED</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Canonical references â€¢ Example: "Gai" â†’ customer:gai_123 â†’ "Gai Media Productions"</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: linear-gradient(90deg, rgba(107, 114, 128, 0.1), transparent); border-left: 4px solid var(--color-text-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: var(--text-3xl); min-width: 50px; text-align: center;">1ï¸âƒ£</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: var(--text-lg); margin-bottom: var(--space-1);">Chat Events âœ… IMPLEMENTED</div>
                            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">Immutable audit trail â€¢ Example: "Remember: Gai Media prefers Friday deliveries"</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Design Decisions Card -->
            <div class="card mb-5">
                <div class="card-title">ðŸŽ¯ Key Design Decisions</div>
                <div class="card-subtitle">Trade-offs and architectural choices that make the system production-ready</div>

                <div style="margin-top: var(--space-5); display: grid; gap: var(--space-4);">
                    <div style="padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                        <strong style="color: var(--color-primary);">1. Surgical LLM Usage (95% Deterministic)</strong><br><br>
                        <div style="margin-left: var(--space-4);">
                            â€¢ Entity resolution: 70% exact, 15% alias, 10% fuzzy (pg_trgm), 5% LLM<br>
                            â€¢ Memory scoring: 100% deterministic (multi-signal formula, zero LLM)<br>
                            â€¢ Cost: $0.002/turn vs $0.03 pure LLM = <strong>15x savings</strong><br>
                            â€¢ Latency: 50ms avg vs 300ms pure LLM = <strong>6x faster</strong>
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                        <strong style="color: var(--color-success);">2. Dual Truth Architecture</strong><br><br>
                        <div style="margin-left: var(--space-4);">
                            â€¢ <strong>Database:</strong> Authoritative facts (correspondence truth)<br>
                            â€¢ <strong>Memory:</strong> Contextual understanding (learned preferences)<br>
                            â€¢ <strong>Conflicts:</strong> Explicitly detected and exposed (epistemic humility)<br>
                            â€¢ Resolution: Trust DB, mark memory as conflicted, apply decay
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                        <strong style="color: var(--color-warning);">3. Epistemic Humility</strong><br><br>
                        <div style="margin-left: var(--space-4);">
                            â€¢ Max confidence: 0.95 (never 100% certain)<br>
                            â€¢ Exponential decay: <code>confidence Ã— e^(-0.01 Ã— days)</code><br>
                            â€¢ Active recall: When confidence &lt; 0.3, ask user for validation<br>
                            â€¢ Conflict exposure: Never silently prefer one source over another
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                        <strong style="color: var(--color-purple);">4. pgvector (Not Pinecone/Weaviate)</strong><br><br>
                        <div style="margin-left: var(--space-4);">
                            âœ… ACID transactions (critical for semantic memories + entities in single transaction)<br>
                            âœ… Native SQL joins (domain DB + memory DB)<br>
                            âœ… $0 cost (included with PostgreSQL)<br>
                            âœ… Single database (no external service)<br>
                            âš ï¸ Scale limit: 10M vectors (sufficient for current scale, migrate to Weaviate if >10M needed)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Implementation Status Card -->
            <div class="card">
                <div class="card-title">âœ… Core Components Operational</div>
                <div class="card-subtitle">Production-ready system â€¢ 18/18 E2E scenarios passing â€¢ All major features implemented</div>

                <div style="margin-top: var(--space-5); display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4);">
                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Entity Resolution</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ 5-stage hybrid algorithm<br>
                            â€¢ Automatic alias learning<br>
                            â€¢ Fuzzy match with pg_trgm<br>
                            â€¢ LLM coreference fallback<br>
                            â€¢ Domain DB bootstrapping
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Semantic Extraction</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ LLM triple extraction (SPO)<br>
                            â€¢ Confidence assignment<br>
                            â€¢ Conflict detection<br>
                            â€¢ Memory lifecycle management<br>
                            â€¢ PII redaction before storage
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Domain Augmentation</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ LLM tool calling orchestration<br>
                            â€¢ Customer/invoice/order queries<br>
                            â€¢ Order chain analysis<br>
                            â€¢ Full provenance tracking<br>
                            â€¢ Iterative query refinement
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Memory Retrieval</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ Multi-signal scoring (5 signals)<br>
                            â€¢ pgvector similarity search<br>
                            â€¢ Entity overlap (Jaccard)<br>
                            â€¢ Recency + confidence decay<br>
                            â€¢ Top-k ranking (0.0-1.0)
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Conflict Resolution</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ Memory vs database detection<br>
                            â€¢ Trust DB resolution strategy<br>
                            â€¢ Confidence decay on conflict<br>
                            â€¢ Transparent conflict reporting<br>
                            â€¢ Epistemic humility in practice
                        </div>
                    </div>

                    <div style="padding: var(--space-4); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-success);">âœ… Session Consolidation</div>
                        <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: 1.6;">
                            â€¢ Cross-session summaries<br>
                            â€¢ Memory window aggregation<br>
                            â€¢ Key facts extraction<br>
                            â€¢ Interaction pattern tracking<br>
                            â€¢ Summary retrieval & scoring
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Database -->
        <div id="tab-database" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Domain Database Statistics</div>
                <div id="databaseStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Database Tables</div>
                <div id="databaseTables" class="mt-5"></div>
            </div>
        </div>

        <!-- Tab: Memory -->
        <div id="tab-memory" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Memory Layer Statistics</div>
                <div id="memoryStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Memory Layers</div>
                <div class="card-subtitle">Click a layer to view detailed data</div>
                <div id="memoryLayers" class="grid grid-2 mt-5"></div>
            </div>
            <div id="memoryDetail" class="mt-5"></div>
        </div>

        <!-- Tab: Chat -->
        <div id="tab-chat" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                <button class="btn btn-sm" onclick="clearConversation()" style="opacity: 0.7;">
                    Clear Conversation
                </button>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--color-text-secondary); cursor: pointer;">
                    <input type="checkbox" id="debugMode" checked style="cursor: pointer;">
                    Debug Mode
                </label>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-suggestions">
                        <div class="chat-suggestions-title">Try one of these example queries:</div>
                        <div class="suggestion-card" onclick="useSuggestion('What invoices are outstanding?')">
                            <div class="suggestion-card-icon">ðŸ’°</div>
                            <div class="suggestion-card-text">What invoices are outstanding?</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('Tell me about Acme Corp')">
                            <div class="suggestion-card-icon">ðŸ¢</div>
                            <div class="suggestion-card-text">Tell me about Acme Corp</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('What work orders are in progress?')">
                            <div class="suggestion-card-icon">ðŸ”§</div>
                            <div class="suggestion-card-text">What work orders are in progress?</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    <button class="btn btn-success" onclick="consolidateMemories()" style="margin-left: 8px;">ðŸ“¦ Consolidate</button>
                    <button class="btn btn-danger" onclick="clearMemory()" style="margin-left: 8px;">Clear Memory</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL ERROR HANDLER
        // ============================================

        window.addEventListener('error', function(event) {
            console.error('[GLOBAL ERROR]', event.message);
            console.error('[LOCATION]', event.filename, 'Line:', event.lineno, 'Col:', event.colno);
            console.error('[STACK]', event.error?.stack);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('[UNHANDLED REJECTION]', event.reason);
        });

        // ============================================
        // STATE MANAGEMENT
        // ============================================

        let currentTab = 'scenarios';
        let scenariosData = [];
        let databaseStatsData = {};
        let memoryStatsData = {};

        // Category mapping for colors
        const categoryMap = {
            'Financial': 'financial',
            'Operational': 'operational',
            'Entity Resolution': 'entity',
            'Memory Extraction': 'memory',
            'Conflict Resolution': 'conflict',
            'Intelligence': 'intelligence'
        };

        // ============================================
        // TAB MANAGEMENT
        // ============================================

        function updateHeaderCounts() {
            // Update header stats (Domain Database count and Memory Entries count)
            if (databaseStatsData) {
                const totalDb = Object.values(databaseStatsData).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalDbRecords').textContent = totalDb;
            }

            if (memoryStatsData) {
                const totalMemories = Object.values(memoryStatsData).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalMemories').textContent = totalMemories;
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================

        // ============================================
        // SCENARIOS MANAGEMENT
        // ============================================

        let reasoningPaneVisible = false;

        function toggleReasoningPane() {
            reasoningPaneVisible = !reasoningPaneVisible;

            const chatContainer = document.getElementById('chatContainer');
            const reasoningPane = document.getElementById('reasoningPane');
            const toggleBtn = document.getElementById('reasoningToggleBtn');

            // Guard: If elements don't exist, exit early
            if (!reasoningPane || !chatContainer || !toggleBtn) {
                console.warn('Required reasoning pane elements not found');
                return;
            }

            if (reasoningPaneVisible) {
                // Show reasoning pane - split view
                chatContainer.classList.add('split-view');
                reasoningPane.style.display = 'flex';
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'âœ• Hide Reasoning';
            } else {
                // Hide reasoning pane - full width
                chatContainer.classList.remove('split-view');
                reasoningPane.style.display = 'none';
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'ðŸ¤” Show Reasoning';

                // Mark as manually dismissed so it doesn't auto-open again
                localStorage.setItem('reasoning_pane_dismissed', 'true');
            }
        }

        function renderReasoningSteps(traces) {
            const container = document.getElementById('reasoningPaneContent');

            // Guard: If element doesn't exist, exit early
            if (!container) {
                console.warn('reasoningPaneContent element not found');
                return;
            }

            if (!traces || !traces.traces || traces.traces.length === 0) {
                container.innerHTML = `
                    <div class="reasoning-empty">
                        <div class="reasoning-empty-icon">ðŸ¤–</div>
                        <div class="reasoning-empty-text">No reasoning traces available</div>
                    </div>
                `;
                return;
            }

            // Build timeline of steps
            const timeline = document.createElement('div');
            timeline.className = 'reasoning-timeline';

            // Parse and render each trace
            traces.traces.forEach((trace, index) => {
                const step = createReasoningStep(trace, index);
                timeline.appendChild(step);
            });

            container.innerHTML = '';
            container.appendChild(timeline);

            // Progressive reveal animation
            const steps = container.querySelectorAll('.reasoning-step');
            steps.forEach((step, index) => {
                setTimeout(() => {
                    step.style.animationDelay = `${index * 0.1}s`;
                }, 50);
            });
        }

        function createReasoningStep(trace, index) {
            const step = document.createElement('div');

            // Determine step type and icon
            let stepType = 'reasoning';
            let icon = 'ðŸ¤”';

            if (trace.trace_type === 'database_query') {
                stepType = 'database-query';
                icon = 'ðŸ—„ï¸';
            } else if (trace.trace_type === 'memory_retrieval') {
                stepType = 'memory-retrieval';
                icon = 'ðŸ§ ';
            } else if (trace.trace_type === 'reasoning_step') {
                stepType = 'reasoning';
                icon = 'ðŸ¤”';
            } else if (trace.description && trace.description.toLowerCase().includes('llm')) {
                stepType = 'llm-generation';
                icon = 'âœ¨';
            }

            step.className = `reasoning-step ${stepType}`;

            // Build step content
            const title = trace.step || trace.description || `Step ${index + 1}`;
            const description = trace.description || '';
            const duration = trace.duration_ms ? `${Math.round(trace.duration_ms)}ms` : '';

            // Build details from trace data
            let details = '';
            if (trace.trace_type === 'database_query') {
                details = `Query: ${trace.query_type} on ${trace.table} (${trace.rows_affected} rows)`;
            } else if (trace.trace_type === 'memory_retrieval') {
                details = `Found ${trace.memories_found} memories using ${trace.retrieval_method}`;
                if (trace.top_memory) {
                    details += `\nTop memory: "${trace.top_memory.content.substring(0, 50)}..." (relevance: ${trace.top_memory.relevance})`;
                }
            } else if (trace.output_data) {
                details = JSON.stringify(trace.output_data, null, 2);
            }

            step.innerHTML = `
                <div class="reasoning-step-marker">${icon}</div>
                <div class="reasoning-step-content">
                    <div class="reasoning-step-header">
                        <div class="reasoning-step-title">${title}</div>
                        ${duration ? `<div class="reasoning-step-duration">${duration}</div>` : ''}
                    </div>
                    ${description ? `<div class="reasoning-step-description">${description}</div>` : ''}
                    ${details ? `<div class="reasoning-step-details">${details}</div>` : ''}
                </div>
            `;

            return step;
        }

        function clearReasoningPane() {
            const container = document.getElementById('reasoningPaneContent');

            // Guard: If element doesn't exist, exit early
            if (!container) {
                console.warn('reasoningPaneContent element not found');
                return;
            }

            container.innerHTML = `
                <div class="reasoning-empty">
                    <div class="reasoning-empty-icon">ðŸ¤–</div>
                    <div class="reasoning-empty-text">Send a message to see how the system thinks</div>
                </div>
            `;
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function showTab(tabName) {
            currentTab = tabName;

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Find and activate the corresponding nav tab button
            const navButtons = document.querySelectorAll('.nav-tab');
            const targetNavButton = Array.from(navButtons).find(btn =>
                btn.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            if (targetNavButton) {
                targetNavButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'database') {
                loadDatabaseTab();
            } else if (tabName === 'memory') {
                loadMemoryTab();
            }
        }

        // ============================================
        // SCENARIOS TAB
        // ============================================

        async function loadScenarios() {
            try {
                const response = await fetch('/api/v1/demo/scenarios');
                scenariosData = await response.json();
                renderScenarios();
            } catch (error) {
                const scenariosList = document.getElementById('scenariosList');
                if (scenariosList) {
                    scenariosList.innerHTML = `
                        <div class="alert alert-error">Failed to load scenarios: ${error.message}</div>
                    `;
                }
            }
        }

        function renderScenarios() {
            const html = scenariosData.map((scenario, index) => {
                const categoryClass = categoryMap[scenario.category] || 'intelligence';
                const scenarioNumber = index + 1;

                return `
                    <div class="scenario-card category-${categoryClass}">
                        <div class="scenario-number">${scenarioNumber}</div>
                        <div class="scenario-header">
                            <div style="flex: 1;">
                                <div class="scenario-title">${scenario.title}</div>
                                <div class="scenario-description">${scenario.description}</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadScenario(${scenario.scenario_id})">
                                Load
                            </button>
                        </div>
                        <div class="scenario-meta">
                            <span class="scenario-category">${scenario.category}</span>
                            ${scenario.data_requirements ? `<span>${scenario.data_requirements.length} data sources</span>` : ''}
                        </div>
                        <button class="btn btn-details" onclick="toggleScenarioDetails(${scenario.scenario_id})">
                            <span id="toggle-icon-${scenario.scenario_id}">â–¼</span> Show Details
                        </button>
                        <div class="scenario-details" id="scenario-details-${scenario.scenario_id}"></div>
                    </div>
                `;
            }).join('');

            const scenariosList = document.getElementById('scenariosList');
            if (scenariosList) {
                scenariosList.innerHTML = html;
            }
        }

        async function toggleScenarioDetails(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            const icon = document.getElementById(`toggle-icon-${scenarioId}`);
            const button = event.target.closest('button');

            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.textContent = 'â–¼';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">â–¼</span> Show Details`;
            } else {
                // Load actual data if not already loaded
                if (!details.dataset.loaded) {
                    await loadScenarioData(scenarioId);
                }
                details.classList.add('expanded');
                icon.textContent = 'â–²';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">â–²</span> Hide Details`;
            }
        }

        async function loadScenarioData(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            details.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`/api/v1/demo/scenarios/${scenarioId}/data`);
                const data = await response.json();

                // Build sections
                let html = '';

                // Database Records
                html += '<div class="scenario-details-section">';
                html += '<div class="scenario-details-title"><span class="badge badge-primary">Database Records</span></div>';

                let dbContent = '';
                if (data.customers.length > 0) {
                    dbContent += '<strong>Customers:</strong>\n';
                    data.customers.forEach(c => {
                        dbContent += `  â€¢ ${c.name} (${c.industry})\n`;
                    });
                    dbContent += '\n';
                }
                if (data.sales_orders.length > 0) {
                    dbContent += '<strong>Sales Orders:</strong>\n';
                    data.sales_orders.forEach(so => {
                        dbContent += `  â€¢ ${so.so_number}: ${so.title} [${so.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.invoices.length > 0) {
                    dbContent += '<strong>Invoices:</strong>\n';
                    data.invoices.forEach(inv => {
                        dbContent += `  â€¢ ${inv.invoice_number}: $${inv.amount} due ${inv.due_date} [${inv.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.work_orders.length > 0) {
                    dbContent += '<strong>Work Orders:</strong>\n';
                    data.work_orders.forEach(wo => {
                        dbContent += `  â€¢ ${wo.description} - ${wo.technician} [${wo.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.payments.length > 0) {
                    dbContent += '<strong>Payments:</strong>\n';
                    data.payments.forEach(pay => {
                        dbContent += `  â€¢ ${pay.invoice_number}: $${pay.amount} via ${pay.method}\n`;
                    });
                    dbContent += '\n';
                }
                if (data.tasks.length > 0) {
                    dbContent += '<strong>Tasks:</strong>\n';
                    data.tasks.forEach(task => {
                        dbContent += `  â€¢ ${task.title} [${task.status}]\n`;
                    });
                }

                html += `<div class="scenario-details-content">${dbContent || 'No database records'}</div>`;
                html += '</div>';

                // Memory Entries
                if (data.semantic_memories.length > 0) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-success">Semantic Memories</span></div>';

                    let memContent = '';
                    data.semantic_memories.forEach(mem => {
                        const objValue = typeof mem.object_value === 'object'
                            ? JSON.stringify(mem.object_value)
                            : mem.object_value;
                        memContent += `â€¢ ${mem.subject} â†’ ${mem.predicate}: ${objValue} (confidence: ${(mem.confidence * 100).toFixed(0)}%)\n`;
                    });

                    html += `<div class="scenario-details-content">${memContent}</div>`;
                    html += '</div>';
                }

                // Expected Behavior
                const scenario = scenariosData.find(s => s.scenario_id === scenarioId);
                if (scenario && scenario.expected_behavior) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-purple">Expected Behavior</span></div>';
                    html += `<div class="scenario-details-content">${scenario.expected_behavior}</div>`;
                    html += '</div>';
                }

                // Example Query
                if (scenario && scenario.expected_query) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title" style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span class="badge badge-pink">Example Query</span>';
                    html += `<button class="btn btn-primary btn-sm" onclick="tryQuery('${scenario.expected_query.replace(/'/g, "\\'")}')">Try Query â†’</button>`;
                    html += '</div>';
                    html += `<div class="scenario-details-content">${scenario.expected_query}</div>`;
                    html += '</div>';
                }

                details.innerHTML = html;
                details.dataset.loaded = 'true';
            } catch (error) {
                details.innerHTML = `<div class="alert alert-error">Failed to load scenario data: ${error.message}</div>`;
            }
        }

        async function loadScenario(scenarioId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                await fetch(`/api/v1/demo/scenarios/${scenarioId}/load`, { method: 'POST' });
                showGlobalSuccess(`Scenario ${scenarioId} loaded successfully`);
                btn.textContent = 'Loaded';
                updateHeaderStats();

                // Animate data flow through architecture diagram
                setTimeout(() => animateDataFlow(), 500);
            } catch (error) {
                showGlobalError('Load Failed', error.message);
                btn.disabled = false;
                btn.textContent = 'Load';
            }
        }

        async function clearMemoriesOnly() {
            if (!confirm('This will clear all memories (chat history, entities, semantic memories). Domain data will be preserved. Continue?')) return;

            try {
                await fetch('/api/v1/demo/scenarios/reset-memories', { method: 'POST' });
                showGlobalSuccess('Memory data cleared successfully');
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Clear Failed', error.message);
            }
        }

        async function resetAllData() {
            if (!confirm('This will delete all data (domain + memories). Continue?')) return;

            try {
                await fetch('/api/v1/demo/scenarios/reset', { method: 'POST' });
                showGlobalSuccess('All data reset successfully');
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Reset Failed', error.message);
            }
        }

        // ============================================
        // DATABASE TAB
        // ============================================

        async function loadDatabaseTab() {
            await loadDatabaseStats();
            await loadDatabaseTables();
        }

        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/v1/demo/database/stats');
                databaseStatsData = await response.json();
                renderDatabaseStats();
            } catch (error) {
                console.error('Failed to load database stats:', error);
            }
        }

        function renderDatabaseStats() {
            const stats = [
                { label: 'Customers', value: databaseStatsData.customers || 0, color: 'var(--color-primary)' },
                { label: 'Sales Orders', value: databaseStatsData.sales_orders || 0, color: 'var(--color-success)' },
                { label: 'Work Orders', value: databaseStatsData.work_orders || 0, color: 'var(--color-warning)' },
                { label: 'Invoices', value: databaseStatsData.invoices || 0, color: 'var(--color-purple)' },
                { label: 'Payments', value: databaseStatsData.payments || 0, color: 'var(--color-teal)' },
                { label: 'Tasks', value: databaseStatsData.tasks || 0, color: 'var(--color-pink)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            const databaseStats = document.getElementById('databaseStats');
            if (databaseStats) {
                databaseStats.innerHTML = html;
            }
        }

        async function loadDatabaseTables() {
            const tables = [
                { name: 'customers', label: 'Customers' },
                { name: 'sales_orders', label: 'Sales Orders' },
                { name: 'invoices', label: 'Invoices' },
                { name: 'work_orders', label: 'Work Orders' },
                { name: 'payments', label: 'Payments' },
                { name: 'tasks', label: 'Tasks' }
            ];

            const html = await Promise.all(tables.map(async table => {
                try {
                    const response = await fetch(`/api/v1/demo/database/${table.name}`);
                    const data = await response.json();

                    // Dynamically extract fields from first row (if data exists)
                    const fields = data.length > 0 ? Object.keys(data[0]) : [];

                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        ${fields.map(field => `<th>${field.replace(/_/g, ' ')}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="10" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.slice(0, 10).map(row => `
                                        <tr>
                                            ${fields.map(field => {
                                                let value = row[field];
                                                if (field === 'status') {
                                                    const statusColors = {
                                                        'open': 'warning',
                                                        'closed': 'success',
                                                        'paid': 'success',
                                                        'pending': 'warning',
                                                        'overdue': 'danger',
                                                        'completed': 'success',
                                                        'in_progress': 'primary',
                                                        'draft': 'secondary',
                                                        'approved': 'success',
                                                        'in_fulfillment': 'primary',
                                                        'fulfilled': 'success',
                                                        'cancelled': 'danger',
                                                        'queued': 'secondary',
                                                        'blocked': 'danger',
                                                        'done': 'success',
                                                        'todo': 'secondary',
                                                        'doing': 'primary',
                                                        'void': 'danger'
                                                    };
                                                    return `<td><span class="badge badge-${statusColors[value] || 'primary'}">${value}</span></td>`;
                                                }
                                                return `<td class="text-truncate" style="max-width: 200px;">${value || '-'}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${data.length > 10 ? `<div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--color-text-tertiary);">Showing 10 of ${data.length} records</div>` : ''}
                    `;

                    return `
                        <div class="card mb-5">
                            <div class="card-header">
                                <div class="card-title">${table.label}</div>
                                <span class="badge badge-primary">${data.length}</span>
                            </div>
                            ${tableHtml}
                        </div>
                    `;
                } catch (error) {
                    return `
                        <div class="card mb-5">
                            <div class="card-title">${table.label}</div>
                            <div class="alert alert-error">Failed to load</div>
                        </div>
                    `;
                }
            }));

            const databaseTables = document.getElementById('databaseTables');
            if (databaseTables) {
                databaseTables.innerHTML = html.join('');
            }
        }

        // ============================================
        // MEMORY TAB
        // ============================================

        async function loadMemoryTab() {
            await loadMemoryStats();
            await loadMemoryLayers();
        }

        async function loadMemoryStats() {
            try {
                const response = await fetch('/api/v1/demo/memories/stats');
                memoryStatsData = await response.json();
                renderMemoryStats();
            } catch (error) {
                console.error('Failed to load memory stats:', error);
            }
        }

        function renderMemoryStats() {
            const stats = [
                { label: 'Chat Events', value: memoryStatsData.chat_events || 0, color: 'var(--color-teal)' },
                { label: 'Entities', value: memoryStatsData.canonical_entities || 0, color: 'var(--color-primary)' },
                { label: 'Aliases', value: memoryStatsData.entity_aliases || 0, color: 'var(--color-primary)' },
                { label: 'Episodic', value: memoryStatsData.episodic_memories || 0, color: 'var(--color-purple)' },
                { label: 'Semantic', value: memoryStatsData.semantic_memories || 0, color: 'var(--color-success)' },
                { label: 'Procedural', value: memoryStatsData.procedural_memories || 0, color: 'var(--color-warning)' },
                { label: 'Summaries', value: memoryStatsData.memory_summaries || 0, color: 'var(--color-pink)' },
                { label: 'Conflicts', value: memoryStatsData.memory_conflicts || 0, color: 'var(--color-danger)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            const memoryStats = document.getElementById('memoryStats');
            if (memoryStats) {
                memoryStats.innerHTML = html;
            }
        }

        async function loadMemoryLayers() {
            const layers = [
                {
                    number: 1,
                    name: 'Raw Events',
                    key: 'chat_events',
                    description: 'Immutable conversation audit trail',
                    count: memoryStatsData.chat_events || 0,
                    endpoint: '/api/v1/demo/memories/chat_events'
                },
                {
                    number: 2,
                    name: 'Entity Resolution',
                    key: 'entities',
                    description: 'Canonical entities + aliases',
                    count: (memoryStatsData.canonical_entities || 0) + (memoryStatsData.entity_aliases || 0),
                    endpoint: null
                },
                {
                    number: 3,
                    name: 'Episodic Memories',
                    key: 'episodic',
                    description: 'Events with temporal context',
                    count: memoryStatsData.episodic_memories || 0,
                    endpoint: '/api/v1/demo/memories/episodic'
                },
                {
                    number: 4,
                    name: 'Semantic Memories',
                    key: 'semantic',
                    description: 'Entity-tagged facts with importance',
                    count: memoryStatsData.semantic_memories || 0,
                    endpoint: '/api/v1/demo/memories/semantic'
                },
                {
                    number: 5,
                    name: 'Procedural Memories',
                    key: 'procedural',
                    description: 'Learned patterns & heuristics',
                    count: memoryStatsData.procedural_memories || 0,
                    endpoint: '/api/v1/demo/memories/procedural'
                },
                {
                    number: 6,
                    name: 'Summaries',
                    key: 'summaries',
                    description: 'Cross-session consolidation',
                    count: memoryStatsData.memory_summaries || 0,
                    endpoint: '/api/v1/demo/memories/summaries'
                }
            ];

            const html = layers.map(layer => `
                <div class="layer-card layer-${layer.number}" onclick="loadLayerDetail('${layer.key}', ${layer.endpoint ? `'${layer.endpoint}'` : null}, ${layer.number})">
                    <div class="layer-card-header">
                        <span class="layer-card-number">Layer ${layer.number}</span>
                        <span class="badge badge-primary">${layer.count}</span>
                    </div>
                    <div class="layer-card-title">${layer.name}</div>
                    <div class="layer-card-description">${layer.description}</div>
                </div>
            `).join('');

            const memoryLayers = document.getElementById('memoryLayers');
            if (memoryLayers) {
                memoryLayers.innerHTML = html;
            }
        }

        async function loadLayerDetail(key, endpoint, layerNumber) {
            const detailContainer = document.getElementById('memoryDetail');

            if (!detailContainer) {
                console.warn('memoryDetail element not found');
                return;
            }

            if (!endpoint && key === 'entities') {
                detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const [entitiesRes, aliasesRes] = await Promise.all([
                        fetch('/api/v1/demo/memories/entities'),
                        fetch('/api/v1/demo/memories/aliases')
                    ]);

                    const entities = await entitiesRes.json();
                    const aliases = await aliasesRes.json();

                    let html = `<div class="card">`;

                    if (entities.length > 0) {
                        html += `
                            <div class="card-title mb-4">Canonical Entities (${entities.length})</div>
                            <div class="table-container mb-5">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Entity ID</th>
                                            <th>Canonical Name</th>
                                            <th>Entity Type</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${entities.map(e => `
                                            <tr>
                                                <td class="text-mono">${e.entity_id}</td>
                                                <td>${e.canonical_name}</td>
                                                <td><span class="badge badge-primary">${e.entity_type}</span></td>
                                                <td>${new Date(e.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (aliases.length > 0) {
                        html += `
                            <div class="card-title mb-4">Entity Aliases (${aliases.length})</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Alias</th>
                                            <th>Entity ID</th>
                                            <th>Similarity</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${aliases.map(a => `
                                            <tr>
                                                <td>${a.alias_text}</td>
                                                <td class="text-mono">${a.entity_id}</td>
                                                <td><span class="badge badge-success">${(a.similarity_score * 100).toFixed(0)}%</span></td>
                                                <td>${new Date(a.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (entities.length === 0 && aliases.length === 0) {
                        html += '<div class="empty-state">No entity data</div>';
                    }

                    html += `</div>`;
                    detailContainer.innerHTML = html;
                } catch (error) {
                    detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
                }
                return;
            }

            if (!endpoint) {
                detailContainer.innerHTML = '';
                return;
            }

            detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                // Helper function to format cell value based on field name and type
                const formatCellValue = (field, value, row) => {
                    if (value === null || value === undefined) return '-';

                    // UUID truncation for readability
                    if (field.includes('_id') && typeof value === 'string' && value.length > 30) {
                        return `<span class="text-mono text-truncate" style="max-width: 100px;">${value.slice(0, 8)}...</span>`;
                    }

                    // Status badges
                    if (field === 'status') {
                        const statusColors = {
                            'active': 'success', 'inactive': 'warning', 'superseded': 'danger',
                            'open': 'warning', 'closed': 'success', 'paid': 'success',
                            'pending': 'warning', 'overdue': 'danger', 'completed': 'success',
                            'in_progress': 'primary', 'draft': 'secondary', 'approved': 'success',
                            'in_fulfillment': 'primary', 'fulfilled': 'success', 'cancelled': 'danger',
                            'queued': 'secondary', 'blocked': 'danger', 'done': 'success',
                            'todo': 'secondary', 'doing': 'primary', 'void': 'danger'
                        };
                        return `<span class="badge badge-${statusColors[value] || 'primary'}">${value}</span>`;
                    }

                    // Role badges
                    if (field === 'role') {
                        return `<span class="badge badge-${value === 'user' ? 'primary' : 'success'}">${value}</span>`;
                    }

                    // Type/category badges
                    if (field.includes('_type') || field === 'scope_type' || field === 'event_type') {
                        return `<span class="badge badge-primary">${value}</span>`;
                    }

                    // Confidence as percentage
                    if (field === 'confidence' && typeof value === 'number') {
                        return `<span class="badge badge-success">${(value * 100).toFixed(0)}%</span>`;
                    }

                    // Importance scores
                    if (field === 'importance' && typeof value === 'number') {
                        return `<span class="badge badge-warning">${value.toFixed(2)}</span>`;
                    }

                    // Count badges
                    if ((field.includes('_count') || field === 'observed') && typeof value === 'number') {
                        return `<span class="badge badge-primary">${value}</span>`;
                    }

                    // Date/timestamp formatting
                    if ((field.includes('_at') || field.includes('date')) && value) {
                        try {
                            return new Date(value).toLocaleString();
                        } catch {
                            return value;
                        }
                    }

                    // JSON objects/arrays - pretty print and truncate
                    if (typeof value === 'object') {
                        const jsonStr = JSON.stringify(value);
                        return `<span class="text-truncate" style="max-width: 150px;">${jsonStr}</span>`;
                    }

                    // Long text fields - truncate
                    if (typeof value === 'string' && value.length > 50) {
                        return `<span class="text-truncate" style="max-width: 250px;">${value}</span>`;
                    }

                    return value;
                };

                let html = `<div class="card"><div class="card-title mb-5">Layer ${layerNumber} Data (${data.length} records)</div>`;

                // Define expected fields for each layer type (for consistent display even when empty)
                const layerFieldDefinitions = {
                    'chat_events': ['event_id', 'session_id', 'user_id', 'role', 'content', 'created_at'],
                    'entities': ['entity_id', 'canonical_name', 'entity_type', 'created_at'],
                    'episodic': ['memory_id', 'user_id', 'session_id', 'summary', 'event_type', 'entities', 'importance', 'created_at'],
                    'semantic': ['memory_id', 'user_id', 'content', 'entities', 'confidence', 'importance', 'source_type', 'status', 'created_at', 'last_accessed_at'],
                    'procedural': ['memory_id', 'user_id', 'trigger_pattern', 'action_heuristic', 'observed_count', 'confidence', 'created_at'],
                    'summaries': ['summary_id', 'user_id', 'scope_type', 'scope_identifier', 'summary_text', 'key_facts', 'confidence', 'created_at'],
                    'conflicts': ['conflict_id', 'conflict_type', 'conflict_data', 'resolution_strategy', 'resolved_at', 'created_at']
                };

                // Dynamically extract fields from first row (if data exists), or use predefined fields
                const fields = data.length > 0
                    ? Object.keys(data[0]).filter(f => f !== 'embedding')
                    : (layerFieldDefinitions[key] || []);

                html += `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    ${fields.map(field => `<th>${field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.length === 0 && fields.length > 0 ? `
                                    <tr>
                                        <td colspan="${fields.length}" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                    </tr>
                                ` : data.length === 0 ? `
                                    <tr>
                                        <td style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                    </tr>
                                ` : data.map(row => `
                                    <tr>
                                        ${fields.map(field => `<td>${formatCellValue(field, row[field], row)}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                html += `</div>`;
                detailContainer.innerHTML = html;
            } catch (error) {
                detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
            }
        }

        // ============================================
        // CHAT TAB
        // ============================================

        let chatHistory = [];
        let currentSessionId = null;  // Track session for conversation continuity

        function tryQuery(query) {
            // Switch to chat tab
            showTab('chat');

            // Load query into input
            const input = document.getElementById('chatInput');
            input.value = query;

            // Focus input for user to review and send
            input.focus();

            // Scroll input into view
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearConversation() {
            const container = document.getElementById('chatMessages');

            if (!container) {
                console.warn('chatMessages element not found');
                return;
            }

            container.innerHTML = `
                <div class="chat-suggestions">
                    <div class="chat-suggestions-title">Try one of these example queries:</div>
                    <div class="suggestion-card" onclick="useSuggestion('What invoices are outstanding?')">
                        <div class="suggestion-card-icon">ðŸ’°</div>
                        <div class="suggestion-card-text">What invoices are outstanding?</div>
                    </div>
                    <div class="suggestion-card" onclick="useSuggestion('Tell me about Acme Corp')">
                        <div class="suggestion-card-icon">ðŸ¢</div>
                        <div class="suggestion-card-text">Tell me about Acme Corp</div>
                    </div>
                    <div class="suggestion-card" onclick="useSuggestion('What work orders are in progress?')">
                        <div class="suggestion-card-icon">ðŸ”§</div>
                        <div class="suggestion-card-text">What work orders are in progress?</div>
                    </div>
                </div>
            `;
            currentSessionId = null;  // Reset session for fresh conversation

            // Clear reasoning pane and reset auto-open preference
            clearReasoningPane();
            localStorage.removeItem('reasoning_pane_dismissed');
        }

        function useSuggestion(query) {
            const input = document.getElementById('chatInput');
            input.value = query;
            input.focus();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            const debugMode = document.getElementById('debugMode').checked;

            addChatMessage('user', message);
            input.value = '';

            // Show real-time processing steps if debug mode is on
            let processingId = null;
            if (debugMode) {
                processingId = addProcessingSteps();
            } else {
                // Show simple typing indicator
                processingId = addTypingIndicator();
            }

            try {
                const requestBody = {
                    message: message,
                    user_id: 'demo-user',
                    debug: debugMode
                };

                // Include session_id if we have one (for conversation continuity)
                if (currentSessionId) {
                    requestBody.session_id = currentSessionId;
                }

                const response = await fetch('/api/v1/demo/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Populate processing details with response data
                if (debugMode && processingId) {
                    populateProcessingDetails(processingId, data);
                    // Convert processing message to include reply
                    removeProcessingSteps(processingId, data.reply, data.debug || data.traces);
                } else {
                    removeTypingIndicator(processingId);
                    // Add reply as new message in non-debug mode
                    addChatMessage('assistant', data.reply, data.debug || data.traces);
                }

                // Store session_id from response for next message
                if (data.session_id) {
                    currentSessionId = data.session_id;
                }

                // Refresh memory stats if memories were created
                if (data.debug && data.debug.memories_created && data.debug.memories_created.length > 0) {
                    loadMemoryStats();
                }

                // Render reasoning steps if reasoning pane is visible and traces available
                if (data.traces) {
                    renderReasoningSteps(data.traces);

                    // Auto-open reasoning pane on first message if not already open
                    if (!reasoningPaneVisible && !localStorage.getItem('reasoning_pane_dismissed')) {
                        setTimeout(() => toggleReasoningPane(), 500);
                    }
                }

            } catch (error) {
                if (debugMode && processingId) {
                    removeProcessingSteps(processingId, `Error: ${error.message}`, null);
                } else if (processingId) {
                    removeTypingIndicator(processingId);
                    addChatMessage('assistant', `Error: ${error.message}`);
                }
            }
        }

        async function clearMemory() {
            if (!confirm('Are you sure you want to clear all memory data? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/demo/memories/clear?user_id=demo-user', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Clear chat UI
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                    }

                    // Add confirmation message
                    addChatMessage('system', `Memory cleared successfully! Deleted ${data.total_deleted} records.`);

                    // Reset session ID
                    currentSessionId = null;

                    // Optionally refresh the stats/data displays
                    if (typeof refreshData === 'function') {
                        refreshData();
                    }
                } else {
                    addChatMessage('system', 'Failed to clear memory. Please try again.');
                }
            } catch (error) {
                console.error('Error clearing memory:', error);
                addChatMessage('system', `Error clearing memory: ${error.message}`);
            }
        }

        async function consolidateMemories() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ Consolidating...';

            try {
                addChatMessage('system', 'ðŸ“¦ Starting memory consolidation for last 3 sessions...');

                const response = await fetch('/api/v1/consolidate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': 'demo-user'
                    },
                    body: JSON.stringify({
                        scope_type: 'session_window',
                        scope_identifier: '3',
                        force: false
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Consolidation failed');
                }

                const data = await response.json();

                // Display consolidation results
                let message = `âœ… Consolidation complete!\n\n`;
                message += `**Summary**: ${data.summary_text}\n\n`;

                if (Object.keys(data.key_facts).length > 0) {
                    message += `**Key Facts** (${Object.keys(data.key_facts).length}):\n`;
                    for (const [name, fact] of Object.entries(data.key_facts)) {
                        message += `â€¢ ${name}: ${JSON.stringify(fact.value)} (confidence: ${fact.confidence.toFixed(2)})\n`;
                    }
                }

                if (data.interaction_patterns && data.interaction_patterns.length > 0) {
                    message += `\n**Patterns**: ${data.interaction_patterns.join(', ')}`;
                }

                addChatMessage('system', message);

                // Refresh stats if available
                if (typeof refreshData === 'function') {
                    refreshData();
                }

            } catch (error) {
                console.error('Error consolidating memories:', error);
                addChatMessage('system', `âŒ Consolidation error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator-msg';

            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            avatar.textContent = 'A';

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create typing indicator with 3 spans
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.appendChild(document.createElement('span'));
            indicator.appendChild(document.createElement('span'));
            indicator.appendChild(document.createElement('span'));

            // Assemble structure
            contentDiv.appendChild(indicator);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(contentDiv);
            container.appendChild(typingDiv);

            container.scrollTop = container.scrollHeight;
            return 'typing-indicator-msg';
        }

        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        // Processing steps visualization for debug mode
        function addProcessingSteps() {
            const container = document.getElementById('chatMessages');
            const processingId = 'processing-steps-' + Date.now();
            const startTime = performance.now(); // Track start time for latency

            // Helper function to create a processing step
            function createProcessingStep(stepName, stepNumber, stepText) {
                const step = document.createElement('div');
                step.className = 'processing-step';
                step.setAttribute('data-step', stepName);
                step.setAttribute('data-start-time', startTime); // Store start time

                const icon = document.createElement('div');
                icon.className = 'processing-step-icon';
                icon.textContent = 'â³';

                const textContainer = document.createElement('div');
                textContainer.className = 'processing-step-text';

                const title = document.createElement('div');
                title.textContent = `Step ${stepNumber}: ${stepText}`;

                const details = document.createElement('div');
                details.className = 'processing-step-details';

                textContainer.appendChild(title);
                textContainer.appendChild(details);
                step.appendChild(icon);
                step.appendChild(textContainer);

                return step;
            }

            // Create main processing div
            const processingDiv = document.createElement('div');
            processingDiv.className = 'chat-message assistant';
            processingDiv.id = processingId;

            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            avatar.textContent = 'A';

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create role header
            const roleDiv = document.createElement('div');
            roleDiv.className = 'chat-message-role';
            roleDiv.textContent = 'Processing Request...';

            // Create steps container
            const stepsContainer = document.createElement('div');
            stepsContainer.className = 'processing-steps';

            // Add all 7 steps (updated to match current architecture)
            const steps = [
                { name: 'pii', text: 'PII Detection & Redaction (Phase 3.1)' },
                { name: 'store', text: 'Store chat event' },
                { name: 'resolve', text: 'Resolve entities with LLM (Phase 1A)' },
                { name: 'extract', text: 'Extract semantics (Phase 1B)' },
                { name: 'augment', text: 'LLM Tool Calling (Phase 1C)' },
                { name: 'score', text: 'Score & retrieve memories (Phase 1D)' },
                { name: 'generate', text: 'Generate LLM reply' }
            ];

            steps.forEach((step, index) => {
                stepsContainer.appendChild(createProcessingStep(step.name, index + 1, step.text));
            });

            // Assemble the structure
            contentDiv.appendChild(roleDiv);
            contentDiv.appendChild(stepsContainer);
            processingDiv.appendChild(avatar);
            processingDiv.appendChild(contentDiv);
            container.appendChild(processingDiv);

            container.scrollTop = container.scrollHeight;
            return processingId;
        }

        function populateProcessingDetails(processingId, data) {
            const processingElement = document.getElementById(processingId);
            if (!processingElement) return;

            // Helper function to complete a step with actual server timing
            function completeStep(step, detailText, actualDuration) {
                if (!step) return;

                const icon = step.querySelector('.processing-step-icon');
                const details = step.querySelector('.processing-step-details');

                // Mark as completed (triggers CSS for green checkmark)
                step.classList.add('completed');

                if (icon) {
                    icon.textContent = 'âœ“';
                }

                if (details) {
                    const durationText = actualDuration !== undefined
                        ? `(+${actualDuration.toFixed(3)}s)`
                        : '';
                    details.textContent = `${detailText} ${durationText}`;
                }
            }

            // Check if we have step_timings from the server
            const stepTimings = data.step_timings || {};

            // Calculate cumulative delays for progressive display
            const stepOrder = ['pii', 'store', 'resolve', 'extract', 'augment', 'score', 'generate'];
            let cumulativeDelay = 0;
            const delays = {};

            // Calculate when each step should complete (based on cumulative server time)
            stepOrder.forEach(stepName => {
                delays[stepName] = cumulativeDelay;
                if (stepTimings[stepName]) {
                    cumulativeDelay += stepTimings[stepName] * 1000; // Convert to ms
                }
            });

            // Step 1: PII Detection & Redaction (Phase 3.1)
            setTimeout(() => {
                const piiStep = processingElement.querySelector('[data-step="pii"]');
                completeStep(piiStep, 'No PII detected', stepTimings.pii);
            }, delays.pii);

            // Step 2: Store (always completes)
            setTimeout(() => {
                const storeStep = processingElement.querySelector('[data-step="store"]');
                const sessionText = `Session: ${data.session_id ? data.session_id.substring(0, 8) + '...' : 'N/A'}`;
                completeStep(storeStep, sessionText, stepTimings.store);
            }, delays.store);

            // Step 3: Resolve entities with LLM (Phase 1A)
            setTimeout(() => {
                const resolveStep = processingElement.querySelector('[data-step="resolve"]');
                let resolveText = 'LLM mention extraction completed';
                if (data.debug && data.debug.entities_resolved) {
                    const count = data.debug.entities_resolved.length;
                    resolveText = `${count} entit${count !== 1 ? 'ies' : 'y'} resolved via LLM`;
                }
                completeStep(resolveStep, resolveText, stepTimings.resolve);
            }, delays.resolve);

            // Step 4: Extract semantics (Phase 1B)
            setTimeout(() => {
                const extractStep = processingElement.querySelector('[data-step="extract"]');
                let extractText = 'Semantic extraction completed';
                if (data.debug && data.debug.memories_created) {
                    const count = data.debug.memories_created.length;
                    extractText = `${count} semantic memor${count !== 1 ? 'ies' : 'y'} created`;
                }
                completeStep(extractStep, extractText, stepTimings.extract);
            }, delays.extract);

            // Step 5: LLM Tool Calling (Phase 1C)
            setTimeout(() => {
                const augmentStep = processingElement.querySelector('[data-step="augment"]');
                let augmentText = 'No domain facts retrieved';
                if (data.debug && data.debug.domain_facts_used && data.debug.domain_facts_used.length > 0) {
                    const facts = data.debug.domain_facts_used;
                    const sources = [...new Set(facts.map(f => f.source))];
                    augmentText = `${facts.length} fact${facts.length !== 1 ? 's' : ''} from ${sources.join(', ')}`;
                }
                completeStep(augmentStep, augmentText, stepTimings.augment);
            }, delays.augment);

            // Step 6: Score & retrieve memories (Phase 1D)
            setTimeout(() => {
                const scoreStep = processingElement.querySelector('[data-step="score"]');
                let scoreText = 'No memories retrieved';
                if (data.debug && data.debug.memories_retrieved && data.debug.memories_retrieved.length > 0) {
                    const memories = data.debug.memories_retrieved;
                    const avgRelevance = memories.reduce((sum, m) => sum + (m.relevance || 0), 0) / memories.length;
                    const avgConfidence = memories.reduce((sum, m) => sum + (m.confidence || 0), 0) / memories.length;
                    scoreText = `${memories.length} memor${memories.length !== 1 ? 'ies' : 'y'} (rel: ${avgRelevance.toFixed(2)}, conf: ${avgConfidence.toFixed(2)})`;
                }
                completeStep(scoreStep, scoreText, stepTimings.score);
            }, delays.score);

            // Step 7: Generate LLM reply
            setTimeout(() => {
                const generateStep = processingElement.querySelector('[data-step="generate"]');
                let generateText = 'Reply generation completed';
                if (data.reply) {
                    const chars = data.reply.length;
                    const tokens = Math.ceil(chars / 4);
                    generateText = `${chars} chars, ~${tokens} tokens`;
                }
                completeStep(generateStep, generateText, stepTimings.generate);
            }, delays.generate);
        }

        function removeProcessingSteps(id, replyContent, debugData) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn('removeProcessingSteps: element not found:', id);
                return;
            }

            // Mark all remaining steps as completed
            const allSteps = element.querySelectorAll('.processing-step');
            allSteps.forEach(step => {
                const icon = step.querySelector('.processing-step-icon');
                if (icon && icon.textContent === 'â³') {
                    icon.textContent = 'âœ“';
                }
                step.classList.add('completed');
            });

            // Reorder content: move processing steps to bottom, add reply at top
            const contentDiv = element.querySelector('.chat-message-content');
            const roleDiv = element.querySelector('.chat-message-role');
            const stepsContainer = element.querySelector('.processing-steps');

            if (!contentDiv) {
                console.warn('removeProcessingSteps: contentDiv not found for:', id);
                return;
            }

            if (!replyContent) {
                console.warn('removeProcessingSteps: no reply content for:', id);
                return;
            }

            // Remove processing steps temporarily to reorder
            if (stepsContainer && stepsContainer.parentNode === contentDiv) {
                try {
                    contentDiv.removeChild(stepsContainer);
                } catch (error) {
                    console.error('Error removing steps container:', error);
                }
            }

            // Update role to just show assistant + timestamp
            if (roleDiv) {
                try {
                    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    // Clear and rebuild using DOM methods instead of innerHTML
                    roleDiv.textContent = 'assistant ';
                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'chat-message-timestamp';
                    timestampSpan.textContent = timestamp;
                    roleDiv.appendChild(timestampSpan);
                } catch (error) {
                    console.error('Error updating roleDiv:', error);
                }
            }

            // Add reply text at the top (after role)
            try {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'chat-message-text';
                replyDiv.textContent = replyContent;
                contentDiv.appendChild(replyDiv);
            } catch (error) {
                console.error('Error adding reply text:', error);
                return;
            }

            // Build and add debug HTML if available
            if (debugData) {
                try {
                    if (debugData.domain_facts_used && debugData.domain_facts_used.length > 0) {
                        const factsDiv = document.createElement('div');
                        factsDiv.className = 'chat-message-debug';

                        const factsTitle = document.createElement('div');
                        factsTitle.className = 'chat-message-debug-title';
                        factsTitle.textContent = `Domain Facts (${debugData.domain_facts_used.length})`;
                        factsDiv.appendChild(factsTitle);

                        debugData.domain_facts_used.slice(0, 3).forEach(f => {
                            const item = document.createElement('div');
                            item.className = 'chat-message-debug-item';
                            item.textContent = `â€¢ ${JSON.stringify(f).slice(0, 100)}...`;
                            factsDiv.appendChild(item);
                        });

                        contentDiv.appendChild(factsDiv);
                    }

                    if (debugData.memories_used && debugData.memories_used.length > 0) {
                        const memsDiv = document.createElement('div');
                        memsDiv.className = 'chat-message-debug';

                        const memsTitle = document.createElement('div');
                        memsTitle.className = 'chat-message-debug-title';
                        memsTitle.textContent = `Memories Used (${debugData.memories_used.length})`;
                        memsDiv.appendChild(memsTitle);

                        debugData.memories_used.slice(0, 3).forEach(m => {
                            const item = document.createElement('div');
                            item.className = 'chat-message-debug-item';
                            item.textContent = `â€¢ ${m.content || JSON.stringify(m).slice(0, 100)}`;
                            memsDiv.appendChild(item);
                        });

                        contentDiv.appendChild(memsDiv);
                    }
                } catch (error) {
                    console.error('Error adding debug data:', error);
                }
            }

            // Add processing details toggle button (only if not already added)
            const existingToggle = element ? element.querySelector('.processing-details-toggle') : null;
            if (!existingToggle) {
                try {
                    if (!contentDiv) {
                        console.error('contentDiv is null when trying to add toggle button');
                        return;
                    }

                    const toggleDiv = document.createElement('div');
                    if (!toggleDiv) {
                        console.error('Failed to create toggleDiv');
                        return;
                    }

                    toggleDiv.className = 'processing-details-toggle';
                    toggleDiv.style.cssText = 'margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--color-border); cursor: pointer;';
                    toggleDiv.onclick = () => toggleProcessingDetails(id);

                    const toggleContent = document.createElement('span');
                    toggleContent.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-text-tertiary);';

                    const checkSpan = document.createElement('span');
                    checkSpan.style.color = 'var(--color-success)';
                    checkSpan.textContent = 'âœ“';

                    const textSpan = document.createElement('span');
                    textSpan.textContent = 'Processing Details';

                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'toggle-icon';
                    iconSpan.id = `${id}-toggle`;
                    iconSpan.textContent = 'â–¼';

                    if (toggleContent && checkSpan && textSpan && iconSpan) {
                        toggleContent.appendChild(checkSpan);
                        toggleContent.appendChild(textSpan);
                        toggleContent.appendChild(iconSpan);
                        toggleDiv.appendChild(toggleContent);
                        contentDiv.appendChild(toggleDiv);
                    } else {
                        console.error('Failed to create toggle button children');
                    }
                } catch (error) {
                    console.error('Error adding toggle button:', error, error.stack);
                }
            }

            // Re-add processing steps at the bottom (collapsed)
            if (stepsContainer) {
                try {
                    stepsContainer.classList.add('collapsed');
                    contentDiv.appendChild(stepsContainer);
                } catch (error) {
                    console.error('Error re-adding steps container:', error);
                }
            }
        }

        function toggleProcessingDetails(id) {
            const element = document.getElementById(id);
            if (element) {
                const stepsContainer = element.querySelector('.processing-steps');
                const toggleIcon = document.getElementById(`${id}-toggle`);

                if (stepsContainer) {
                    stepsContainer.classList.toggle('collapsed');
                    if (toggleIcon) {
                        toggleIcon.textContent = stepsContainer.classList.contains('collapsed') ? 'â–¼' : 'â–²';
                    }
                }
            }
        }

        function addChatMessage(role, content, debug = null) {
            const container = document.getElementById('chatMessages');

            // Remove suggestions or empty state when first message is added (without innerHTML)
            const suggestions = container.querySelector('.chat-suggestions');
            const emptyState = container.querySelector('.empty-state');
            if (suggestions) suggestions.remove();
            if (emptyState) emptyState.remove();

            const avatar = role === 'user' ? 'U' : 'A';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Create message structure
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            // Create avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-message-avatar';
            avatarDiv.textContent = avatar;

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create role header with timestamp
            const roleDiv = document.createElement('div');
            roleDiv.className = 'chat-message-role';
            roleDiv.textContent = role + ' ';

            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'chat-message-timestamp';
            timestampSpan.textContent = timestamp;
            roleDiv.appendChild(timestampSpan);

            // Create message text
            const textDiv = document.createElement('div');
            textDiv.className = 'chat-message-text';
            textDiv.textContent = content;

            // Add to content
            contentDiv.appendChild(roleDiv);
            contentDiv.appendChild(textDiv);

            // Add debug sections if present (using DOM methods)
            if (debug) {
                if (debug.domain_facts && debug.domain_facts.length > 0) {
                    const debugDiv = document.createElement('div');
                    debugDiv.className = 'chat-message-debug';

                    const title = document.createElement('div');
                    title.className = 'chat-message-debug-title';
                    title.textContent = `Domain Facts (${debug.domain_facts.length})`;
                    debugDiv.appendChild(title);

                    debug.domain_facts.slice(0, 3).forEach(f => {
                        const item = document.createElement('div');
                        item.className = 'chat-message-debug-item';
                        item.textContent = `â€¢ ${JSON.stringify(f).slice(0, 100)}...`;
                        debugDiv.appendChild(item);
                    });

                    contentDiv.appendChild(debugDiv);
                }

                if (debug.memories_used && debug.memories_used.length > 0) {
                    const debugDiv = document.createElement('div');
                    debugDiv.className = 'chat-message-debug';

                    const title = document.createElement('div');
                    title.className = 'chat-message-debug-title';
                    title.textContent = `Memories Used (${debug.memories_used.length})`;
                    debugDiv.appendChild(title);

                    debug.memories_used.slice(0, 3).forEach(m => {
                        const item = document.createElement('div');
                        item.className = 'chat-message-debug-item';
                        item.textContent = `â€¢ ${m.content || JSON.stringify(m).slice(0, 100)}`;
                        debugDiv.appendChild(item);
                    });

                    contentDiv.appendChild(debugDiv);
                }
            }

            // Assemble structure
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);

            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ============================================
        // HEADER STATS UPDATE
        // ============================================

        async function updateHeaderStats() {
            try {
                const [dbStats, memStats] = await Promise.all([
                    fetch('/api/v1/demo/database/stats').then(r => r.json()),
                    fetch('/api/v1/demo/memories/stats').then(r => r.json())
                ]);

                const totalDb = Object.values(dbStats).reduce((sum, val) => sum + val, 0);
                const totalMem = Object.values(memStats).reduce((sum, val) => sum + val, 0);

                document.getElementById('totalDbRecords').textContent = totalDb;
                document.getElementById('totalMemories').textContent = totalMem;

                databaseStatsData = dbStats;
                memoryStatsData = memStats;

                // Update architecture diagram counts
                updateArchitectureCounts();

                if (currentTab === 'database') {
                    renderDatabaseStats();
                } else if (currentTab === 'memory') {
                    renderMemoryStats();
                    loadMemoryLayers();
                }
            } catch (error) {
                console.error('Failed to update header stats:', error);
            }
        }

        // ============================================
        // ALERTS
        // ============================================

        function showGlobalSuccess(message) {
            const alert = document.getElementById('globalAlert');
            if (!alert) {
                console.warn('globalAlert element not found');
                return;
            }
            alert.innerHTML = `<div class="alert alert-success">${message}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 5000);
        }

        function showGlobalError(title, message) {
            const alert = document.getElementById('globalAlert');
            if (!alert) {
                console.warn('globalAlert element not found');
                return;
            }
            alert.innerHTML = `<div class="alert alert-error"><strong>${title}:</strong> ${message}</div>`;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            await loadScenarios();
            await updateHeaderStats();
            startActivityPolling();
        }

        init();
    </script>
</body>
</html>
