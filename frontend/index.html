<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory System Demo • 6-Layer Architecture</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%233B82F6'/><stop offset='100%' style='stop-color:%238B5CF6'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='system-ui' font-weight='700'>M</text></svg>">
    <style>
        /* ============================================
           MODERN DESIGN SYSTEM - BALANCED & COLORFUL
           ============================================ */

        :root {
            /* Background Colors - Depth */
            --color-bg: #0A0E1A;
            --color-bg-secondary: #0F1419;
            --color-surface: #161B26;
            --color-surface-elevated: #1C2433;
            --color-surface-hover: #242B3D;

            /* Borders */
            --color-border: rgba(255, 255, 255, 0.06);
            --color-border-hover: rgba(255, 255, 255, 0.12);

            /* Accent Colors - Vibrant */
            --color-primary: #3B82F6;
            --color-primary-dark: #2563EB;
            --color-primary-light: #60A5FA;

            --color-success: #10B981;
            --color-success-dark: #059669;

            --color-warning: #F59E0B;
            --color-danger: #EF4444;

            --color-purple: #8B5CF6;
            --color-pink: #EC4899;
            --color-teal: #14B8A6;
            --color-indigo: #6366F1;
            --color-orange: #F97316;

            /* Text Colors */
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-text-tertiary: #6B7280;

            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;

            --text-xs: 11px;
            --text-sm: 13px;
            --text-base: 14px;
            --text-lg: 16px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);

            /* Transitions */
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            color: var(--color-text-primary);
            background: var(--color-bg);
            overflow-x: hidden;
        }

        /* ============================================
           HEADER - SPACIOUS & MODERN
           ============================================ */

        .header {
            background: linear-gradient(180deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-6) var(--space-8);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-purple));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: var(--shadow-md);
        }

        .header-info h1 {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }

        .header-info p {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        .header-stats {
            display: flex;
            gap: var(--space-8);
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .header-stat-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            font-family: var(--font-mono);
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           NAVIGATION - MODERN TABS
           ============================================ */

        .nav {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: 0 var(--space-8);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-2);
        }

        .nav-tab {
            padding: var(--space-4) var(--space-5);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: var(--font-sans);
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-tab.active {
            color: var(--color-primary-light);
            border-bottom-color: var(--color-primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-purple));
            border-radius: 2px 2px 0 0;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           CARDS - ELEVATED WITH CHARACTER
           ============================================ */

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .card:hover {
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        /* ============================================
           SCENARIO CARDS - COLORFUL & ENGAGING
           ============================================ */

        .scenario-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .scenario-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--scenario-color, var(--color-primary)), transparent);
            opacity: 0.6;
        }

        .scenario-number {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            width: 28px;
            height: 28px;
            background: var(--scenario-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            color: white;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }

        .scenario-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .scenario-card.category-financial { --scenario-color: var(--color-success); }
        .scenario-card.category-operational { --scenario-color: var(--color-primary); }
        .scenario-card.category-entity { --scenario-color: var(--color-purple); }
        .scenario-card.category-memory { --scenario-color: var(--color-pink); }
        .scenario-card.category-conflict { --scenario-color: var(--color-orange); }
        .scenario-card.category-intelligence { --scenario-color: var(--color-indigo); }

        .scenario-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
            padding-left: 40px;
        }

        .scenario-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .scenario-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin-bottom: var(--space-3);
        }

        .scenario-meta {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            padding-left: 40px;
        }

        .scenario-category {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .scenario-details {
            margin-top: var(--space-4);
            padding: var(--space-4);
            padding-left: 40px;
            background: var(--color-bg);
            border-top: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            display: none;
        }

        .scenario-details.expanded {
            display: block;
        }

        .scenario-details-section {
            margin-bottom: var(--space-4);
        }

        .scenario-details-section:last-child {
            margin-bottom: 0;
        }

        .scenario-details-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .scenario-details-content {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            background: var(--color-surface);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .btn-details {
            margin-top: var(--space-3);
            margin-left: 40px;
            font-size: var(--text-xs);
            padding: 4px var(--space-3);
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
        }

        .btn-details:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--color-text-primary);
        }

        /* ============================================
           BUTTONS - MODERN WITH GRADIENTS
           ============================================ */

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
            font-family: var(--font-sans);
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-primary));
            box-shadow: var(--shadow-lg), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger), #DC2626);
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-sm {
            padding: 4px var(--space-3);
            font-size: var(--text-xs);
        }

        /* ============================================
           BADGES - COLORFUL
           ============================================ */

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 500;
            font-family: var(--font-mono);
        }

        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-primary-light);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-purple);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge-pink {
            background: rgba(236, 72, 153, 0.15);
            color: var(--color-pink);
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .badge-teal {
            background: rgba(20, 184, 166, 0.15);
            color: var(--color-teal);
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        /* ============================================
           STAT CARDS - COMPACT & MODERN
           ============================================ */

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            position: relative;
            overflow: hidden;
            transition: all var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stat-color, var(--color-primary)), transparent);
        }

        .stat-card:hover {
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .stat-card-title {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--color-text-primary);
            font-family: var(--font-mono);
        }

        /* ============================================
           MEMORY LAYER CARDS - COLORFUL
           ============================================ */

        .layer-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .layer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: var(--layer-color);
            opacity: 0.8;
        }

        .layer-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .layer-card.layer-1 { --layer-color: var(--color-teal); }
        .layer-card.layer-2 { --layer-color: var(--color-primary); }
        .layer-card.layer-3 { --layer-color: var(--color-purple); }
        .layer-card.layer-4 { --layer-color: var(--color-success); }
        .layer-card.layer-5 { --layer-color: var(--color-warning); }
        .layer-card.layer-6 { --layer-color: var(--color-pink); }

        .layer-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .layer-card-number {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .layer-card-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .layer-card-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        /* ============================================
           TABLES - MODERN
           ============================================ */

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }

        thead {
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background var(--transition);
        }

        tbody tr:hover {
            background: var(--color-surface-elevated);
        }

        /* ============================================
           CHAT INTERFACE - MODERN & ENGAGING
           ============================================ */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-5) 0;
            margin-bottom: var(--space-4);
        }

        .chat-message {
            margin-bottom: var(--space-5);
            display: flex;
            gap: var(--space-3);
        }

        .chat-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-message.user .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
        }

        .chat-message.assistant .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-success), var(--color-teal));
            color: white;
        }

        .chat-message-content {
            flex: 1;
            padding: var(--space-2) 0;
        }

        .chat-message.user .chat-message-content {
            /* No special background - seamless flow */
        }

        .chat-message-role {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
        }

        .chat-message-text {
            color: var(--color-text-primary);
            line-height: 1.6;
            white-space: pre-wrap;  /* Preserve line breaks and formatting */
        }

        .chat-message-debug {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .chat-message-debug-title {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
        }

        .chat-message-debug-item {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .chat-input-container {
            display: flex;
            gap: var(--space-3);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            font-family: var(--font-sans);
            transition: all var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* ============================================
           GRID LAYOUTS
           ============================================ */

        .grid {
            display: grid;
            gap: var(--space-4);
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .grid-stats {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }

        /* ============================================
           UTILITIES
           ============================================ */

        .loading {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-secondary);
        }

        .spinner {
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            font-size: var(--text-sm);
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--color-danger);
        }

        .text-mono {
            font-family: var(--font-mono);
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mb-4 { margin-bottom: var(--space-4); }
        .mb-5 { margin-bottom: var(--space-5); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }

        /* ============================================
           SCROLLBAR
           ============================================ */

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-hover);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-brand">
                <div class="header-logo">M</div>
                <div class="header-info">
                    <h1>Memory System Architecture</h1>
                    <p>6-Layer Memory • Domain Integration • Semantic Extraction</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Database Records</div>
                    <div class="header-stat-value" id="totalDbRecords">0</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Memory Entries</div>
                    <div class="header-stat-value" id="totalMemories">0</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-tab active" onclick="showTab('scenarios')">Scenarios</button>
            <button class="nav-tab" onclick="showTab('database')">Domain Database</button>
            <button class="nav-tab" onclick="showTab('memory')">Memory Layers</button>
            <button class="nav-tab" onclick="showTab('chat')">Chat Interface</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div id="globalAlert"></div>

        <!-- Tab: Scenarios -->
        <div id="tab-scenarios" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Demo Scenarios</div>
                        <div class="card-subtitle">Load test data to explore system capabilities</div>
                    </div>
                    <button class="btn btn-danger" onclick="resetAllData()">Reset All Data</button>
                </div>
                <div id="scenariosList" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Database -->
        <div id="tab-database" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Domain Database Statistics</div>
                <div id="databaseStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Database Tables</div>
                <div id="databaseTables" class="mt-5"></div>
            </div>
        </div>

        <!-- Tab: Memory -->
        <div id="tab-memory" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Memory Layer Statistics</div>
                <div id="memoryStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Memory Layers</div>
                <div class="card-subtitle">Click a layer to view detailed data</div>
                <div id="memoryLayers" class="grid grid-2 mt-5"></div>
            </div>
            <div id="memoryDetail" class="mt-5"></div>
        </div>

        <!-- Tab: Chat -->
        <div id="tab-chat" class="tab-content">
            <div style="display: flex; justify-content: flex-end; margin-bottom: var(--space-4);">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--color-text-secondary); cursor: pointer;">
                    <input type="checkbox" id="debugMode" checked style="cursor: pointer;">
                    Debug Mode
                </label>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">Start a conversation to see memory system in action</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================

        let currentTab = 'scenarios';
        let scenariosData = [];
        let databaseStatsData = {};
        let memoryStatsData = {};

        // Category mapping for colors
        const categoryMap = {
            'Financial': 'financial',
            'Operational': 'operational',
            'Entity Resolution': 'entity',
            'Memory Extraction': 'memory',
            'Conflict Resolution': 'conflict',
            'Intelligence': 'intelligence'
        };

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function showTab(tabName) {
            currentTab = tabName;

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Find and activate the corresponding nav tab button
            const navButtons = document.querySelectorAll('.nav-tab');
            const targetNavButton = Array.from(navButtons).find(btn =>
                btn.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            if (targetNavButton) {
                targetNavButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'database') {
                loadDatabaseTab();
            } else if (tabName === 'memory') {
                loadMemoryTab();
            }
        }

        // ============================================
        // SCENARIOS TAB
        // ============================================

        async function loadScenarios() {
            try {
                const response = await fetch('/api/v1/demo/scenarios');
                scenariosData = await response.json();
                renderScenarios();
            } catch (error) {
                document.getElementById('scenariosList').innerHTML = `
                    <div class="alert alert-error">Failed to load scenarios: ${error.message}</div>
                `;
            }
        }

        function renderScenarios() {
            const html = scenariosData.map((scenario, index) => {
                const categoryClass = categoryMap[scenario.category] || 'intelligence';
                const scenarioNumber = index + 1;

                return `
                    <div class="scenario-card category-${categoryClass}">
                        <div class="scenario-number">${scenarioNumber}</div>
                        <div class="scenario-header">
                            <div style="flex: 1;">
                                <div class="scenario-title">${scenario.title}</div>
                                <div class="scenario-description">${scenario.description}</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadScenario(${scenario.scenario_id})">
                                Load
                            </button>
                        </div>
                        <div class="scenario-meta">
                            <span class="scenario-category">${scenario.category}</span>
                            ${scenario.data_requirements ? `<span>${scenario.data_requirements.length} data sources</span>` : ''}
                        </div>
                        <button class="btn btn-details" onclick="toggleScenarioDetails(${scenario.scenario_id})">
                            <span id="toggle-icon-${scenario.scenario_id}">▼</span> Show Details
                        </button>
                        <div class="scenario-details" id="scenario-details-${scenario.scenario_id}"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('scenariosList').innerHTML = html;
        }

        async function toggleScenarioDetails(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            const icon = document.getElementById(`toggle-icon-${scenarioId}`);
            const button = event.target.closest('button');

            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.textContent = '▼';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">▼</span> Show Details`;
            } else {
                // Load actual data if not already loaded
                if (!details.dataset.loaded) {
                    await loadScenarioData(scenarioId);
                }
                details.classList.add('expanded');
                icon.textContent = '▲';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">▲</span> Hide Details`;
            }
        }

        async function loadScenarioData(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            details.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`/api/v1/demo/scenarios/${scenarioId}/data`);
                const data = await response.json();

                // Build sections
                let html = '';

                // Database Records
                html += '<div class="scenario-details-section">';
                html += '<div class="scenario-details-title"><span class="badge badge-primary">Database Records</span></div>';

                let dbContent = '';
                if (data.customers.length > 0) {
                    dbContent += '<strong>Customers:</strong>\n';
                    data.customers.forEach(c => {
                        dbContent += `  • ${c.name} (${c.industry})\n`;
                    });
                    dbContent += '\n';
                }
                if (data.sales_orders.length > 0) {
                    dbContent += '<strong>Sales Orders:</strong>\n';
                    data.sales_orders.forEach(so => {
                        dbContent += `  • ${so.so_number}: ${so.title} [${so.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.invoices.length > 0) {
                    dbContent += '<strong>Invoices:</strong>\n';
                    data.invoices.forEach(inv => {
                        dbContent += `  • ${inv.invoice_number}: $${inv.amount} due ${inv.due_date} [${inv.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.work_orders.length > 0) {
                    dbContent += '<strong>Work Orders:</strong>\n';
                    data.work_orders.forEach(wo => {
                        dbContent += `  • ${wo.description} - ${wo.technician} [${wo.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.payments.length > 0) {
                    dbContent += '<strong>Payments:</strong>\n';
                    data.payments.forEach(pay => {
                        dbContent += `  • ${pay.invoice_number}: $${pay.amount} via ${pay.method}\n`;
                    });
                    dbContent += '\n';
                }
                if (data.tasks.length > 0) {
                    dbContent += '<strong>Tasks:</strong>\n';
                    data.tasks.forEach(task => {
                        dbContent += `  • ${task.title} [${task.status}]\n`;
                    });
                }

                html += `<div class="scenario-details-content">${dbContent || 'No database records'}</div>`;
                html += '</div>';

                // Memory Entries
                if (data.semantic_memories.length > 0) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-success">Semantic Memories</span></div>';

                    let memContent = '';
                    data.semantic_memories.forEach(mem => {
                        const objValue = typeof mem.object_value === 'object'
                            ? JSON.stringify(mem.object_value)
                            : mem.object_value;
                        memContent += `• ${mem.subject} → ${mem.predicate}: ${objValue} (confidence: ${(mem.confidence * 100).toFixed(0)}%)\n`;
                    });

                    html += `<div class="scenario-details-content">${memContent}</div>`;
                    html += '</div>';
                }

                // Expected Behavior
                const scenario = scenariosData.find(s => s.scenario_id === scenarioId);
                if (scenario && scenario.expected_behavior) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-purple">Expected Behavior</span></div>';
                    html += `<div class="scenario-details-content">${scenario.expected_behavior}</div>`;
                    html += '</div>';
                }

                // Example Query
                if (scenario && scenario.expected_query) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title" style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span class="badge badge-pink">Example Query</span>';
                    html += `<button class="btn btn-primary btn-sm" onclick="tryQuery('${scenario.expected_query.replace(/'/g, "\\'")}')">Try Query →</button>`;
                    html += '</div>';
                    html += `<div class="scenario-details-content">${scenario.expected_query}</div>`;
                    html += '</div>';
                }

                details.innerHTML = html;
                details.dataset.loaded = 'true';
            } catch (error) {
                details.innerHTML = `<div class="alert alert-error">Failed to load scenario data: ${error.message}</div>`;
            }
        }

        async function loadScenario(scenarioId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                await fetch(`/api/v1/demo/scenarios/${scenarioId}/load`, { method: 'POST' });
                showGlobalSuccess(`Scenario ${scenarioId} loaded successfully`);
                btn.textContent = 'Loaded';
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Load Failed', error.message);
                btn.disabled = false;
                btn.textContent = 'Load';
            }
        }

        async function resetAllData() {
            if (!confirm('This will delete all data. Continue?')) return;

            try {
                await fetch('/api/v1/demo/scenarios/reset', { method: 'POST' });
                showGlobalSuccess('All data reset successfully');
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Reset Failed', error.message);
            }
        }

        // ============================================
        // DATABASE TAB
        // ============================================

        async function loadDatabaseTab() {
            await loadDatabaseStats();
            await loadDatabaseTables();
        }

        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/v1/demo/database/stats');
                databaseStatsData = await response.json();
                renderDatabaseStats();
            } catch (error) {
                console.error('Failed to load database stats:', error);
            }
        }

        function renderDatabaseStats() {
            const stats = [
                { label: 'Customers', value: databaseStatsData.customers || 0, color: 'var(--color-primary)' },
                { label: 'Sales Orders', value: databaseStatsData.sales_orders || 0, color: 'var(--color-success)' },
                { label: 'Work Orders', value: databaseStatsData.work_orders || 0, color: 'var(--color-warning)' },
                { label: 'Invoices', value: databaseStatsData.invoices || 0, color: 'var(--color-purple)' },
                { label: 'Payments', value: databaseStatsData.payments || 0, color: 'var(--color-teal)' },
                { label: 'Tasks', value: databaseStatsData.tasks || 0, color: 'var(--color-pink)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            document.getElementById('databaseStats').innerHTML = html;
        }

        async function loadDatabaseTables() {
            const tables = [
                { name: 'customers', label: 'Customers', fields: ['customer_id', 'name', 'industry', 'size'] },
                { name: 'sales_orders', label: 'Sales Orders', fields: ['so_id', 'so_number', 'customer', 'status', 'title'] },
                { name: 'invoices', label: 'Invoices', fields: ['invoice_id', 'invoice_number', 'amount', 'due_date', 'status'] },
                { name: 'work_orders', label: 'Work Orders', fields: ['wo_id', 'description', 'technician', 'status'] },
                { name: 'payments', label: 'Payments', fields: ['payment_id', 'invoice', 'amount', 'method'] },
                { name: 'tasks', label: 'Tasks', fields: ['task_id', 'title', 'status', 'customer'] }
            ];

            const html = await Promise.all(tables.map(async table => {
                try {
                    const response = await fetch(`/api/v1/demo/database/${table.name}`);
                    const data = await response.json();

                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        ${table.fields.map(field => `<th>${field.replace(/_/g, ' ')}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="${table.fields.length}" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.slice(0, 10).map(row => `
                                        <tr>
                                            ${table.fields.map(field => {
                                                let value = row[field];
                                                if (field === 'status') {
                                                    const statusColors = {
                                                        'open': 'warning',
                                                        'closed': 'success',
                                                        'paid': 'success',
                                                        'pending': 'warning',
                                                        'overdue': 'danger',
                                                        'completed': 'success',
                                                        'in_progress': 'primary'
                                                    };
                                                    return `<td><span class="badge badge-${statusColors[value] || 'primary'}">${value}</span></td>`;
                                                }
                                                return `<td class="text-truncate" style="max-width: 200px;">${value || '-'}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${data.length > 10 ? `<div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--color-text-tertiary);">Showing 10 of ${data.length} records</div>` : ''}
                    `;

                    return `
                        <div class="card mb-5">
                            <div class="card-header">
                                <div class="card-title">${table.label}</div>
                                <span class="badge badge-primary">${data.length}</span>
                            </div>
                            ${tableHtml}
                        </div>
                    `;
                } catch (error) {
                    return `
                        <div class="card mb-5">
                            <div class="card-title">${table.label}</div>
                            <div class="alert alert-error">Failed to load</div>
                        </div>
                    `;
                }
            }));

            document.getElementById('databaseTables').innerHTML = html.join('');
        }

        // ============================================
        // MEMORY TAB
        // ============================================

        async function loadMemoryTab() {
            await loadMemoryStats();
            await loadMemoryLayers();
        }

        async function loadMemoryStats() {
            try {
                const response = await fetch('/api/v1/demo/memories/stats');
                memoryStatsData = await response.json();
                renderMemoryStats();
            } catch (error) {
                console.error('Failed to load memory stats:', error);
            }
        }

        function renderMemoryStats() {
            const stats = [
                { label: 'Chat Events', value: memoryStatsData.chat_events || 0, color: 'var(--color-teal)' },
                { label: 'Entities', value: memoryStatsData.canonical_entities || 0, color: 'var(--color-primary)' },
                { label: 'Aliases', value: memoryStatsData.entity_aliases || 0, color: 'var(--color-primary)' },
                { label: 'Episodic', value: memoryStatsData.episodic_memories || 0, color: 'var(--color-purple)' },
                { label: 'Semantic', value: memoryStatsData.semantic_memories || 0, color: 'var(--color-success)' },
                { label: 'Procedural', value: memoryStatsData.procedural_memories || 0, color: 'var(--color-warning)' },
                { label: 'Summaries', value: memoryStatsData.memory_summaries || 0, color: 'var(--color-pink)' },
                { label: 'Conflicts', value: memoryStatsData.memory_conflicts || 0, color: 'var(--color-danger)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            document.getElementById('memoryStats').innerHTML = html;
        }

        async function loadMemoryLayers() {
            const layers = [
                {
                    number: 1,
                    name: 'Raw Events',
                    key: 'chat_events',
                    description: 'Immutable conversation audit trail',
                    count: memoryStatsData.chat_events || 0,
                    endpoint: '/api/v1/demo/memories/chat_events'
                },
                {
                    number: 2,
                    name: 'Entity Resolution',
                    key: 'entities',
                    description: 'Canonical entities + aliases',
                    count: (memoryStatsData.canonical_entities || 0) + (memoryStatsData.entity_aliases || 0),
                    endpoint: null
                },
                {
                    number: 3,
                    name: 'Episodic Memories',
                    key: 'episodic',
                    description: 'Events with temporal context',
                    count: memoryStatsData.episodic_memories || 0,
                    endpoint: '/api/v1/demo/memories/episodic'
                },
                {
                    number: 4,
                    name: 'Semantic Memories',
                    key: 'semantic',
                    description: 'Fact triples with confidence',
                    count: memoryStatsData.semantic_memories || 0,
                    endpoint: '/api/v1/demo/memories/semantic'
                },
                {
                    number: 5,
                    name: 'Procedural Memories',
                    key: 'procedural',
                    description: 'Learned patterns & heuristics',
                    count: memoryStatsData.procedural_memories || 0,
                    endpoint: '/api/v1/demo/memories/procedural'
                },
                {
                    number: 6,
                    name: 'Summaries',
                    key: 'summaries',
                    description: 'Cross-session consolidation',
                    count: memoryStatsData.memory_summaries || 0,
                    endpoint: '/api/v1/demo/memories/summaries'
                }
            ];

            const html = layers.map(layer => `
                <div class="layer-card layer-${layer.number}" onclick="loadLayerDetail('${layer.key}', ${layer.endpoint ? `'${layer.endpoint}'` : null}, ${layer.number})">
                    <div class="layer-card-header">
                        <span class="layer-card-number">Layer ${layer.number}</span>
                        <span class="badge badge-primary">${layer.count}</span>
                    </div>
                    <div class="layer-card-title">${layer.name}</div>
                    <div class="layer-card-description">${layer.description}</div>
                </div>
            `).join('');

            document.getElementById('memoryLayers').innerHTML = html;
        }

        async function loadLayerDetail(key, endpoint, layerNumber) {
            const detailContainer = document.getElementById('memoryDetail');

            if (!endpoint && key === 'entities') {
                detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const [entitiesRes, aliasesRes] = await Promise.all([
                        fetch('/api/v1/demo/memories/entities'),
                        fetch('/api/v1/demo/memories/aliases')
                    ]);

                    const entities = await entitiesRes.json();
                    const aliases = await aliasesRes.json();

                    let html = `<div class="card">`;

                    if (entities.length > 0) {
                        html += `
                            <div class="card-title mb-4">Canonical Entities (${entities.length})</div>
                            <div class="table-container mb-5">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Entity ID</th>
                                            <th>Canonical Name</th>
                                            <th>Entity Type</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${entities.map(e => `
                                            <tr>
                                                <td class="text-mono">${e.entity_id}</td>
                                                <td>${e.canonical_name}</td>
                                                <td><span class="badge badge-primary">${e.entity_type}</span></td>
                                                <td>${new Date(e.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (aliases.length > 0) {
                        html += `
                            <div class="card-title mb-4">Entity Aliases (${aliases.length})</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Alias</th>
                                            <th>Entity ID</th>
                                            <th>Similarity</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${aliases.map(a => `
                                            <tr>
                                                <td>${a.alias_text}</td>
                                                <td class="text-mono">${a.entity_id}</td>
                                                <td><span class="badge badge-success">${(a.similarity_score * 100).toFixed(0)}%</span></td>
                                                <td>${new Date(a.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (entities.length === 0 && aliases.length === 0) {
                        html += '<div class="empty-state">No entity data</div>';
                    }

                    html += `</div>`;
                    detailContainer.innerHTML = html;
                } catch (error) {
                    detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
                }
                return;
            }

            if (!endpoint) {
                detailContainer.innerHTML = '';
                return;
            }

            detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                let html = `<div class="card"><div class="card-title mb-5">Layer ${layerNumber} Data (${data.length} records)</div>`;

                if (key === 'chat_events') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Event ID</th>
                                        <th>Role</th>
                                        <th>Content</th>
                                        <th>Session ID</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(e => `
                                        <tr>
                                            <td class="text-mono">${e.event_id}</td>
                                            <td><span class="badge badge-${e.role === 'user' ? 'primary' : 'success'}">${e.role}</span></td>
                                            <td class="text-truncate" style="max-width: 300px;">${e.content}</td>
                                            <td class="text-mono">${e.session_id.slice(0, 8)}...</td>
                                            <td>${new Date(e.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'semantic') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Predicate</th>
                                        <th>Object Value</th>
                                        <th>Confidence</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td class="text-mono text-truncate" style="max-width: 150px;">${m.subject_entity_id}</td>
                                            <td>${m.predicate}</td>
                                            <td class="text-truncate" style="max-width: 200px;">${JSON.stringify(m.object_value)}</td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                            <td><span class="badge badge-${m.status === 'active' ? 'success' : 'warning'}">${m.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'episodic') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Summary</th>
                                        <th>Event Type</th>
                                        <th>Importance</th>
                                        <th>Session</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td class="text-truncate" style="max-width: 300px;">${m.summary}</td>
                                            <td><span class="badge badge-primary">${m.event_type}</span></td>
                                            <td><span class="badge badge-warning">${m.importance.toFixed(2)}</span></td>
                                            <td class="text-mono">${m.session_id.slice(0, 8)}...</td>
                                            <td>${new Date(m.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'procedural') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Trigger Pattern</th>
                                        <th>Action Heuristic</th>
                                        <th>Observed</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td>${m.trigger_pattern}</td>
                                            <td>${m.action_heuristic}</td>
                                            <td><span class="badge badge-primary">${m.observed_count}</span></td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'summaries') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Scope</th>
                                        <th>Summary</th>
                                        <th>Confidence</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td><span class="badge badge-primary">${m.scope_type}</span></td>
                                            <td class="text-truncate" style="max-width: 400px;">${m.summary_text}</td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                            <td>${new Date(m.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                html += `</div>`;
                detailContainer.innerHTML = html;
            } catch (error) {
                detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
            }
        }

        // ============================================
        // CHAT TAB
        // ============================================

        let chatHistory = [];
        let currentSessionId = null;  // Track session for conversation continuity

        function tryQuery(query) {
            // Switch to chat tab
            showTab('chat');

            // Load query into input
            const input = document.getElementById('chatInput');
            input.value = query;

            // Focus input for user to review and send
            input.focus();

            // Scroll input into view
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            const debugMode = document.getElementById('debugMode').checked;

            addChatMessage('user', message);
            input.value = '';

            try {
                const requestBody = {
                    message: message,
                    user_id: 'demo-user',
                    debug: debugMode
                };

                // Include session_id if we have one (for conversation continuity)
                if (currentSessionId) {
                    requestBody.session_id = currentSessionId;
                }

                const response = await fetch('/api/v1/demo/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Store session_id from response for next message
                if (data.session_id) {
                    currentSessionId = data.session_id;
                }

                addChatMessage('assistant', data.reply, data.debug || data.traces);

            } catch (error) {
                addChatMessage('assistant', `Error: ${error.message}`);
            }
        }

        function addChatMessage(role, content, debug = null) {
            const container = document.getElementById('chatMessages');

            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            let debugHtml = '';
            if (debug) {
                const debugSections = [];

                if (debug.domain_facts) {
                    debugSections.push(`
                        <div class="chat-message-debug">
                            <div class="chat-message-debug-title">Domain Facts (${debug.domain_facts.length})</div>
                            ${debug.domain_facts.slice(0, 3).map(f => `<div class="chat-message-debug-item">• ${JSON.stringify(f).slice(0, 100)}...</div>`).join('')}
                        </div>
                    `);
                }

                if (debug.memories_used) {
                    debugSections.push(`
                        <div class="chat-message-debug">
                            <div class="chat-message-debug-title">Memories Used (${debug.memories_used.length})</div>
                            ${debug.memories_used.slice(0, 3).map(m => `<div class="chat-message-debug-item">• ${m.content || JSON.stringify(m).slice(0, 100)}</div>`).join('')}
                        </div>
                    `);
                }

                debugHtml = debugSections.join('');
            }

            const avatar = role === 'user' ? 'U' : 'A';
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = `
                <div class="chat-message-avatar">${avatar}</div>
                <div class="chat-message-content">
                    <div class="chat-message-role">${role}</div>
                    <div class="chat-message-text">${content}</div>
                    ${debugHtml}
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ============================================
        // HEADER STATS UPDATE
        // ============================================

        async function updateHeaderStats() {
            try {
                const [dbStats, memStats] = await Promise.all([
                    fetch('/api/v1/demo/database/stats').then(r => r.json()),
                    fetch('/api/v1/demo/memories/stats').then(r => r.json())
                ]);

                const totalDb = Object.values(dbStats).reduce((sum, val) => sum + val, 0);
                const totalMem = Object.values(memStats).reduce((sum, val) => sum + val, 0);

                document.getElementById('totalDbRecords').textContent = totalDb;
                document.getElementById('totalMemories').textContent = totalMem;

                databaseStatsData = dbStats;
                memoryStatsData = memStats;

                if (currentTab === 'database') {
                    renderDatabaseStats();
                } else if (currentTab === 'memory') {
                    renderMemoryStats();
                    loadMemoryLayers();
                }
            } catch (error) {
                console.error('Failed to update header stats:', error);
            }
        }

        // ============================================
        // ALERTS
        // ============================================

        function showGlobalSuccess(message) {
            const alert = document.getElementById('globalAlert');
            alert.innerHTML = `<div class="alert alert-success">${message}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 5000);
        }

        function showGlobalError(title, message) {
            const alert = document.getElementById('globalAlert');
            alert.innerHTML = `<div class="alert alert-error"><strong>${title}:</strong> ${message}</div>`;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            await loadScenarios();
            await updateHeaderStats();
        }

        init();
    </script>
</body>
</html>
