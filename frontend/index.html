<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory System Demo â€¢ 6-Layer Architecture</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%233B82F6'/><stop offset='100%' style='stop-color:%238B5CF6'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='system-ui' font-weight='700'>M</text></svg>">
    <style>
        /* ============================================
           MODERN DESIGN SYSTEM - BALANCED & COLORFUL
           ============================================ */

        :root {
            /* Background Colors - Depth */
            --color-bg: #0A0E1A;
            --color-bg-secondary: #0F1419;
            --color-surface: #161B26;
            --color-surface-elevated: #1C2433;
            --color-surface-hover: #242B3D;

            /* Borders */
            --color-border: rgba(255, 255, 255, 0.06);
            --color-border-hover: rgba(255, 255, 255, 0.12);

            /* Accent Colors - Vibrant */
            --color-primary: #3B82F6;
            --color-primary-dark: #2563EB;
            --color-primary-light: #60A5FA;

            --color-success: #10B981;
            --color-success-dark: #059669;

            --color-warning: #F59E0B;
            --color-danger: #EF4444;

            --color-purple: #8B5CF6;
            --color-pink: #EC4899;
            --color-teal: #14B8A6;
            --color-indigo: #6366F1;
            --color-orange: #F97316;

            /* Text Colors */
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-text-tertiary: #6B7280;

            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;

            --text-xs: 11px;
            --text-sm: 13px;
            --text-base: 14px;
            --text-lg: 16px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);

            /* Transitions */
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            color: var(--color-text-primary);
            background: var(--color-bg);
            overflow-x: hidden;
        }

        /* ============================================
           HEADER - SPACIOUS & MODERN
           ============================================ */

        .header {
            background: linear-gradient(180deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-6) var(--space-8);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-purple));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: var(--shadow-md);
        }

        .header-info h1 {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }

        .header-info p {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        .header-stats {
            display: flex;
            gap: var(--space-8);
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .header-stat-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            font-family: var(--font-mono);
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           NAVIGATION - MODERN TABS
           ============================================ */

        .nav {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: 0 var(--space-8);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-2);
        }

        .nav-tab {
            padding: var(--space-4) var(--space-5);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: var(--font-sans);
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-tab.active {
            color: var(--color-primary-light);
            border-bottom-color: var(--color-primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-purple));
            border-radius: 2px 2px 0 0;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           CARDS - ELEVATED WITH CHARACTER
           ============================================ */

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .card:hover {
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        /* ============================================
           SCENARIO CARDS - COLORFUL & ENGAGING
           ============================================ */

        .scenario-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .scenario-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--scenario-color, var(--color-primary)), transparent);
            opacity: 0.6;
        }

        .scenario-number {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            width: 28px;
            height: 28px;
            background: var(--scenario-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            color: white;
            box-shadow: var(--shadow-sm);
            z-index: 1;
        }

        .scenario-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .scenario-card.category-financial { --scenario-color: var(--color-success); }
        .scenario-card.category-operational { --scenario-color: var(--color-primary); }
        .scenario-card.category-entity { --scenario-color: var(--color-purple); }
        .scenario-card.category-memory { --scenario-color: var(--color-pink); }
        .scenario-card.category-conflict { --scenario-color: var(--color-orange); }
        .scenario-card.category-intelligence { --scenario-color: var(--color-indigo); }

        .scenario-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
            padding-left: 40px;
        }

        .scenario-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .scenario-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin-bottom: var(--space-3);
        }

        .scenario-meta {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            padding-left: 40px;
        }

        .scenario-category {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .scenario-details {
            margin-top: var(--space-4);
            padding: var(--space-4);
            padding-left: 40px;
            background: var(--color-bg);
            border-top: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            display: none;
        }

        .scenario-details.expanded {
            display: block;
        }

        .scenario-details-section {
            margin-bottom: var(--space-4);
        }

        .scenario-details-section:last-child {
            margin-bottom: 0;
        }

        .scenario-details-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .scenario-details-content {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            background: var(--color-surface);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .btn-details {
            margin-top: var(--space-3);
            margin-left: 40px;
            font-size: var(--text-xs);
            padding: 4px var(--space-3);
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
        }

        .btn-details:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--color-text-primary);
        }

        /* ============================================
           BUTTONS - MODERN WITH GRADIENTS
           ============================================ */

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
            font-family: var(--font-sans);
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-light), var(--color-primary));
            box-shadow: var(--shadow-lg), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger), #DC2626);
            border: none;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-sm {
            padding: 4px var(--space-3);
            font-size: var(--text-xs);
        }

        /* ============================================
           BADGES - COLORFUL
           ============================================ */

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 500;
            font-family: var(--font-mono);
        }

        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-primary-light);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-purple);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge-pink {
            background: rgba(236, 72, 153, 0.15);
            color: var(--color-pink);
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .badge-teal {
            background: rgba(20, 184, 166, 0.15);
            color: var(--color-teal);
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        /* ============================================
           STAT CARDS - COMPACT & MODERN
           ============================================ */

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            position: relative;
            overflow: hidden;
            transition: all var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stat-color, var(--color-primary)), transparent);
        }

        .stat-card:hover {
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .stat-card-title {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--color-text-primary);
            font-family: var(--font-mono);
        }

        /* ============================================
           MEMORY LAYER CARDS - COLORFUL
           ============================================ */

        .layer-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .layer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: var(--layer-color);
            opacity: 0.8;
        }

        .layer-card:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .layer-card.layer-1 { --layer-color: var(--color-teal); }
        .layer-card.layer-2 { --layer-color: var(--color-primary); }
        .layer-card.layer-3 { --layer-color: var(--color-purple); }
        .layer-card.layer-4 { --layer-color: var(--color-success); }
        .layer-card.layer-5 { --layer-color: var(--color-warning); }
        .layer-card.layer-6 { --layer-color: var(--color-pink); }

        .layer-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .layer-card-number {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .layer-card-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .layer-card-description {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        /* ============================================
           TABLES - MODERN
           ============================================ */

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }

        thead {
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background var(--transition);
        }

        tbody tr:hover {
            background: var(--color-surface-elevated);
        }

        /* ============================================
           CHAT INTERFACE - MODERN & ENGAGING
           ============================================ */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-5) 0;
            margin-bottom: var(--space-4);
        }

        .chat-message {
            margin-bottom: var(--space-5);
            display: flex;
            gap: var(--space-3);
        }

        .chat-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-message.user .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
        }

        .chat-message.assistant .chat-message-avatar {
            background: linear-gradient(135deg, var(--color-success), var(--color-teal));
            color: white;
        }

        .chat-message-content {
            flex: 1;
            padding: var(--space-2) 0;
        }

        .chat-message.user .chat-message-content {
            /* No special background - seamless flow */
        }

        .chat-message-role {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .chat-message-timestamp {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
            opacity: 0.6;
        }

        .chat-message-text {
            color: var(--color-text-primary);
            line-height: 1.6;
            white-space: pre-wrap;  /* Preserve line breaks and formatting */
        }

        .chat-message-debug {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .chat-message-debug-title {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
        }

        .chat-message-debug-item {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .chat-input-container {
            display: flex;
            gap: var(--space-3);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            font-family: var(--font-sans);
            transition: all var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: var(--space-2) 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-tertiary);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }

        /* Flow diagram styles */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-6) 0;
        }

        .flow-step {
            width: 100%;
            max-width: 800px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-2) 0;
        }

        .flow-step-orchestrator {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--color-primary);
        }

        .flow-step-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .flow-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            padding: 4px 12px;
            background: var(--color-primary);
            color: white;
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            border-radius: var(--radius-sm);
        }

        .flow-step-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .flow-step-content {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            line-height: 1.8;
        }

        .substep {
            padding: var(--space-2) 0;
            padding-left: var(--space-4);
            border-left: 2px solid rgba(59, 130, 246, 0.3);
            margin: var(--space-2) 0;
        }

        .substep strong {
            color: var(--color-primary-light);
        }

        .flow-arrow {
            font-size: 24px;
            color: var(--color-primary);
            margin: var(--space-2) 0;
            font-weight: bold;
        }

        /* Processing steps for real-time debug mode */
        .processing-steps {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-top: 0;
            padding: 6px;
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .processing-steps.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        .processing-step {
            display: flex;
            align-items: flex-start;
            gap: 4px;
            padding: 2px 4px;
            font-size: 11px;
            color: var(--color-text-secondary);
            transition: all 0.2s ease;
            line-height: 1.3;
        }

        .processing-step.completed {
            color: var(--color-text-primary);
        }

        .processing-step.completed .processing-step-icon {
            color: var(--color-success);
        }

        .processing-step-icon {
            font-size: 14px;
            min-width: 16px;
            text-align: center;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .processing-step-text {
            flex: 1;
            line-height: 1.4;
        }

        .processing-step-details {
            font-size: 9px;
            color: var(--color-text-tertiary);
            margin-top: 1px;
            opacity: 0.8;
        }

        .toggle-icon {
            font-size: 12px;
            transition: transform 0.2s;
            user-select: none;
        }

        .processing-step-text {
            flex: 1;
        }

        /* Chat suggestions */
        .chat-suggestions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            padding: var(--space-10) var(--space-5);
            max-width: 600px;
            margin: 0 auto;
        }

        .chat-suggestions-title {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-2);
        }

        .suggestion-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .suggestion-card:hover {
            border-color: var(--color-primary);
            background: var(--color-surface-elevated);
            transform: translateX(4px);
        }

        .suggestion-card-icon {
            font-size: 18px;
            opacity: 0.7;
        }

        .suggestion-card-text {
            flex: 1;
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        /* ============================================
           ARCHITECTURE DIAGRAM - INTERACTIVE
           ============================================ */

        .architecture-panel {
            background: linear-gradient(180deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-bottom: 1px solid var(--color-border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .architecture-panel.collapsed {
            max-height: 0;
            border-bottom: none;
        }

        .architecture-panel.expanded {
            max-height: 300px;
        }

        .architecture-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6) var(--space-8);
        }

        .architecture-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .architecture-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .architecture-toggle {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--space-2);
            transition: color var(--transition);
        }

        .architecture-toggle:hover {
            color: var(--color-primary);
        }

        .architecture-layers {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-4);
            position: relative;
        }

        .layer-box {
            background: var(--color-surface-elevated);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .layer-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--layer-accent);
            opacity: 0.8;
        }

        .layer-box:hover {
            border-color: var(--layer-accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .layer-box.active {
            border-color: var(--layer-accent);
            background: var(--color-surface-hover);
            box-shadow: 0 0 20px rgba(var(--layer-accent-rgb), 0.3);
        }

        .layer-box.layer-0 { --layer-accent: var(--color-indigo); --layer-accent-rgb: 99, 102, 241; }
        .layer-box.layer-1 { --layer-accent: var(--color-teal); --layer-accent-rgb: 20, 184, 166; }
        .layer-box.layer-2 { --layer-accent: var(--color-primary); --layer-accent-rgb: 59, 130, 246; }
        .layer-box.layer-3 { --layer-accent: var(--color-purple); --layer-accent-rgb: 139, 92, 246; }
        .layer-box.layer-4 { --layer-accent: var(--color-success); --layer-accent-rgb: 16, 185, 129; }
        .layer-box.layer-5 { --layer-accent: var(--color-warning); --layer-accent-rgb: 245, 158, 11; }

        .layer-number {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            margin-bottom: var(--space-1);
        }

        .layer-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            line-height: 1.3;
        }

        .layer-count {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--layer-accent);
            font-family: var(--font-mono);
            margin-bottom: var(--space-1);
        }

        .layer-description {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            line-height: 1.4;
        }

        .layer-arrow {
            position: absolute;
            top: 50%;
            right: -16px;
            transform: translateY(-50%);
            font-size: 24px;
            color: var(--color-text-tertiary);
            opacity: 0.5;
            z-index: 1;
            pointer-events: none;
        }

        @keyframes flowPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .layer-box.processing {
            animation: flowPulse 2s ease-in-out infinite;
        }

        .architecture-toggle-btn {
            position: fixed;
            top: 180px;
            right: var(--space-8);
            z-index: 99;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: var(--shadow-md);
        }

        .architecture-toggle-btn:hover {
            background: var(--color-surface-hover);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }

        /* ============================================
           ACTIVITY FEED - LIVE SYSTEM MONITORING
           ============================================ */

        .activity-feed {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 380px;
            max-height: 400px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-bottom: none;
            border-right: none;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: var(--shadow-xl);
            z-index: 98;
            display: flex;
            flex-direction: column;
            transition: all var(--transition);
        }

        .activity-feed.collapsed {
            max-height: 48px;
        }

        .activity-feed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            cursor: pointer;
            user-select: none;
        }

        .activity-feed-header:hover {
            background: var(--color-surface-hover);
        }

        .activity-feed-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .activity-feed-live-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .activity-feed-count {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
        }

        .activity-feed-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-2);
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all var(--transition);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-item:hover {
            background: var(--color-surface);
            border-color: var(--color-border-hover);
        }

        .activity-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.database-query {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-indigo);
        }

        .activity-icon.memory-retrieval {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
        }

        .activity-icon.llm-call {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-purple);
        }

        .activity-icon.entity-resolution {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-primary);
        }

        .activity-icon.reasoning-step {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .activity-icon.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .activity-body {
            flex: 1;
            min-width: 0;
        }

        .activity-summary {
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .activity-time {
            font-family: var(--font-mono);
        }

        .activity-duration {
            padding: 2px var(--space-2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
        }

        .activity-empty {
            padding: var(--space-10);
            text-align: center;
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        /* ============================================
           CHAT REASONING PANE (SPLIT VIEW)
           ============================================ */

        .chat-container.split-view {
            display: grid;
            grid-template-columns: 1fr 0.538fr; /* 65/35 split */
            grid-template-rows: 1fr auto;
            gap: var(--space-4);
        }

        .chat-container.split-view .chat-messages {
            grid-column: 1;
            grid-row: 1;
        }

        .chat-container.split-view .chat-input-container {
            grid-column: 1;
            grid-row: 2;
        }

        .reasoning-pane {
            grid-column: 2;
            grid-row: 1 / 3; /* Span both rows */
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .reasoning-pane-header {
            padding: var(--space-4);
            background: linear-gradient(180deg, var(--color-surface-elevated) 0%, var(--color-surface) 100%);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .reasoning-pane-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .reasoning-pane-close {
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all var(--transition);
            font-size: var(--text-base);
            line-height: 1;
        }

        .reasoning-pane-close:hover {
            background: var(--color-bg);
            color: var(--color-text-primary);
        }

        .reasoning-pane-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }

        .reasoning-toggle-btn {
            position: fixed;
            top: 240px;
            right: var(--space-8);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            box-shadow: var(--shadow-lg);
            z-index: 99;
            transition: all var(--transition);
        }

        .reasoning-toggle-btn:hover {
            background: var(--color-surface-elevated);
            border-color: var(--color-border-hover);
            box-shadow: var(--shadow-xl);
        }

        .reasoning-toggle-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Reasoning Steps - Timeline Design */
        .reasoning-timeline {
            position: relative;
            padding-left: var(--space-6);
        }

        .reasoning-timeline::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-border);
        }

        .reasoning-step {
            position: relative;
            margin-bottom: var(--space-5);
            animation: slideInRight 0.3s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .reasoning-step-marker {
            position: absolute;
            left: -29px;
            top: 2px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: var(--step-bg);
            color: var(--step-color);
            border: 2px solid var(--color-surface);
            box-shadow: 0 0 0 2px var(--step-bg);
        }

        .reasoning-step.database-query {
            --step-bg: rgba(99, 102, 241, 0.15);
            --step-color: var(--color-indigo);
        }

        .reasoning-step.memory-retrieval {
            --step-bg: rgba(16, 185, 129, 0.15);
            --step-color: var(--color-success);
        }

        .reasoning-step.reasoning {
            --step-bg: rgba(139, 92, 246, 0.15);
            --step-color: var(--color-purple);
        }

        .reasoning-step.llm-generation {
            --step-bg: rgba(245, 158, 11, 0.15);
            --step-color: var(--color-warning);
        }

        .reasoning-step-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
        }

        .reasoning-step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .reasoning-step-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .reasoning-step-duration {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
        }

        .reasoning-step-description {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }

        .reasoning-step-details {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            font-family: var(--font-mono);
            background: var(--color-surface);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            margin-top: var(--space-2);
        }

        .reasoning-empty {
            padding: var(--space-10) var(--space-4);
            text-align: center;
            color: var(--color-text-tertiary);
        }

        .reasoning-empty-icon {
            font-size: 48px;
            margin-bottom: var(--space-3);
            opacity: 0.3;
        }

        .reasoning-empty-text {
            font-size: var(--text-sm);
        }

        /* ============================================
           GRID LAYOUTS
           ============================================ */

        .grid {
            display: grid;
            gap: var(--space-4);
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .grid-stats {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }

        /* ============================================
           UTILITIES
           ============================================ */

        .loading {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-secondary);
        }

        .spinner {
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            font-size: var(--text-sm);
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--color-danger);
        }

        .text-mono {
            font-family: var(--font-mono);
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mb-4 { margin-bottom: var(--space-4); }
        .mb-5 { margin-bottom: var(--space-5); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }

        /* ============================================
           SCROLLBAR
           ============================================ */

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-hover);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-brand">
                <div class="header-logo">M</div>
                <div class="header-info">
                    <h1>Memory System Architecture</h1>
                    <p>6-Layer Memory â€¢ Domain Integration â€¢ Semantic Extraction</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Database Records</div>
                    <div class="header-stat-value" id="totalDbRecords">0</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Memory Entries</div>
                    <div class="header-stat-value" id="totalMemories">0</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-tab active" onclick="showTab('scenarios')">Scenarios</button>
            <button class="nav-tab" onclick="showTab('architecture')">Architecture</button>
            <button class="nav-tab" onclick="showTab('database')">Domain Database</button>
            <button class="nav-tab" onclick="showTab('memory')">Memory Layers</button>
            <button class="nav-tab" onclick="showTab('chat')">Chat Interface</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div id="globalAlert"></div>

        <!-- Tab: Scenarios -->
        <div id="tab-scenarios" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Demo Scenarios</div>
                        <div class="card-subtitle">Load test data to explore system capabilities</div>
                    </div>
                    <div style="display: flex; gap: var(--space-2);">
                        <button class="btn btn-secondary" onclick="clearMemoriesOnly()">Clear Memories</button>
                        <button class="btn btn-danger" onclick="resetAllData()">Reset All Data</button>
                    </div>
                </div>
                <div id="scenariosList" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Architecture -->
        <div id="tab-architecture" class="tab-content">
            <div class="card">
                <div class="card-title">System Flow: End-to-End Request Processing</div>
                <div class="card-subtitle">Complete technical breakdown of the 7-step pipeline â€¢ Total latency: 200-800ms</div>

                <div class="flow-diagram">
                    <!-- Client Request -->
                    <div class="flow-step">
                        <div class="flow-step-header">
                            <span class="flow-step-number">START</span>
                            <span class="flow-step-title">Client Request</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Endpoint:</strong> POST /api/v1/chat<br>
                            <strong>Payload:</strong> { user_id, message, session_id }<br>
                            <strong>Entry Point:</strong> src/api/routes/chat.py â†’ process_chat_simplified()
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Step 1: Store Event -->
                    <div class="flow-step">
                        <div class="flow-step-header">
                            <span class="flow-step-number">STEP 1</span>
                            <span class="flow-step-title">Store Raw Chat Event</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Action:</strong> INSERT INTO app.chat_events<br>
                            <strong>Purpose:</strong> Immutable audit trail (Layer 1)<br>
                            <strong>Idempotency:</strong> SHA256(content) prevents duplicates<br>
                            <strong>Time:</strong> ~5ms
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Phase 1A: Entity Resolution -->
                    <div class="flow-step" style="border-color: var(--color-primary); background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.1));">
                        <div class="flow-step-header">
                            <span class="flow-step-number" style="background: var(--color-primary);">PHASE 1A</span>
                            <span class="flow-step-title">Entity Resolution (5-Stage Hybrid)</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Goal:</strong> Resolve "Kai" â†’ customer:kai_media_123 â€¢ Cost: ~$0.0003 â€¢ Time: 30-200ms<br><br>
                            <strong>5 Stages (fast â†’ slow, stop at first match):</strong><br>
                            1ï¸âƒ£ <strong>Exact Match:</strong> SELECT FROM canonical_entities WHERE canonical_name = 'Kai'<br>
                            2ï¸âƒ£ <strong>Alias Lookup:</strong> SELECT FROM entity_aliases WHERE alias_text = 'Kai'<br>
                            3ï¸âƒ£ <strong>Fuzzy Match:</strong> similarity('Kai', canonical_name) > 0.7 (pg_trgm)<br>
                            4ï¸âƒ£ <strong>LLM Coreference:</strong> "they" â†’ previous entity in conversation (5% of cases)<br>
                            5ï¸âƒ£ <strong>Domain DB:</strong> SELECT FROM domain.customers WHERE name ILIKE '%Kai%'<br><br>
                            <strong>Output:</strong> ResolvedEntity(entity_id, confidence, method, metadata)
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Phase 1B: Semantic Extraction -->
                    <div class="flow-step" style="border-color: var(--color-success); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));">
                        <div class="flow-step-header">
                            <span class="flow-step-number" style="background: var(--color-success);">PHASE 1B</span>
                            <span class="flow-step-title">Semantic Extraction (LLM Triple Extraction)</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Goal:</strong> Extract facts as (subject, predicate, object) triples â€¢ Cost: ~$0.001 â€¢ Time: 200-500ms<br>
                            <strong>Model:</strong> gpt-4o-mini<br><br>
                            <strong>Example:</strong> "Kai prefers delivery on Fridays" â†’<br>
                            &nbsp;&nbsp;â€¢ subject_entity_id: customer:kai_media_123<br>
                            &nbsp;&nbsp;â€¢ predicate: "delivery_preference"<br>
                            &nbsp;&nbsp;â€¢ object_value: "Friday"<br>
                            &nbsp;&nbsp;â€¢ confidence: 0.85<br>
                            &nbsp;&nbsp;â€¢ INSERT INTO app.semantic_memories<br><br>
                            <strong>Conflict Detection:</strong> Compare new facts vs existing semantic_memories + domain.customers<br>
                            <strong>Output:</strong> List of SemanticMemory objects + detected conflicts
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Phase 1C: Domain Augmentation -->
                    <div class="flow-step" style="border-color: var(--color-warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.1));">
                        <div class="flow-step-header">
                            <span class="flow-step-number" style="background: var(--color-warning);">PHASE 1C</span>
                            <span class="flow-step-title">Domain Augmentation (SQL Queries)</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Goal:</strong> Fetch authoritative business data â€¢ Cost: $0 â€¢ Time: 10-50ms<br><br>
                            <strong>Query Triggers:</strong><br>
                            â€¢ <strong>Customer:</strong> When entity â†’ customer:* | SELECT * FROM domain.customers<br>
                            â€¢ <strong>Invoice:</strong> When "invoice" OR "payment" mentioned | SELECT * FROM domain.invoices WHERE status = 'open'<br>
                            â€¢ <strong>Sales Order:</strong> When "order" mentioned | SELECT * FROM domain.sales_orders<br>
                            â€¢ <strong>Work Order:</strong> When "task" OR "work order" mentioned | SELECT * FROM domain.work_orders<br><br>
                            <strong>Output:</strong> List of DomainFact(type, entity_id, content, metadata, source_table)
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Phase 1D: Memory Scoring -->
                    <div class="flow-step" style="border-color: var(--color-purple); background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(139, 92, 246, 0.1));">
                        <div class="flow-step-header">
                            <span class="flow-step-number" style="background: var(--color-purple);">PHASE 1D</span>
                            <span class="flow-step-title">Memory Scoring (Multi-Signal Ranking)</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Goal:</strong> Rank memories by relevance to query â€¢ Cost: $0 â€¢ Time: 10-30ms<br><br>
                            <strong>Scoring Formula:</strong><br>
                            relevance = <strong>0.40</strong> Ã— semantic_similarity (pgvector cosine)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <strong>0.25</strong> Ã— entity_overlap (Jaccard similarity)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <strong>0.20</strong> Ã— recency (exp(-days Ã— decay_rate))<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <strong>0.15</strong> Ã— confidence (base Ã— validation_decay)<br><br>
                            <strong>Output:</strong> Top 10 memories ranked by relevance_score (0.0-1.0)
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Step 6: Generate LLM Reply -->
                    <div class="flow-step flow-step-orchestrator">
                        <div class="flow-step-header">
                            <span class="flow-step-number">STEP 6</span>
                            <span class="flow-step-title">Generate LLM Reply</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Input Context:</strong><br>
                            â€¢ User query<br>
                            â€¢ Resolved entities (from Phase 1A)<br>
                            â€¢ Domain facts (from Phase 1C)<br>
                            â€¢ Top memories (from Phase 1D)<br>
                            â€¢ Conversation history (last 10 messages)<br><br>
                            <strong>Model:</strong> gpt-4o-mini â€¢ <strong>Time:</strong> 100-300ms<br>
                            <strong>Output:</strong> Natural language reply synthesizing all context
                        </div>
                    </div>

                    <div class="flow-arrow">â†“</div>

                    <!-- Step 7: Assemble Response -->
                    <div class="flow-step">
                        <div class="flow-step-header">
                            <span class="flow-step-number">END</span>
                            <span class="flow-step-title">JSON Response with Full Provenance</span>
                        </div>
                        <div class="flow-step-content">
                            <strong>Response Structure:</strong><br>
                            {<br>
                            &nbsp;&nbsp;"response": "Natural language reply...",<br>
                            &nbsp;&nbsp;"augmentation": { domain_facts, memories_retrieved, entities_resolved },<br>
                            &nbsp;&nbsp;"memories_created": [{ memory_type, event_id, content }],<br>
                            &nbsp;&nbsp;"provenance": { memory_ids, similarity_scores, source_types },<br>
                            &nbsp;&nbsp;"conflicts": [{ subject, existing_value, new_value, resolution }]<br>
                            }
                        </div>
                    </div>
                </div>

                <!-- Memory Storage & Creation Section -->
                <div class="card mt-6">
                    <div class="card-title">Memory Storage & Creation: Deep Dive</div>
                    <div class="card-subtitle">How the system stores, creates, and manages memories throughout the pipeline</div>

                    <div style="margin-top: var(--space-6);">
                        <h3 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-text-primary);">
                            ðŸ“¦ Where Memories Are Stored
                        </h3>

                        <div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid var(--color-border); margin-bottom: var(--space-5);">
                            <strong>Database Schema: 10 Essential Tables</strong><br><br>

                            <div style="margin-left: var(--space-4);">
                                <strong style="color: var(--color-primary);">Layer 1: Raw Events</strong><br>
                                â€¢ <code>app.chat_events</code> - Immutable audit trail of all conversations<br>
                                &nbsp;&nbsp;â€¢ Stores: user_id, session_id, role, content, content_hash, created_at<br>
                                &nbsp;&nbsp;â€¢ Purpose: Complete provenance (who said what, when)<br><br>

                                <strong style="color: var(--color-primary);">Layer 2: Entity Resolution</strong><br>
                                â€¢ <code>app.canonical_entities</code> - Resolved entities with canonical names<br>
                                &nbsp;&nbsp;â€¢ Stores: entity_id (PK), canonical_name, entity_type, created_at<br>
                                &nbsp;&nbsp;â€¢ Example: "customer:acme_123" â†’ "Acme Corporation"<br>
                                â€¢ <code>app.entity_aliases</code> - Learned aliases for entities<br>
                                &nbsp;&nbsp;â€¢ Stores: alias_text â†’ canonical_entity_id (FK), user_id, confidence<br>
                                &nbsp;&nbsp;â€¢ Example: "Acme" â†’ customer:acme_123, "Kai" â†’ customer:kai_media_123<br><br>

                                <strong style="color: var(--color-success);">Layer 3: Episodic Memories</strong><br>
                                â€¢ <code>app.episodic_memories</code> - Event-based memories (not yet implemented)<br>
                                &nbsp;&nbsp;â€¢ Stores: user_id, event_id (FK), summary, entities, created_at<br>
                                &nbsp;&nbsp;â€¢ Purpose: "User asked about invoice INV-1234 on March 10th"<br><br>

                                <strong style="color: var(--color-success);">Layer 4: Semantic Memories</strong><br>
                                â€¢ <code>app.semantic_memories</code> - Fact-based memories (SPO triples)<br>
                                &nbsp;&nbsp;â€¢ Stores: subject_entity_id (FK), predicate, object_value (JSONB), confidence<br>
                                &nbsp;&nbsp;â€¢ Example: customer:acme_123 | "delivery_preference" | {"day": "Friday"}<br>
                                &nbsp;&nbsp;â€¢ Status lifecycle: active â†’ deprecated â†’ conflicted<br>
                                &nbsp;&nbsp;â€¢ Confidence decay: confidence Ã— e^(-age Ã— decay_rate)<br><br>

                                <strong style="color: var(--color-warning);">Layer 5: Procedural Memories</strong><br>
                                â€¢ <code>app.procedural_memories</code> - Pattern-based memories (Phase 1D)<br>
                                &nbsp;&nbsp;â€¢ Stores: pattern_name, condition, action, confidence<br>
                                &nbsp;&nbsp;â€¢ Example: "When delivery mentioned â†’ check invoices"<br><br>

                                <strong style="color: var(--color-purple);">Layer 6: Memory Summaries</strong><br>
                                â€¢ <code>app.memory_summaries</code> - Consolidated summaries (Phase 2)<br>
                                &nbsp;&nbsp;â€¢ Stores: entity_id (FK), summary_text, source_memory_ids, created_at<br>
                                &nbsp;&nbsp;â€¢ Example: "Acme Corp profile (3 sessions, 12 facts)"<br><br>

                                <strong>Supporting Tables:</strong><br>
                                â€¢ <code>app.memory_conflicts</code> - Tracks contradicting facts<br>
                                â€¢ <code>app.domain_ontology</code> - Business domain schema<br>
                                â€¢ <code>app.system_config</code> - Tunable heuristics
                            </div>
                        </div>

                        <h3 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-text-primary);">
                            âš™ï¸ How Memories Are Created (By Pipeline Stage)
                        </h3>

                        <div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid var(--color-border); margin-bottom: var(--space-5);">
                            <strong>Stage 1: Store Chat Event</strong><br>
                            <code>src/demo/api/chat.py â†’ send_chat_message()</code><br>
                            â€¢ Creates <strong>ChatEvent</strong> record immediately on request<br>
                            â€¢ Content hashed (SHA256) for deduplication<br>
                            â€¢ Both user message AND assistant reply stored<br>
                            â€¢ Database: INSERT INTO app.chat_events<br><br>

                            <strong>Stage 2: Entity Resolution (Phase 1A)</strong><br>
                            <code>src/domain/services/entity_resolution_service.py</code><br>
                            â€¢ Creates <strong>CanonicalEntity</strong> on first mention (lazy creation)<br>
                            â€¢ Creates <strong>EntityAlias</strong> when fuzzy match succeeds<br>
                            â€¢ Learning: User-specific aliases stored for future resolution<br>
                            â€¢ Database: INSERT INTO app.canonical_entities, app.entity_aliases<br><br>

                            <strong>Stage 3: Semantic Extraction (Phase 1B)</strong><br>
                            <code>src/application/use_cases/extract_semantics.py</code><br>
                            â€¢ LLM extracts SPO triples from message<br>
                            â€¢ Creates <strong>SemanticMemory</strong> records (batch INSERT)<br>
                            â€¢ Each triple: subject_entity_id + predicate + object_value<br>
                            â€¢ Initial confidence: 0.85 (explicit), 0.70 (implicit), 0.50 (inferred)<br>
                            â€¢ Database: INSERT INTO app.semantic_memories<br><br>

                            <strong>Stage 4: Conflict Detection</strong><br>
                            <code>src/domain/services/conflict_detection_service.py</code><br>
                            â€¢ Compares new facts vs existing semantic_memories<br>
                            â€¢ Compares new facts vs authoritative domain.customers<br>
                            â€¢ Creates <strong>MemoryConflict</strong> record if contradiction found<br>
                            â€¢ Resolution strategies: trust_db, trust_recent, ask_user<br>
                            â€¢ Database: INSERT INTO app.memory_conflicts<br><br>

                            <strong>Stage 5: Memory Validation</strong><br>
                            <code>src/domain/services/memory_validation_service.py</code><br>
                            â€¢ Reinforces confidence when memory is validated (confidence +0.05, capped at 0.95)<br>
                            â€¢ Marks memory as deprecated if contradicted<br>
                            â€¢ Updates last_validated_at timestamp<br>
                            â€¢ Database: UPDATE app.semantic_memories SET confidence, last_validated_at, status<br><br>

                            <strong>Future: Procedural Memory Creation (Phase 1D)</strong><br>
                            â€¢ Extracts patterns from repeated user behaviors<br>
                            â€¢ Creates <strong>ProceduralMemory</strong> when pattern confidence > 0.75<br>
                            â€¢ Example: "User always asks about invoices after mentioning delivery"<br>
                            â€¢ Database: INSERT INTO app.procedural_memories
                        </div>

                        <h3 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-text-primary);">
                            ðŸ”„ Memory Lifecycle Management
                        </h3>

                        <div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid var(--color-border); margin-bottom: var(--space-5);">
                            <strong>State Transitions (Semantic Memories):</strong><br><br>

                            <code>ACTIVE</code> â†’ Initial state when fact is extracted<br>
                            &nbsp;&nbsp;â†“ (confidence decays over time without validation)<br>
                            <code>ACTIVE</code> â†’ Confidence reinforced when fact is used (+0.05, max 0.95)<br>
                            &nbsp;&nbsp;â†“ (conflict detected with newer information)<br>
                            <code>CONFLICTED</code> â†’ Marked when contradiction found<br>
                            &nbsp;&nbsp;â†“ (resolved in favor of newer/more authoritative source)<br>
                            <code>DEPRECATED</code> â†’ Fact superseded, kept for audit trail<br><br>

                            <strong>Confidence Decay Formula (Passive Computation):</strong><br>
                            <code>effective_confidence = base_confidence Ã— e^(-days_since_validation Ã— decay_rate)</code><br>
                            â€¢ decay_rate: 0.0115 per day (configurable)<br>
                            â€¢ Never pre-computed - calculated on-demand when scoring memories<br>
                            â€¢ Ensures freshness without background jobs<br><br>

                            <strong>Retrieval & Scoring:</strong><br>
                            â€¢ Phase 1D: Multi-signal relevance scoring<br>
                            â€¢ Formula: 0.40Ã—semantic + 0.25Ã—entity_overlap + 0.20Ã—recency + 0.15Ã—confidence<br>
                            â€¢ Semantic similarity: pgvector cosine distance on embeddings<br>
                            â€¢ Entity overlap: Jaccard similarity between entity sets<br>
                            â€¢ Recency: Exponential decay based on created_at<br>
                            â€¢ Confidence: Effective confidence after decay
                        </div>

                        <h3 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-text-primary);">
                            ðŸŽ¯ Key Design Decisions
                        </h3>

                        <div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                            <strong>1. Surgical LLM Integration</strong><br>
                            â€¢ LLM only for semantic extraction (Phase 1B) and coreference (Phase 1A Stage 4)<br>
                            â€¢ Entity resolution: 95% deterministic (pg_trgm fuzzy match), 5% LLM<br>
                            â€¢ Cost: ~$0.002 per turn vs $0.03 for pure-LLM approach<br><br>

                            <strong>2. Passive Computation (No Background Jobs)</strong><br>
                            â€¢ Confidence decay calculated on-demand, not pre-computed<br>
                            â€¢ Simpler, more accurate, avoids staleness<br>
                            â€¢ Pre-computation is Phase 2 optimization<br><br>

                            <strong>3. Epistemic Humility</strong><br>
                            â€¢ Max confidence: 0.95 (never 100% certain)<br>
                            â€¢ All conflicts logged to memory_conflicts table<br>
                            â€¢ Resolution strategy explicitly tracked<br>
                            â€¢ System admits uncertainty when confidence < 0.70<br><br>

                            <strong>4. JSONB for Context-Specific Data</strong><br>
                            â€¢ object_value in semantic_memories: flexible schema<br>
                            â€¢ confidence_factors: evidence varies per memory<br>
                            â€¢ metadata in entity_aliases: disambiguation context<br>
                            â€¢ Allows rich context without schema migrations<br><br>

                            <strong>5. Dual Truth Architecture</strong><br>
                            â€¢ Domain database (domain.*): Authoritative business facts<br>
                            â€¢ Memory system (app.*): Contextual understanding<br>
                            â€¢ Both are sources of truth - neither alone is sufficient<br>
                            â€¢ Conflicts resolved via explicit strategy, never silently
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Database -->
        <div id="tab-database" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Domain Database Statistics</div>
                <div id="databaseStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Database Tables</div>
                <div id="databaseTables" class="mt-5"></div>
            </div>
        </div>

        <!-- Tab: Memory -->
        <div id="tab-memory" class="tab-content">
            <div class="card mb-5">
                <div class="card-title">Memory Layer Statistics</div>
                <div id="memoryStats" class="grid grid-stats mt-5"></div>
            </div>
            <div class="card">
                <div class="card-title">Memory Layers</div>
                <div class="card-subtitle">Click a layer to view detailed data</div>
                <div id="memoryLayers" class="grid grid-2 mt-5"></div>
            </div>
            <div id="memoryDetail" class="mt-5"></div>
        </div>

        <!-- Tab: Chat -->
        <div id="tab-chat" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                <button class="btn btn-sm" onclick="clearConversation()" style="opacity: 0.7;">
                    Clear Conversation
                </button>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--color-text-secondary); cursor: pointer;">
                    <input type="checkbox" id="debugMode" checked style="cursor: pointer;">
                    Debug Mode
                </label>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-suggestions">
                        <div class="chat-suggestions-title">Try one of these example queries:</div>
                        <div class="suggestion-card" onclick="useSuggestion('What invoices are outstanding?')">
                            <div class="suggestion-card-icon">ðŸ’°</div>
                            <div class="suggestion-card-text">What invoices are outstanding?</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('Tell me about Acme Corp')">
                            <div class="suggestion-card-icon">ðŸ¢</div>
                            <div class="suggestion-card-text">Tell me about Acme Corp</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('What work orders are in progress?')">
                            <div class="suggestion-card-icon">ðŸ”§</div>
                            <div class="suggestion-card-text">What work orders are in progress?</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    <button class="btn btn-danger" onclick="clearMemory()" style="margin-left: 8px;">Clear Memory</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL ERROR HANDLER
        // ============================================

        window.addEventListener('error', function(event) {
            console.error('[GLOBAL ERROR]', event.message);
            console.error('[LOCATION]', event.filename, 'Line:', event.lineno, 'Col:', event.colno);
            console.error('[STACK]', event.error?.stack);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('[UNHANDLED REJECTION]', event.reason);
        });

        // ============================================
        // STATE MANAGEMENT
        // ============================================

        let currentTab = 'scenarios';
        let scenariosData = [];
        let databaseStatsData = {};
        let memoryStatsData = {};

        // Category mapping for colors
        const categoryMap = {
            'Financial': 'financial',
            'Operational': 'operational',
            'Entity Resolution': 'entity',
            'Memory Extraction': 'memory',
            'Conflict Resolution': 'conflict',
            'Intelligence': 'intelligence'
        };

        // ============================================
        // TAB MANAGEMENT
        // ============================================

        function updateHeaderCounts() {
            // Update header stats (Domain Database count and Memory Entries count)
            if (databaseStatsData) {
                const totalDb = Object.values(databaseStatsData).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalDbRecords').textContent = totalDb;
            }

            if (memoryStatsData) {
                const totalMemories = Object.values(memoryStatsData).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalMemories').textContent = totalMemories;
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================

        // ============================================
        // SCENARIOS MANAGEMENT
        // ============================================

        let reasoningPaneVisible = false;

        function toggleReasoningPane() {
            reasoningPaneVisible = !reasoningPaneVisible;

            const chatContainer = document.getElementById('chatContainer');
            const reasoningPane = document.getElementById('reasoningPane');
            const toggleBtn = document.getElementById('reasoningToggleBtn');

            // Guard: If elements don't exist, exit early
            if (!reasoningPane || !chatContainer || !toggleBtn) {
                console.warn('Required reasoning pane elements not found');
                return;
            }

            if (reasoningPaneVisible) {
                // Show reasoning pane - split view
                chatContainer.classList.add('split-view');
                reasoningPane.style.display = 'flex';
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'âœ• Hide Reasoning';
            } else {
                // Hide reasoning pane - full width
                chatContainer.classList.remove('split-view');
                reasoningPane.style.display = 'none';
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'ðŸ¤” Show Reasoning';

                // Mark as manually dismissed so it doesn't auto-open again
                localStorage.setItem('reasoning_pane_dismissed', 'true');
            }
        }

        function renderReasoningSteps(traces) {
            const container = document.getElementById('reasoningPaneContent');

            // Guard: If element doesn't exist, exit early
            if (!container) {
                console.warn('reasoningPaneContent element not found');
                return;
            }

            if (!traces || !traces.traces || traces.traces.length === 0) {
                container.innerHTML = `
                    <div class="reasoning-empty">
                        <div class="reasoning-empty-icon">ðŸ¤–</div>
                        <div class="reasoning-empty-text">No reasoning traces available</div>
                    </div>
                `;
                return;
            }

            // Build timeline of steps
            const timeline = document.createElement('div');
            timeline.className = 'reasoning-timeline';

            // Parse and render each trace
            traces.traces.forEach((trace, index) => {
                const step = createReasoningStep(trace, index);
                timeline.appendChild(step);
            });

            container.innerHTML = '';
            container.appendChild(timeline);

            // Progressive reveal animation
            const steps = container.querySelectorAll('.reasoning-step');
            steps.forEach((step, index) => {
                setTimeout(() => {
                    step.style.animationDelay = `${index * 0.1}s`;
                }, 50);
            });
        }

        function createReasoningStep(trace, index) {
            const step = document.createElement('div');

            // Determine step type and icon
            let stepType = 'reasoning';
            let icon = 'ðŸ¤”';

            if (trace.trace_type === 'database_query') {
                stepType = 'database-query';
                icon = 'ðŸ—„ï¸';
            } else if (trace.trace_type === 'memory_retrieval') {
                stepType = 'memory-retrieval';
                icon = 'ðŸ§ ';
            } else if (trace.trace_type === 'reasoning_step') {
                stepType = 'reasoning';
                icon = 'ðŸ¤”';
            } else if (trace.description && trace.description.toLowerCase().includes('llm')) {
                stepType = 'llm-generation';
                icon = 'âœ¨';
            }

            step.className = `reasoning-step ${stepType}`;

            // Build step content
            const title = trace.step || trace.description || `Step ${index + 1}`;
            const description = trace.description || '';
            const duration = trace.duration_ms ? `${Math.round(trace.duration_ms)}ms` : '';

            // Build details from trace data
            let details = '';
            if (trace.trace_type === 'database_query') {
                details = `Query: ${trace.query_type} on ${trace.table} (${trace.rows_affected} rows)`;
            } else if (trace.trace_type === 'memory_retrieval') {
                details = `Found ${trace.memories_found} memories using ${trace.retrieval_method}`;
                if (trace.top_memory) {
                    details += `\nTop memory: "${trace.top_memory.content.substring(0, 50)}..." (relevance: ${trace.top_memory.relevance})`;
                }
            } else if (trace.output_data) {
                details = JSON.stringify(trace.output_data, null, 2);
            }

            step.innerHTML = `
                <div class="reasoning-step-marker">${icon}</div>
                <div class="reasoning-step-content">
                    <div class="reasoning-step-header">
                        <div class="reasoning-step-title">${title}</div>
                        ${duration ? `<div class="reasoning-step-duration">${duration}</div>` : ''}
                    </div>
                    ${description ? `<div class="reasoning-step-description">${description}</div>` : ''}
                    ${details ? `<div class="reasoning-step-details">${details}</div>` : ''}
                </div>
            `;

            return step;
        }

        function clearReasoningPane() {
            const container = document.getElementById('reasoningPaneContent');

            // Guard: If element doesn't exist, exit early
            if (!container) {
                console.warn('reasoningPaneContent element not found');
                return;
            }

            container.innerHTML = `
                <div class="reasoning-empty">
                    <div class="reasoning-empty-icon">ðŸ¤–</div>
                    <div class="reasoning-empty-text">Send a message to see how the system thinks</div>
                </div>
            `;
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function showTab(tabName) {
            currentTab = tabName;

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Find and activate the corresponding nav tab button
            const navButtons = document.querySelectorAll('.nav-tab');
            const targetNavButton = Array.from(navButtons).find(btn =>
                btn.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            if (targetNavButton) {
                targetNavButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'database') {
                loadDatabaseTab();
            } else if (tabName === 'memory') {
                loadMemoryTab();
            }
        }

        // ============================================
        // SCENARIOS TAB
        // ============================================

        async function loadScenarios() {
            try {
                const response = await fetch('/api/v1/demo/scenarios');
                scenariosData = await response.json();
                renderScenarios();
            } catch (error) {
                const scenariosList = document.getElementById('scenariosList');
                if (scenariosList) {
                    scenariosList.innerHTML = `
                        <div class="alert alert-error">Failed to load scenarios: ${error.message}</div>
                    `;
                }
            }
        }

        function renderScenarios() {
            const html = scenariosData.map((scenario, index) => {
                const categoryClass = categoryMap[scenario.category] || 'intelligence';
                const scenarioNumber = index + 1;

                return `
                    <div class="scenario-card category-${categoryClass}">
                        <div class="scenario-number">${scenarioNumber}</div>
                        <div class="scenario-header">
                            <div style="flex: 1;">
                                <div class="scenario-title">${scenario.title}</div>
                                <div class="scenario-description">${scenario.description}</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadScenario(${scenario.scenario_id})">
                                Load
                            </button>
                        </div>
                        <div class="scenario-meta">
                            <span class="scenario-category">${scenario.category}</span>
                            ${scenario.data_requirements ? `<span>${scenario.data_requirements.length} data sources</span>` : ''}
                        </div>
                        <button class="btn btn-details" onclick="toggleScenarioDetails(${scenario.scenario_id})">
                            <span id="toggle-icon-${scenario.scenario_id}">â–¼</span> Show Details
                        </button>
                        <div class="scenario-details" id="scenario-details-${scenario.scenario_id}"></div>
                    </div>
                `;
            }).join('');

            const scenariosList = document.getElementById('scenariosList');
            if (scenariosList) {
                scenariosList.innerHTML = html;
            }
        }

        async function toggleScenarioDetails(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            const icon = document.getElementById(`toggle-icon-${scenarioId}`);
            const button = event.target.closest('button');

            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.textContent = 'â–¼';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">â–¼</span> Show Details`;
            } else {
                // Load actual data if not already loaded
                if (!details.dataset.loaded) {
                    await loadScenarioData(scenarioId);
                }
                details.classList.add('expanded');
                icon.textContent = 'â–²';
                button.innerHTML = `<span id="toggle-icon-${scenarioId}">â–²</span> Hide Details`;
            }
        }

        async function loadScenarioData(scenarioId) {
            const details = document.getElementById(`scenario-details-${scenarioId}`);
            details.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`/api/v1/demo/scenarios/${scenarioId}/data`);
                const data = await response.json();

                // Build sections
                let html = '';

                // Database Records
                html += '<div class="scenario-details-section">';
                html += '<div class="scenario-details-title"><span class="badge badge-primary">Database Records</span></div>';

                let dbContent = '';
                if (data.customers.length > 0) {
                    dbContent += '<strong>Customers:</strong>\n';
                    data.customers.forEach(c => {
                        dbContent += `  â€¢ ${c.name} (${c.industry})\n`;
                    });
                    dbContent += '\n';
                }
                if (data.sales_orders.length > 0) {
                    dbContent += '<strong>Sales Orders:</strong>\n';
                    data.sales_orders.forEach(so => {
                        dbContent += `  â€¢ ${so.so_number}: ${so.title} [${so.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.invoices.length > 0) {
                    dbContent += '<strong>Invoices:</strong>\n';
                    data.invoices.forEach(inv => {
                        dbContent += `  â€¢ ${inv.invoice_number}: $${inv.amount} due ${inv.due_date} [${inv.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.work_orders.length > 0) {
                    dbContent += '<strong>Work Orders:</strong>\n';
                    data.work_orders.forEach(wo => {
                        dbContent += `  â€¢ ${wo.description} - ${wo.technician} [${wo.status}]\n`;
                    });
                    dbContent += '\n';
                }
                if (data.payments.length > 0) {
                    dbContent += '<strong>Payments:</strong>\n';
                    data.payments.forEach(pay => {
                        dbContent += `  â€¢ ${pay.invoice_number}: $${pay.amount} via ${pay.method}\n`;
                    });
                    dbContent += '\n';
                }
                if (data.tasks.length > 0) {
                    dbContent += '<strong>Tasks:</strong>\n';
                    data.tasks.forEach(task => {
                        dbContent += `  â€¢ ${task.title} [${task.status}]\n`;
                    });
                }

                html += `<div class="scenario-details-content">${dbContent || 'No database records'}</div>`;
                html += '</div>';

                // Memory Entries
                if (data.semantic_memories.length > 0) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-success">Semantic Memories</span></div>';

                    let memContent = '';
                    data.semantic_memories.forEach(mem => {
                        const objValue = typeof mem.object_value === 'object'
                            ? JSON.stringify(mem.object_value)
                            : mem.object_value;
                        memContent += `â€¢ ${mem.subject} â†’ ${mem.predicate}: ${objValue} (confidence: ${(mem.confidence * 100).toFixed(0)}%)\n`;
                    });

                    html += `<div class="scenario-details-content">${memContent}</div>`;
                    html += '</div>';
                }

                // Expected Behavior
                const scenario = scenariosData.find(s => s.scenario_id === scenarioId);
                if (scenario && scenario.expected_behavior) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title"><span class="badge badge-purple">Expected Behavior</span></div>';
                    html += `<div class="scenario-details-content">${scenario.expected_behavior}</div>`;
                    html += '</div>';
                }

                // Example Query
                if (scenario && scenario.expected_query) {
                    html += '<div class="scenario-details-section">';
                    html += '<div class="scenario-details-title" style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span class="badge badge-pink">Example Query</span>';
                    html += `<button class="btn btn-primary btn-sm" onclick="tryQuery('${scenario.expected_query.replace(/'/g, "\\'")}')">Try Query â†’</button>`;
                    html += '</div>';
                    html += `<div class="scenario-details-content">${scenario.expected_query}</div>`;
                    html += '</div>';
                }

                details.innerHTML = html;
                details.dataset.loaded = 'true';
            } catch (error) {
                details.innerHTML = `<div class="alert alert-error">Failed to load scenario data: ${error.message}</div>`;
            }
        }

        async function loadScenario(scenarioId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                await fetch(`/api/v1/demo/scenarios/${scenarioId}/load`, { method: 'POST' });
                showGlobalSuccess(`Scenario ${scenarioId} loaded successfully`);
                btn.textContent = 'Loaded';
                updateHeaderStats();

                // Animate data flow through architecture diagram
                setTimeout(() => animateDataFlow(), 500);
            } catch (error) {
                showGlobalError('Load Failed', error.message);
                btn.disabled = false;
                btn.textContent = 'Load';
            }
        }

        async function clearMemoriesOnly() {
            if (!confirm('This will clear all memories (chat history, entities, semantic memories). Domain data will be preserved. Continue?')) return;

            try {
                await fetch('/api/v1/demo/scenarios/reset-memories', { method: 'POST' });
                showGlobalSuccess('Memory data cleared successfully');
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Clear Failed', error.message);
            }
        }

        async function resetAllData() {
            if (!confirm('This will delete all data (domain + memories). Continue?')) return;

            try {
                await fetch('/api/v1/demo/scenarios/reset', { method: 'POST' });
                showGlobalSuccess('All data reset successfully');
                updateHeaderStats();
            } catch (error) {
                showGlobalError('Reset Failed', error.message);
            }
        }

        // ============================================
        // DATABASE TAB
        // ============================================

        async function loadDatabaseTab() {
            await loadDatabaseStats();
            await loadDatabaseTables();
        }

        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/v1/demo/database/stats');
                databaseStatsData = await response.json();
                renderDatabaseStats();
            } catch (error) {
                console.error('Failed to load database stats:', error);
            }
        }

        function renderDatabaseStats() {
            const stats = [
                { label: 'Customers', value: databaseStatsData.customers || 0, color: 'var(--color-primary)' },
                { label: 'Sales Orders', value: databaseStatsData.sales_orders || 0, color: 'var(--color-success)' },
                { label: 'Work Orders', value: databaseStatsData.work_orders || 0, color: 'var(--color-warning)' },
                { label: 'Invoices', value: databaseStatsData.invoices || 0, color: 'var(--color-purple)' },
                { label: 'Payments', value: databaseStatsData.payments || 0, color: 'var(--color-teal)' },
                { label: 'Tasks', value: databaseStatsData.tasks || 0, color: 'var(--color-pink)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            const databaseStats = document.getElementById('databaseStats');
            if (databaseStats) {
                databaseStats.innerHTML = html;
            }
        }

        async function loadDatabaseTables() {
            const tables = [
                { name: 'customers', label: 'Customers', fields: ['customer_id', 'name', 'industry', 'size'] },
                { name: 'sales_orders', label: 'Sales Orders', fields: ['so_id', 'so_number', 'customer', 'status', 'title'] },
                { name: 'invoices', label: 'Invoices', fields: ['invoice_id', 'invoice_number', 'amount', 'due_date', 'status'] },
                { name: 'work_orders', label: 'Work Orders', fields: ['wo_id', 'description', 'technician', 'status'] },
                { name: 'payments', label: 'Payments', fields: ['payment_id', 'invoice', 'amount', 'method'] },
                { name: 'tasks', label: 'Tasks', fields: ['task_id', 'title', 'status', 'customer'] }
            ];

            const html = await Promise.all(tables.map(async table => {
                try {
                    const response = await fetch(`/api/v1/demo/database/${table.name}`);
                    const data = await response.json();

                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        ${table.fields.map(field => `<th>${field.replace(/_/g, ' ')}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="${table.fields.length}" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.slice(0, 10).map(row => `
                                        <tr>
                                            ${table.fields.map(field => {
                                                let value = row[field];
                                                if (field === 'status') {
                                                    const statusColors = {
                                                        'open': 'warning',
                                                        'closed': 'success',
                                                        'paid': 'success',
                                                        'pending': 'warning',
                                                        'overdue': 'danger',
                                                        'completed': 'success',
                                                        'in_progress': 'primary'
                                                    };
                                                    return `<td><span class="badge badge-${statusColors[value] || 'primary'}">${value}</span></td>`;
                                                }
                                                return `<td class="text-truncate" style="max-width: 200px;">${value || '-'}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${data.length > 10 ? `<div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--color-text-tertiary);">Showing 10 of ${data.length} records</div>` : ''}
                    `;

                    return `
                        <div class="card mb-5">
                            <div class="card-header">
                                <div class="card-title">${table.label}</div>
                                <span class="badge badge-primary">${data.length}</span>
                            </div>
                            ${tableHtml}
                        </div>
                    `;
                } catch (error) {
                    return `
                        <div class="card mb-5">
                            <div class="card-title">${table.label}</div>
                            <div class="alert alert-error">Failed to load</div>
                        </div>
                    `;
                }
            }));

            const databaseTables = document.getElementById('databaseTables');
            if (databaseTables) {
                databaseTables.innerHTML = html.join('');
            }
        }

        // ============================================
        // MEMORY TAB
        // ============================================

        async function loadMemoryTab() {
            await loadMemoryStats();
            await loadMemoryLayers();
        }

        async function loadMemoryStats() {
            try {
                const response = await fetch('/api/v1/demo/memories/stats');
                memoryStatsData = await response.json();
                renderMemoryStats();
            } catch (error) {
                console.error('Failed to load memory stats:', error);
            }
        }

        function renderMemoryStats() {
            const stats = [
                { label: 'Chat Events', value: memoryStatsData.chat_events || 0, color: 'var(--color-teal)' },
                { label: 'Entities', value: memoryStatsData.canonical_entities || 0, color: 'var(--color-primary)' },
                { label: 'Aliases', value: memoryStatsData.entity_aliases || 0, color: 'var(--color-primary)' },
                { label: 'Episodic', value: memoryStatsData.episodic_memories || 0, color: 'var(--color-purple)' },
                { label: 'Semantic', value: memoryStatsData.semantic_memories || 0, color: 'var(--color-success)' },
                { label: 'Procedural', value: memoryStatsData.procedural_memories || 0, color: 'var(--color-warning)' },
                { label: 'Summaries', value: memoryStatsData.memory_summaries || 0, color: 'var(--color-pink)' },
                { label: 'Conflicts', value: memoryStatsData.memory_conflicts || 0, color: 'var(--color-danger)' }
            ];

            const html = stats.map(stat => `
                <div class="stat-card" style="--stat-color: ${stat.color}">
                    <div class="stat-card-header">
                        <span class="stat-card-title">${stat.label}</span>
                    </div>
                    <div class="stat-card-value">${stat.value}</div>
                </div>
            `).join('');

            const memoryStats = document.getElementById('memoryStats');
            if (memoryStats) {
                memoryStats.innerHTML = html;
            }
        }

        async function loadMemoryLayers() {
            const layers = [
                {
                    number: 1,
                    name: 'Raw Events',
                    key: 'chat_events',
                    description: 'Immutable conversation audit trail',
                    count: memoryStatsData.chat_events || 0,
                    endpoint: '/api/v1/demo/memories/chat_events'
                },
                {
                    number: 2,
                    name: 'Entity Resolution',
                    key: 'entities',
                    description: 'Canonical entities + aliases',
                    count: (memoryStatsData.canonical_entities || 0) + (memoryStatsData.entity_aliases || 0),
                    endpoint: null
                },
                {
                    number: 3,
                    name: 'Episodic Memories',
                    key: 'episodic',
                    description: 'Events with temporal context',
                    count: memoryStatsData.episodic_memories || 0,
                    endpoint: '/api/v1/demo/memories/episodic'
                },
                {
                    number: 4,
                    name: 'Semantic Memories',
                    key: 'semantic',
                    description: 'Fact triples with confidence',
                    count: memoryStatsData.semantic_memories || 0,
                    endpoint: '/api/v1/demo/memories/semantic'
                },
                {
                    number: 5,
                    name: 'Procedural Memories',
                    key: 'procedural',
                    description: 'Learned patterns & heuristics',
                    count: memoryStatsData.procedural_memories || 0,
                    endpoint: '/api/v1/demo/memories/procedural'
                },
                {
                    number: 6,
                    name: 'Summaries',
                    key: 'summaries',
                    description: 'Cross-session consolidation',
                    count: memoryStatsData.memory_summaries || 0,
                    endpoint: '/api/v1/demo/memories/summaries'
                }
            ];

            const html = layers.map(layer => `
                <div class="layer-card layer-${layer.number}" onclick="loadLayerDetail('${layer.key}', ${layer.endpoint ? `'${layer.endpoint}'` : null}, ${layer.number})">
                    <div class="layer-card-header">
                        <span class="layer-card-number">Layer ${layer.number}</span>
                        <span class="badge badge-primary">${layer.count}</span>
                    </div>
                    <div class="layer-card-title">${layer.name}</div>
                    <div class="layer-card-description">${layer.description}</div>
                </div>
            `).join('');

            const memoryLayers = document.getElementById('memoryLayers');
            if (memoryLayers) {
                memoryLayers.innerHTML = html;
            }
        }

        async function loadLayerDetail(key, endpoint, layerNumber) {
            const detailContainer = document.getElementById('memoryDetail');

            if (!detailContainer) {
                console.warn('memoryDetail element not found');
                return;
            }

            if (!endpoint && key === 'entities') {
                detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const [entitiesRes, aliasesRes] = await Promise.all([
                        fetch('/api/v1/demo/memories/entities'),
                        fetch('/api/v1/demo/memories/aliases')
                    ]);

                    const entities = await entitiesRes.json();
                    const aliases = await aliasesRes.json();

                    let html = `<div class="card">`;

                    if (entities.length > 0) {
                        html += `
                            <div class="card-title mb-4">Canonical Entities (${entities.length})</div>
                            <div class="table-container mb-5">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Entity ID</th>
                                            <th>Canonical Name</th>
                                            <th>Entity Type</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${entities.map(e => `
                                            <tr>
                                                <td class="text-mono">${e.entity_id}</td>
                                                <td>${e.canonical_name}</td>
                                                <td><span class="badge badge-primary">${e.entity_type}</span></td>
                                                <td>${new Date(e.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (aliases.length > 0) {
                        html += `
                            <div class="card-title mb-4">Entity Aliases (${aliases.length})</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Alias</th>
                                            <th>Entity ID</th>
                                            <th>Similarity</th>
                                            <th>Created At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${aliases.map(a => `
                                            <tr>
                                                <td>${a.alias_text}</td>
                                                <td class="text-mono">${a.entity_id}</td>
                                                <td><span class="badge badge-success">${(a.similarity_score * 100).toFixed(0)}%</span></td>
                                                <td>${new Date(a.created_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (entities.length === 0 && aliases.length === 0) {
                        html += '<div class="empty-state">No entity data</div>';
                    }

                    html += `</div>`;
                    detailContainer.innerHTML = html;
                } catch (error) {
                    detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
                }
                return;
            }

            if (!endpoint) {
                detailContainer.innerHTML = '';
                return;
            }

            detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                let html = `<div class="card"><div class="card-title mb-5">Layer ${layerNumber} Data (${data.length} records)</div>`;

                if (key === 'chat_events') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Event ID</th>
                                        <th>Role</th>
                                        <th>Content</th>
                                        <th>Session ID</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(e => `
                                        <tr>
                                            <td class="text-mono">${e.event_id}</td>
                                            <td><span class="badge badge-${e.role === 'user' ? 'primary' : 'success'}">${e.role}</span></td>
                                            <td class="text-truncate" style="max-width: 300px;">${e.content}</td>
                                            <td class="text-mono">${e.session_id.slice(0, 8)}...</td>
                                            <td>${new Date(e.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'semantic') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Predicate</th>
                                        <th>Object Value</th>
                                        <th>Confidence</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td class="text-mono text-truncate" style="max-width: 150px;">${m.subject_entity_id}</td>
                                            <td>${m.predicate}</td>
                                            <td class="text-truncate" style="max-width: 200px;">${JSON.stringify(m.object_value)}</td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                            <td><span class="badge badge-${m.status === 'active' ? 'success' : 'warning'}">${m.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'episodic') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Summary</th>
                                        <th>Event Type</th>
                                        <th>Importance</th>
                                        <th>Session</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td class="text-truncate" style="max-width: 300px;">${m.summary}</td>
                                            <td><span class="badge badge-primary">${m.event_type}</span></td>
                                            <td><span class="badge badge-warning">${m.importance.toFixed(2)}</span></td>
                                            <td class="text-mono">${m.session_id.slice(0, 8)}...</td>
                                            <td>${new Date(m.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'procedural') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Trigger Pattern</th>
                                        <th>Action Heuristic</th>
                                        <th>Observed</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td>${m.trigger_pattern}</td>
                                            <td>${m.action_heuristic}</td>
                                            <td><span class="badge badge-primary">${m.observed_count}</span></td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (key === 'summaries') {
                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Scope</th>
                                        <th>Summary</th>
                                        <th>Confidence</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.length === 0 ? `
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--color-text-tertiary); padding: var(--space-10);">No records</td>
                                        </tr>
                                    ` : data.map(m => `
                                        <tr>
                                            <td><span class="badge badge-primary">${m.scope_type}</span></td>
                                            <td class="text-truncate" style="max-width: 400px;">${m.summary_text}</td>
                                            <td><span class="badge badge-success">${(m.confidence * 100).toFixed(0)}%</span></td>
                                            <td>${new Date(m.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                html += `</div>`;
                detailContainer.innerHTML = html;
            } catch (error) {
                detailContainer.innerHTML = `<div class="alert alert-error">Failed to load layer data</div>`;
            }
        }

        // ============================================
        // CHAT TAB
        // ============================================

        let chatHistory = [];
        let currentSessionId = null;  // Track session for conversation continuity

        function tryQuery(query) {
            // Switch to chat tab
            showTab('chat');

            // Load query into input
            const input = document.getElementById('chatInput');
            input.value = query;

            // Focus input for user to review and send
            input.focus();

            // Scroll input into view
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearConversation() {
            const container = document.getElementById('chatMessages');

            if (!container) {
                console.warn('chatMessages element not found');
                return;
            }

            container.innerHTML = `
                <div class="chat-suggestions">
                    <div class="chat-suggestions-title">Try one of these example queries:</div>
                    <div class="suggestion-card" onclick="useSuggestion('What invoices are outstanding?')">
                        <div class="suggestion-card-icon">ðŸ’°</div>
                        <div class="suggestion-card-text">What invoices are outstanding?</div>
                    </div>
                    <div class="suggestion-card" onclick="useSuggestion('Tell me about Acme Corp')">
                        <div class="suggestion-card-icon">ðŸ¢</div>
                        <div class="suggestion-card-text">Tell me about Acme Corp</div>
                    </div>
                    <div class="suggestion-card" onclick="useSuggestion('What work orders are in progress?')">
                        <div class="suggestion-card-icon">ðŸ”§</div>
                        <div class="suggestion-card-text">What work orders are in progress?</div>
                    </div>
                </div>
            `;
            currentSessionId = null;  // Reset session for fresh conversation

            // Clear reasoning pane and reset auto-open preference
            clearReasoningPane();
            localStorage.removeItem('reasoning_pane_dismissed');
        }

        function useSuggestion(query) {
            const input = document.getElementById('chatInput');
            input.value = query;
            input.focus();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            const debugMode = document.getElementById('debugMode').checked;

            addChatMessage('user', message);
            input.value = '';

            // Show real-time processing steps if debug mode is on
            let processingId = null;
            if (debugMode) {
                processingId = addProcessingSteps();
            } else {
                // Show simple typing indicator
                processingId = addTypingIndicator();
            }

            try {
                const requestBody = {
                    message: message,
                    user_id: 'demo-user',
                    debug: debugMode
                };

                // Include session_id if we have one (for conversation continuity)
                if (currentSessionId) {
                    requestBody.session_id = currentSessionId;
                }

                const response = await fetch('/api/v1/demo/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Populate processing details with response data
                if (debugMode && processingId) {
                    populateProcessingDetails(processingId, data);
                    // Convert processing message to include reply
                    removeProcessingSteps(processingId, data.reply, data.debug || data.traces);
                } else {
                    removeTypingIndicator(processingId);
                    // Add reply as new message in non-debug mode
                    addChatMessage('assistant', data.reply, data.debug || data.traces);
                }

                // Store session_id from response for next message
                if (data.session_id) {
                    currentSessionId = data.session_id;
                }

                // Refresh memory stats if memories were created
                if (data.debug && data.debug.memories_created && data.debug.memories_created.length > 0) {
                    loadMemoryStats();
                }

                // Render reasoning steps if reasoning pane is visible and traces available
                if (data.traces) {
                    renderReasoningSteps(data.traces);

                    // Auto-open reasoning pane on first message if not already open
                    if (!reasoningPaneVisible && !localStorage.getItem('reasoning_pane_dismissed')) {
                        setTimeout(() => toggleReasoningPane(), 500);
                    }
                }

            } catch (error) {
                if (debugMode && processingId) {
                    removeProcessingSteps(processingId, `Error: ${error.message}`, null);
                } else if (processingId) {
                    removeTypingIndicator(processingId);
                    addChatMessage('assistant', `Error: ${error.message}`);
                }
            }
        }

        async function clearMemory() {
            if (!confirm('Are you sure you want to clear all memory data? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/demo/memories/clear?user_id=demo-user', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Clear chat UI
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                    }

                    // Add confirmation message
                    addChatMessage('system', `Memory cleared successfully! Deleted ${data.total_deleted} records.`);

                    // Reset session ID
                    currentSessionId = null;

                    // Optionally refresh the stats/data displays
                    if (typeof refreshData === 'function') {
                        refreshData();
                    }
                } else {
                    addChatMessage('system', 'Failed to clear memory. Please try again.');
                }
            } catch (error) {
                console.error('Error clearing memory:', error);
                addChatMessage('system', `Error clearing memory: ${error.message}`);
            }
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator-msg';

            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            avatar.textContent = 'A';

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create typing indicator with 3 spans
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.appendChild(document.createElement('span'));
            indicator.appendChild(document.createElement('span'));
            indicator.appendChild(document.createElement('span'));

            // Assemble structure
            contentDiv.appendChild(indicator);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(contentDiv);
            container.appendChild(typingDiv);

            container.scrollTop = container.scrollHeight;
            return 'typing-indicator-msg';
        }

        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        // Processing steps visualization for debug mode
        function addProcessingSteps() {
            const container = document.getElementById('chatMessages');
            const processingId = 'processing-steps-' + Date.now();
            const startTime = performance.now(); // Track start time for latency

            // Helper function to create a processing step
            function createProcessingStep(stepName, stepNumber, stepText) {
                const step = document.createElement('div');
                step.className = 'processing-step';
                step.setAttribute('data-step', stepName);
                step.setAttribute('data-start-time', startTime); // Store start time

                const icon = document.createElement('div');
                icon.className = 'processing-step-icon';
                icon.textContent = 'â³';

                const textContainer = document.createElement('div');
                textContainer.className = 'processing-step-text';

                const title = document.createElement('div');
                title.textContent = `Step ${stepNumber}: ${stepText}`;

                const details = document.createElement('div');
                details.className = 'processing-step-details';

                textContainer.appendChild(title);
                textContainer.appendChild(details);
                step.appendChild(icon);
                step.appendChild(textContainer);

                return step;
            }

            // Create main processing div
            const processingDiv = document.createElement('div');
            processingDiv.className = 'chat-message assistant';
            processingDiv.id = processingId;

            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'chat-message-avatar';
            avatar.textContent = 'A';

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create role header
            const roleDiv = document.createElement('div');
            roleDiv.className = 'chat-message-role';
            roleDiv.textContent = 'Processing Request...';

            // Create steps container
            const stepsContainer = document.createElement('div');
            stepsContainer.className = 'processing-steps';

            // Add all 7 steps (updated to match current architecture)
            const steps = [
                { name: 'pii', text: 'PII Detection & Redaction (Phase 3.1)' },
                { name: 'store', text: 'Store chat event' },
                { name: 'resolve', text: 'Resolve entities with LLM (Phase 1A)' },
                { name: 'extract', text: 'Extract semantics (Phase 1B)' },
                { name: 'augment', text: 'LLM Tool Calling (Phase 1C)' },
                { name: 'score', text: 'Score & retrieve memories (Phase 1D)' },
                { name: 'generate', text: 'Generate LLM reply' }
            ];

            steps.forEach((step, index) => {
                stepsContainer.appendChild(createProcessingStep(step.name, index + 1, step.text));
            });

            // Assemble the structure
            contentDiv.appendChild(roleDiv);
            contentDiv.appendChild(stepsContainer);
            processingDiv.appendChild(avatar);
            processingDiv.appendChild(contentDiv);
            container.appendChild(processingDiv);

            container.scrollTop = container.scrollHeight;
            return processingId;
        }

        function populateProcessingDetails(processingId, data) {
            const processingElement = document.getElementById(processingId);
            if (!processingElement) return;

            // Helper function to complete a step with actual server timing
            function completeStep(step, detailText, actualDuration) {
                if (!step) return;

                const icon = step.querySelector('.processing-step-icon');
                const details = step.querySelector('.processing-step-details');

                // Mark as completed (triggers CSS for green checkmark)
                step.classList.add('completed');

                if (icon) {
                    icon.textContent = 'âœ“';
                }

                if (details) {
                    const durationText = actualDuration !== undefined
                        ? `(+${actualDuration.toFixed(3)}s)`
                        : '';
                    details.textContent = `${detailText} ${durationText}`;
                }
            }

            // Check if we have step_timings from the server
            const stepTimings = data.step_timings || {};

            // Calculate cumulative delays for progressive display
            const stepOrder = ['pii', 'store', 'resolve', 'extract', 'augment', 'score', 'generate'];
            let cumulativeDelay = 0;
            const delays = {};

            // Calculate when each step should complete (based on cumulative server time)
            stepOrder.forEach(stepName => {
                delays[stepName] = cumulativeDelay;
                if (stepTimings[stepName]) {
                    cumulativeDelay += stepTimings[stepName] * 1000; // Convert to ms
                }
            });

            // Step 1: PII Detection & Redaction (Phase 3.1)
            setTimeout(() => {
                const piiStep = processingElement.querySelector('[data-step="pii"]');
                completeStep(piiStep, 'No PII detected', stepTimings.pii);
            }, delays.pii);

            // Step 2: Store (always completes)
            setTimeout(() => {
                const storeStep = processingElement.querySelector('[data-step="store"]');
                const sessionText = `Session: ${data.session_id ? data.session_id.substring(0, 8) + '...' : 'N/A'}`;
                completeStep(storeStep, sessionText, stepTimings.store);
            }, delays.store);

            // Step 3: Resolve entities with LLM (Phase 1A)
            setTimeout(() => {
                const resolveStep = processingElement.querySelector('[data-step="resolve"]');
                let resolveText = 'LLM mention extraction completed';
                if (data.debug && data.debug.entities_resolved) {
                    const count = data.debug.entities_resolved.length;
                    resolveText = `${count} entit${count !== 1 ? 'ies' : 'y'} resolved via LLM`;
                }
                completeStep(resolveStep, resolveText, stepTimings.resolve);
            }, delays.resolve);

            // Step 4: Extract semantics (Phase 1B)
            setTimeout(() => {
                const extractStep = processingElement.querySelector('[data-step="extract"]');
                let extractText = 'Semantic extraction completed';
                if (data.debug && data.debug.memories_created) {
                    const count = data.debug.memories_created.length;
                    extractText = `${count} semantic memor${count !== 1 ? 'ies' : 'y'} created`;
                }
                completeStep(extractStep, extractText, stepTimings.extract);
            }, delays.extract);

            // Step 5: LLM Tool Calling (Phase 1C)
            setTimeout(() => {
                const augmentStep = processingElement.querySelector('[data-step="augment"]');
                let augmentText = 'No domain facts retrieved';
                if (data.debug && data.debug.domain_facts_used && data.debug.domain_facts_used.length > 0) {
                    const facts = data.debug.domain_facts_used;
                    const sources = [...new Set(facts.map(f => f.source))];
                    augmentText = `${facts.length} fact${facts.length !== 1 ? 's' : ''} from ${sources.join(', ')}`;
                }
                completeStep(augmentStep, augmentText, stepTimings.augment);
            }, delays.augment);

            // Step 6: Score & retrieve memories (Phase 1D)
            setTimeout(() => {
                const scoreStep = processingElement.querySelector('[data-step="score"]');
                let scoreText = 'No memories retrieved';
                if (data.debug && data.debug.memories_retrieved && data.debug.memories_retrieved.length > 0) {
                    const memories = data.debug.memories_retrieved;
                    const avgRelevance = memories.reduce((sum, m) => sum + (m.relevance || 0), 0) / memories.length;
                    const avgConfidence = memories.reduce((sum, m) => sum + (m.confidence || 0), 0) / memories.length;
                    scoreText = `${memories.length} memor${memories.length !== 1 ? 'ies' : 'y'} (rel: ${avgRelevance.toFixed(2)}, conf: ${avgConfidence.toFixed(2)})`;
                }
                completeStep(scoreStep, scoreText, stepTimings.score);
            }, delays.score);

            // Step 7: Generate LLM reply
            setTimeout(() => {
                const generateStep = processingElement.querySelector('[data-step="generate"]');
                let generateText = 'Reply generation completed';
                if (data.reply) {
                    const chars = data.reply.length;
                    const tokens = Math.ceil(chars / 4);
                    generateText = `${chars} chars, ~${tokens} tokens`;
                }
                completeStep(generateStep, generateText, stepTimings.generate);
            }, delays.generate);
        }

        function removeProcessingSteps(id, replyContent, debugData) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn('removeProcessingSteps: element not found:', id);
                return;
            }

            // Mark all remaining steps as completed
            const allSteps = element.querySelectorAll('.processing-step');
            allSteps.forEach(step => {
                const icon = step.querySelector('.processing-step-icon');
                if (icon && icon.textContent === 'â³') {
                    icon.textContent = 'âœ“';
                }
                step.classList.add('completed');
            });

            // Reorder content: move processing steps to bottom, add reply at top
            const contentDiv = element.querySelector('.chat-message-content');
            const roleDiv = element.querySelector('.chat-message-role');
            const stepsContainer = element.querySelector('.processing-steps');

            if (!contentDiv) {
                console.warn('removeProcessingSteps: contentDiv not found for:', id);
                return;
            }

            if (!replyContent) {
                console.warn('removeProcessingSteps: no reply content for:', id);
                return;
            }

            // Remove processing steps temporarily to reorder
            if (stepsContainer && stepsContainer.parentNode === contentDiv) {
                try {
                    contentDiv.removeChild(stepsContainer);
                } catch (error) {
                    console.error('Error removing steps container:', error);
                }
            }

            // Update role to just show assistant + timestamp
            if (roleDiv) {
                try {
                    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    // Clear and rebuild using DOM methods instead of innerHTML
                    roleDiv.textContent = 'assistant ';
                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'chat-message-timestamp';
                    timestampSpan.textContent = timestamp;
                    roleDiv.appendChild(timestampSpan);
                } catch (error) {
                    console.error('Error updating roleDiv:', error);
                }
            }

            // Add reply text at the top (after role)
            try {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'chat-message-text';
                replyDiv.textContent = replyContent;
                contentDiv.appendChild(replyDiv);
            } catch (error) {
                console.error('Error adding reply text:', error);
                return;
            }

            // Build and add debug HTML if available
            if (debugData) {
                try {
                    if (debugData.domain_facts_used && debugData.domain_facts_used.length > 0) {
                        const factsDiv = document.createElement('div');
                        factsDiv.className = 'chat-message-debug';

                        const factsTitle = document.createElement('div');
                        factsTitle.className = 'chat-message-debug-title';
                        factsTitle.textContent = `Domain Facts (${debugData.domain_facts_used.length})`;
                        factsDiv.appendChild(factsTitle);

                        debugData.domain_facts_used.slice(0, 3).forEach(f => {
                            const item = document.createElement('div');
                            item.className = 'chat-message-debug-item';
                            item.textContent = `â€¢ ${JSON.stringify(f).slice(0, 100)}...`;
                            factsDiv.appendChild(item);
                        });

                        contentDiv.appendChild(factsDiv);
                    }

                    if (debugData.memories_used && debugData.memories_used.length > 0) {
                        const memsDiv = document.createElement('div');
                        memsDiv.className = 'chat-message-debug';

                        const memsTitle = document.createElement('div');
                        memsTitle.className = 'chat-message-debug-title';
                        memsTitle.textContent = `Memories Used (${debugData.memories_used.length})`;
                        memsDiv.appendChild(memsTitle);

                        debugData.memories_used.slice(0, 3).forEach(m => {
                            const item = document.createElement('div');
                            item.className = 'chat-message-debug-item';
                            item.textContent = `â€¢ ${m.content || JSON.stringify(m).slice(0, 100)}`;
                            memsDiv.appendChild(item);
                        });

                        contentDiv.appendChild(memsDiv);
                    }
                } catch (error) {
                    console.error('Error adding debug data:', error);
                }
            }

            // Add processing details toggle button (only if not already added)
            const existingToggle = element ? element.querySelector('.processing-details-toggle') : null;
            if (!existingToggle) {
                try {
                    if (!contentDiv) {
                        console.error('contentDiv is null when trying to add toggle button');
                        return;
                    }

                    const toggleDiv = document.createElement('div');
                    if (!toggleDiv) {
                        console.error('Failed to create toggleDiv');
                        return;
                    }

                    toggleDiv.className = 'processing-details-toggle';
                    toggleDiv.style.cssText = 'margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--color-border); cursor: pointer;';
                    toggleDiv.onclick = () => toggleProcessingDetails(id);

                    const toggleContent = document.createElement('span');
                    toggleContent.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-text-tertiary);';

                    const checkSpan = document.createElement('span');
                    checkSpan.style.color = 'var(--color-success)';
                    checkSpan.textContent = 'âœ“';

                    const textSpan = document.createElement('span');
                    textSpan.textContent = 'Processing Details';

                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'toggle-icon';
                    iconSpan.id = `${id}-toggle`;
                    iconSpan.textContent = 'â–¼';

                    if (toggleContent && checkSpan && textSpan && iconSpan) {
                        toggleContent.appendChild(checkSpan);
                        toggleContent.appendChild(textSpan);
                        toggleContent.appendChild(iconSpan);
                        toggleDiv.appendChild(toggleContent);
                        contentDiv.appendChild(toggleDiv);
                    } else {
                        console.error('Failed to create toggle button children');
                    }
                } catch (error) {
                    console.error('Error adding toggle button:', error, error.stack);
                }
            }

            // Re-add processing steps at the bottom (collapsed)
            if (stepsContainer) {
                try {
                    stepsContainer.classList.add('collapsed');
                    contentDiv.appendChild(stepsContainer);
                } catch (error) {
                    console.error('Error re-adding steps container:', error);
                }
            }
        }

        function toggleProcessingDetails(id) {
            const element = document.getElementById(id);
            if (element) {
                const stepsContainer = element.querySelector('.processing-steps');
                const toggleIcon = document.getElementById(`${id}-toggle`);

                if (stepsContainer) {
                    stepsContainer.classList.toggle('collapsed');
                    if (toggleIcon) {
                        toggleIcon.textContent = stepsContainer.classList.contains('collapsed') ? 'â–¼' : 'â–²';
                    }
                }
            }
        }

        function addChatMessage(role, content, debug = null) {
            const container = document.getElementById('chatMessages');

            // Remove suggestions or empty state when first message is added (without innerHTML)
            const suggestions = container.querySelector('.chat-suggestions');
            const emptyState = container.querySelector('.empty-state');
            if (suggestions) suggestions.remove();
            if (emptyState) emptyState.remove();

            const avatar = role === 'user' ? 'U' : 'A';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Create message structure
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            // Create avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-message-avatar';
            avatarDiv.textContent = avatar;

            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            // Create role header with timestamp
            const roleDiv = document.createElement('div');
            roleDiv.className = 'chat-message-role';
            roleDiv.textContent = role + ' ';

            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'chat-message-timestamp';
            timestampSpan.textContent = timestamp;
            roleDiv.appendChild(timestampSpan);

            // Create message text
            const textDiv = document.createElement('div');
            textDiv.className = 'chat-message-text';
            textDiv.textContent = content;

            // Add to content
            contentDiv.appendChild(roleDiv);
            contentDiv.appendChild(textDiv);

            // Add debug sections if present (using DOM methods)
            if (debug) {
                if (debug.domain_facts && debug.domain_facts.length > 0) {
                    const debugDiv = document.createElement('div');
                    debugDiv.className = 'chat-message-debug';

                    const title = document.createElement('div');
                    title.className = 'chat-message-debug-title';
                    title.textContent = `Domain Facts (${debug.domain_facts.length})`;
                    debugDiv.appendChild(title);

                    debug.domain_facts.slice(0, 3).forEach(f => {
                        const item = document.createElement('div');
                        item.className = 'chat-message-debug-item';
                        item.textContent = `â€¢ ${JSON.stringify(f).slice(0, 100)}...`;
                        debugDiv.appendChild(item);
                    });

                    contentDiv.appendChild(debugDiv);
                }

                if (debug.memories_used && debug.memories_used.length > 0) {
                    const debugDiv = document.createElement('div');
                    debugDiv.className = 'chat-message-debug';

                    const title = document.createElement('div');
                    title.className = 'chat-message-debug-title';
                    title.textContent = `Memories Used (${debug.memories_used.length})`;
                    debugDiv.appendChild(title);

                    debug.memories_used.slice(0, 3).forEach(m => {
                        const item = document.createElement('div');
                        item.className = 'chat-message-debug-item';
                        item.textContent = `â€¢ ${m.content || JSON.stringify(m).slice(0, 100)}`;
                        debugDiv.appendChild(item);
                    });

                    contentDiv.appendChild(debugDiv);
                }
            }

            // Assemble structure
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);

            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ============================================
        // HEADER STATS UPDATE
        // ============================================

        async function updateHeaderStats() {
            try {
                const [dbStats, memStats] = await Promise.all([
                    fetch('/api/v1/demo/database/stats').then(r => r.json()),
                    fetch('/api/v1/demo/memories/stats').then(r => r.json())
                ]);

                const totalDb = Object.values(dbStats).reduce((sum, val) => sum + val, 0);
                const totalMem = Object.values(memStats).reduce((sum, val) => sum + val, 0);

                document.getElementById('totalDbRecords').textContent = totalDb;
                document.getElementById('totalMemories').textContent = totalMem;

                databaseStatsData = dbStats;
                memoryStatsData = memStats;

                // Update architecture diagram counts
                updateArchitectureCounts();

                if (currentTab === 'database') {
                    renderDatabaseStats();
                } else if (currentTab === 'memory') {
                    renderMemoryStats();
                    loadMemoryLayers();
                }
            } catch (error) {
                console.error('Failed to update header stats:', error);
            }
        }

        // ============================================
        // ALERTS
        // ============================================

        function showGlobalSuccess(message) {
            const alert = document.getElementById('globalAlert');
            if (!alert) {
                console.warn('globalAlert element not found');
                return;
            }
            alert.innerHTML = `<div class="alert alert-success">${message}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 5000);
        }

        function showGlobalError(title, message) {
            const alert = document.getElementById('globalAlert');
            if (!alert) {
                console.warn('globalAlert element not found');
                return;
            }
            alert.innerHTML = `<div class="alert alert-error"><strong>${title}:</strong> ${message}</div>`;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            await loadScenarios();
            await updateHeaderStats();
            startActivityPolling();
        }

        init();
    </script>
</body>
</html>
